<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>çŒœç›</title>
    <link rel="icon" href="icons/icon-128x128.png" type="image/png">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#fefbff">

    <style>
        *, *::before, *::after {
            box-sizing: border-box;
        }

        :root {
            /* M3 Shape Tokens */
            --md-sys-shape-corner-none: 0px;
            --md-sys-shape-corner-xs: 4px;
            --md-sys-shape-corner-s: 8px;
            --md-sys-shape-corner-m: 12px;
            --md-sys-shape-corner-l: 16px;
            --md-sys-shape-corner-xl: 28px;
            --md-sys-shape-corner-full: 100px;

            /* M3 Elevation Tokens (Light) */
            --md-sys-elevation-level-0: none;
            --md-sys-elevation-level-1: 0px 1px 3px 1px rgba(0,0,0,0.15), 0px 1px 2px 0px rgba(0,0,0,0.3);
            --md-sys-elevation-level-2: 0px 2px 6px 2px rgba(0,0,0,0.15), 0px 1px 2px 0px rgba(0,0,0,0.3);
            --md-sys-elevation-level-3: 0px 4px 8px 3px rgba(0,0,0,0.15), 0px 1px 3px 0px rgba(0,0,0,0.3);

            /* Animation Curves */
            --md-animation-standard: cubic-bezier(0.2, 0, 0, 1);
            --md-animation-emphasized: cubic-bezier(0.3, 0, 0, 1);
            
            /* Enhanced System Font Stack */
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI Variable", "Segoe UI", "MiSans", "HarmonyOS Sans", "OPlusSans", "Vivosans", Roboto, "Noto Sans", "Helvetica Neue", Arial, sans-serif;

            /* M3 Light Theme Colors */
            --md-sys-color-primary-rgb: 74, 100, 234;
            --md-sys-color-primary: #4a64ea;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #e0e0ff;
            --md-sys-color-on-primary-container: #001869;
            --md-sys-color-secondary-container: #e2e0f9;
            --md-sys-color-on-secondary-container-rgb: 26, 26, 46;
            --md-sys-color-on-secondary-container: #1a1a2e;
            --md-sys-color-tertiary: #78536b;
            --md-sys-color-on-tertiary: #ffffff;
            --md-sys-color-surface: #fdf8fd;
            --md-sys-color-surface-container: #f3edf7;
            --md-sys-color-surface-container-high: #eeebf1;
            --md-sys-color-surface-container-highest: #e8e5ea;
            --md-sys-color-on-surface-rgb: 28, 27, 31;
            --md-sys-color-on-surface: #1c1b1f;
            --md-sys-color-on-surface-variant: #48454e;
            --md-sys-color-outline: #79757f;
            --md-sys-color-outline-variant: #c9c5d0;
            --md-sys-color-error: #ba1a1a;
            --md-sys-color-on-error: #ffffff;
            --md-sys-color-error-container: #ffdad6;
            --md-sys-color-on-error-container: #410002;
            --md-sys-color-success: #376a20;
            --md-sys-color-shadow: #000000;
            
            /* Component Mappings */
            --sidebar-bg: var(--md-sys-color-surface-container);
            --main-bg: var(--md-sys-color-surface);
            --chat-window-bg: var(--md-sys-color-surface);
            --text-primary: var(--md-sys-color-on-surface);
            --text-secondary: var(--md-sys-color-on-surface-variant);
            --sidebar-text: var(--md-sys-color-on-surface-variant);
            --sidebar-group-text: var(--md-sys-color-on-surface-variant);
            --border-color: var(--md-sys-color-outline-variant);
            --new-chat-btn-bg: var(--md-sys-color-primary-container);
            --new-chat-btn-text: var(--md-sys-color-on-primary-container);
            --new-chat-btn-hover-bg: color-mix(in srgb, var(--md-sys-color-primary-container), var(--md-sys-color-on-primary-container) 8%);
            --history-item-hover-bg: rgba(var(--md-sys-color-on-surface-rgb), 0.08);
            --history-item-active-bg: var(--md-sys-color-secondary-container);
            --history-item-active-text: var(--md-sys-color-on-secondary-container);
            --user-msg-bg: var(--md-sys-color-primary);
            --user-msg-text: var(--md-sys-color-on-primary);
            --ai-msg-bg: var(--md-sys-color-surface-container-high);
            --ai-msg-text: var(--md-sys-color-on-surface);
            --accent-color: var(--md-sys-color-primary);
            --error-color: var(--md-sys-color-error);
            --success-color: var(--md-sys-color-success);
            --context-menu-bg: var(--md-sys-color-surface-container-high);
            --context-menu-shadow: var(--md-sys-elevation-level-2);
            --context-menu-hover-bg: rgba(var(--md-sys-color-on-surface-rgb), 0.08);
            --modal-overlay-bg: rgba(0, 0, 0, 0.4); 
            --modal-bg: var(--md-sys-color-surface-container-highest);
            --modal-cancel-btn-bg: transparent;
            --modal-confirm-btn-text: var(--md-sys-color-on-primary);
            --modal-cancel-btn-text: var(--md-sys-color-primary);
            --modal-error-bg: var(--md-sys-color-error-container);
            --modal-error-text: var(--md-sys-color-on-error-container);
            --modal-error-btn-bg: var(--md-sys-color-error);
            --modal-error-btn-text: var(--md-sys-color-on-error);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                /* M3 Elevation Tokens (Dark) */
                --md-sys-elevation-level-1: 0px 1px 3px 1px rgba(0,0,0,0.4), 0px 1px 2px 0px rgba(0,0,0,0.5);
                --md-sys-elevation-level-2: 0px 2px 6px 2px rgba(0,0,0,0.4), 0px 1px 2px 0px rgba(0,0,0,0.5);
                --md-sys-elevation-level-3: 0px 4px 8px 3px rgba(0,0,0,0.4), 0px 1px 3px 0px rgba(0,0,0,0.5);

                /* M3 Dark Theme Colors */
                --md-sys-color-primary-rgb: 189, 194, 255;
                --md-sys-color-primary: #bdc2ff;
                --md-sys-color-on-primary: #1932b5;
                --md-sys-color-primary-container: #324bbd;
                --md-sys-color-on-primary-container: #e0e0ff;
                --md-sys-color-secondary-container: #454459;
                --md-sys-color-on-secondary-container-rgb: 226, 224, 249;
                --md-sys-color-on-secondary-container: #e2e0f9;
                --md-sys-color-tertiary: #e7b9d5;
                --md-sys-color-on-tertiary: #46263b;
                --md-sys-color-surface: #141318;
                --md-sys-color-surface-container: #201f24;
                --md-sys-color-surface-container-high: #2b292f;
                --md-sys-color-surface-container-highest: #36343a;
                --md-sys-color-on-surface-rgb: 229, 225, 230;
                --md-sys-color-on-surface: #e5e1e6;
                --md-sys-color-on-surface-variant: #c9c5d0;
                --md-sys-color-outline: #949099;
                --md-sys-color-outline-variant: #48454e;
                --md-sys-color-error: #ffb4ab;
                --md-sys-color-on-error: #690005;
                --md-sys-color-error-container: #93000a;
                --md-sys-color-on-error-container: #ffdad6;
                --md-sys-color-success: #a0d38c;
            }
            * { scrollbar-width: thin; scrollbar-color: var(--md-sys-color-surface-container-highest) var(--md-sys-color-surface); }
            ::-webkit-scrollbar { width: 8px; height: 8px; } ::-webkit-scrollbar-track { background: var(--md-sys-color-surface); } ::-webkit-scrollbar-thumb { background-color: var(--md-sys-color-surface-container-highest); border-radius: 4px; border: 2px solid var(--md-sys-color-surface); } ::-webkit-scrollbar-thumb:hover { background-color: var(--md-sys-color-on-surface-variant); }
        }

        html, body { position: relative; height: 100%; width: 100%; overflow: hidden; overscroll-behavior: none; }
        body { font-family: var(--font-family); background-color: var(--sidebar-bg); margin: 0; color: var(--text-primary); display: flex; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        #app-wrapper { display: flex; width: 100%; height: 100%; }
        #sidebar { background-color: var(--sidebar-bg); color: var(--sidebar-text); width: 260px; display: flex; flex-direction: column; flex-shrink: 0; transition: width 0.3s var(--md-animation-standard); padding: 12px; }
        .sidebar-header { padding-bottom: 12px; display: flex; align-items: center; transition: flex-direction 0.3s var(--md-animation-standard); }
        #new-chat-button { flex-grow: 1; height: 56px; padding: 0 24px; border: none; background-color: var(--new-chat-btn-bg); color: var(--new-chat-btn-text); border-radius: var(--md-sys-shape-corner-l); cursor: pointer; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9em; font-weight: 600; display: flex; align-items: center; transition: background-color 0.2s var(--md-animation-standard); }
        #new-chat-button:hover { background-color: var(--new-chat-btn-hover-bg); }
        #new-chat-button .icon { font-size: 1.8em; margin-right: 16px; font-weight: 400; }
        #sidebar-toggle-button { margin-left: 10px; padding: 0; width: 40px; height: 40px; border: none; background-color: transparent; color: var(--text-secondary); border-radius: 50%; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all 0.2s var(--md-animation-standard); font-size: 1.5em; }
        #sidebar-toggle-button:hover { background-color: var(--history-item-hover-bg); }
        #history-list-container { list-style: none; margin: 0; padding: 0 4px; overflow-y: auto; flex-grow: 1; }
        .history-group-header { font-size: 0.8em; color: var(--sidebar-group-text); padding: 16px 16px 4px; font-weight: 500; }
        .history-item { display: flex; align-items: center; height: 48px; padding: 0 16px; border-radius: var(--md-sys-shape-corner-full); cursor: pointer; margin-bottom: 2px; font-size: 0.9em; color: var(--sidebar-text); transition: background-color 0.2s var(--md-animation-standard), color 0.2s var(--md-animation-standard); -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none; }
        .history-item > span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0; 
        }
        .history-item:hover { background-color: var(--history-item-hover-bg); }
        .history-item.active { background-color: var(--history-item-active-bg); color: var(--history-item-active-text); font-weight: 600; }
        #app-wrapper.sidebar-collapsed #sidebar { width: 80px; padding: 12px 16px; }
        #app-wrapper.sidebar-collapsed .sidebar-header { flex-direction: column-reverse; align-items: center; gap: 16px; }
        #app-wrapper.sidebar-collapsed #new-chat-button { flex-grow: 0; justify-content: center; width: 48px; height: 48px; padding: 0; border-radius: var(--md-sys-shape-corner-l); }
        #app-wrapper.sidebar-collapsed #new-chat-button span:not(.icon) { display: none; }
        #app-wrapper.sidebar-collapsed #new-chat-button .icon { margin: 0; font-size: 1.8em; }
        #app-wrapper.sidebar-collapsed #sidebar-toggle-button { margin: 0; }
        #app-wrapper.sidebar-collapsed #history-list-container { display: none; }
        
        #context-menu { position: absolute; z-index: 1000; background-color: var(--context-menu-bg); border-radius: var(--md-sys-shape-corner-m); padding: 8px; box-shadow: var(--context-menu-shadow); min-width: 200px; opacity: 0; visibility: hidden; transform-origin: top left; transform: scale(0.95) translateY(-8px); transition: opacity 0.15s var(--md-animation-emphasized), transform 0.15s var(--md-animation-emphasized), visibility 0.15s; }
        #context-menu.show { opacity: 1; visibility: visible; transform: scale(1) translateY(0); }
        .context-menu-item { display: flex; align-items: center; padding: 12px 16px; border-radius: var(--md-sys-shape-corner-s); cursor: pointer; color: var(--text-primary); transition: background-color 0.2s var(--md-animation-standard); font-size: 1em; }
        .context-menu-item:hover { background-color: var(--context-menu-hover-bg); }
        .context-menu-item.delete { color: var(--error-color); }
        .context-menu-icon { margin-right: 16px; width: 20px; height: 20px; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-overlay-bg); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.2s var(--md-animation-standard), visibility 0.2s; backdrop-filter: blur(2px); -webkit-backdrop-filter: blur(2px); }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-dialog { background-color: var(--modal-bg); padding: 24px; border-radius: var(--md-sys-shape-corner-xl); box-shadow: var(--context-menu-shadow); width: 90%; max-width: 400px; transform: scale(0.95); transition: transform 0.2s var(--md-animation-standard); }
        .modal-overlay.show .modal-dialog { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .modal-header h2 { margin: 0; font-size: 1.5em; font-weight: 500; color: var(--text-primary); }
        .modal-header .close-btn { background: none; border: none; font-size: 1.8em; color: var(--text-secondary); cursor: pointer; padding: 0; line-height: 1; opacity: 0.7; }
        .modal-body p { margin: 0 0 24px 0; color: var(--text-secondary); font-size: 1em; line-height: 1.5; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 8px; }
        .modal-footer button { padding: 10px 24px; border-radius: var(--md-sys-shape-corner-full); border: none; cursor: pointer; font-weight: 600; font-size: 0.9em; transition: opacity 0.2s var(--md-animation-standard), background-color 0.2s var(--md-animation-standard); }
        .modal-footer button:hover:not(:disabled) { opacity: 0.9; }
        .modal-footer .cancel-btn { background-color: var(--modal-cancel-btn-bg); color: var(--modal-cancel-btn-text); }
        .modal-footer .cancel-btn:hover { background-color: rgba(var(--md-sys-color-primary-rgb), 0.08); }
        .modal-footer .confirm-btn { background-color: var(--accent-color); color: var(--modal-confirm-btn-text); }
        #confirm-modal.is-delete .modal-footer .confirm-btn { background-color: var(--md-sys-color-error); color: var(--md-sys-color-on-error); }
        
        #error-modal .modal-dialog, #browser-warning-modal .modal-dialog { background-color: var(--modal-error-bg); color: var(--modal-error-text); }
        #error-modal .modal-dialog h2, #browser-warning-modal .modal-dialog h2, #error-modal .modal-dialog p, #browser-warning-modal .modal-dialog p { color: var(--modal-error-text); }
        .modal-footer .confirm-btn.error { background-color: var(--modal-error-btn-bg); color: var(--modal-error-btn-text); }

        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .checkbox-wrapper { margin-top: 20px; }
        .checkbox-container { display: flex; align-items: center; cursor: pointer; user-select: none; font-size: 15px; color: var(--text-secondary); }
        .checkbox-visual { width: 18px; height: 18px; border: 2px solid var(--md-sys-color-on-error-container); border-radius: var(--md-sys-shape-corner-xs); margin-right: 12px; display: flex; justify-content: center; align-items: center; background-color: transparent; transition: background-color 0.2s var(--md-animation-standard), border-color 0.2s var(--md-animation-standard); }
        .checkbox-visual svg { width: 14px; height: 14px; stroke: var(--md-sys-color-on-error); stroke-width: 2.5; fill: none; stroke-linecap: round; stroke-linejoin: round; transform: scale(0); opacity: 0; transition: transform 0.3s var(--md-animation-emphasized), opacity 0.2s var(--md-animation-standard); }
        .visually-hidden:checked + .checkbox-container .checkbox-visual { background-color: var(--md-sys-color-error); border-color: var(--md-sys-color-error); }
        .visually-hidden:checked + .checkbox-container .checkbox-visual svg { transform: scale(1); opacity: 1; }
        .visually-hidden:focus-visible + .checkbox-container .checkbox-visual { box-shadow: 0 0 0 3px rgba(var(--md-sys-color-primary-rgb), 0.4); }
        #browser-warning-modal .checkbox-container { color: var(--modal-error-text); }
        
        #game-container { flex-grow: 1; background-color: var(--main-bg); display: flex; flex-direction: column; overflow: hidden; height: 100%; border-radius: var(--md-sys-shape-corner-l) 0 0 var(--md-sys-shape-corner-l); }
        #chat-window, header, #input-area { transition: background-color 0.2s var(--md-animation-standard), border-color 0.2s var(--md-animation-standard); }

        header { 
            padding: 12px 20px; 
            border-bottom: 1px solid var(--border-color); 
            background-color: var(--main-bg); 
            flex-shrink: 0; 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            position: relative; 
            height: 64px; 
        }
        #mobile-menu-toggle { 
            display: none;
            background: none; 
            border: none; 
            font-size: 1.5em; 
            cursor: pointer; 
            color: var(--text-secondary); 
        }
        .title-container { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            position: relative;
        }
        .title-container h1 { margin: 0; font-size: 1.4em; font-weight: 500; color: var(--text-primary); }
        .header-actions { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }

        .header-action-btn { padding: 0; width: 40px; height: 40px; border: none; background-color: transparent; color: var(--text-secondary); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s var(--md-animation-standard); }
        .header-action-btn:hover { background-color: var(--history-item-hover-bg); }
        .header-action-btn svg { width: 24px; height: 24px; fill: currentColor; }
        
        .date-picker-trigger { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 6px 16px; background-color: transparent; border: 1px solid var(--md-sys-color-outline); border-radius: var(--md-sys-shape-corner-full); font-size: 0.9em; font-weight: 600; color: var(--md-sys-color-on-surface-variant); cursor: pointer; transition: all 0.2s var(--md-animation-standard); }
        .date-picker-trigger:hover { background-color: var(--history-item-hover-bg); }
        .date-picker-trigger svg { width: 20px; height: 20px; fill: currentColor; flex-shrink: 0; }
        
        #chat-window { flex: 1; padding: 20px; overflow-y: auto; background-color: var(--chat-window-bg); scroll-behavior: smooth; -webkit-overflow-scrolling: touch; min-height: 0; display: flex; flex-direction: column; gap: 12px; }
        .message { display: flex; max-width: 85%; align-self: flex-start; animation: fadeIn 0.5s var(--md-animation-standard); }
        .message-bubble { padding: 12px 18px; border-radius: var(--md-sys-shape-corner-l); word-wrap: break-word; line-height: 1.5; font-size: 1em; }
        .ai-message .message-bubble { background-color: var(--ai-msg-bg); color: var(--ai-msg-text); border-bottom-left-radius: var(--md-sys-shape-corner-xs); }
        .user-message { align-self: flex-end; } .user-message .message-bubble { background-color: var(--user-msg-bg); color: var(--user-msg-text); border-bottom-right-radius: var(--md-sys-shape-corner-xs); }
        .system-message { text-align: center; margin: 15px 0; font-size: 0.9em; color: var(--text-secondary); align-self: center; }
        .system-message.success { color: var(--success-color); font-weight: bold; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #input-area { display: flex; padding: 12px 16px; border-top: 1px solid var(--border-color); background-color: var(--main-bg); flex-shrink: 0; align-items: center; gap: 12px; }
        #user-input { flex-grow: 1; border: 1px solid var(--md-sys-color-outline); border-radius: var(--md-sys-shape-corner-full); padding: 14px 20px; font-size: 16px; outline: none; transition: border-color 0.3s var(--md-animation-standard), box-shadow 0.3s var(--md-animation-standard); background-color: transparent; color: var(--text-primary); height: 52px; }
        #user-input::placeholder { color: var(--text-secondary); }
        #user-input:focus { border-color: var(--accent-color); box-shadow: 0 0 0 1px var(--accent-color); }
        #user-input:disabled { background-color: var(--ai-msg-bg); cursor: not-allowed; opacity: 0.7; }
        #send-button { width: 52px; height: 52px; border: none; background-color: var(--accent-color); color: var(--md-sys-color-on-primary); border-radius: 50%; cursor: pointer; transition: background-color 0.3s var(--md-animation-standard), opacity 0.3s var(--md-animation-standard), transform 0.2s var(--md-animation-emphasized); flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        #send-button svg { width: 24px; height: 24px; fill: currentColor; }
        #send-button:hover:not(:disabled) { box-shadow: var(--md-sys-elevation-level-1); }
        #send-button:active:not(:disabled) { transform: scale(0.95); }
        #send-button:disabled { background-color: var(--accent-color); opacity: 0.4; cursor: not-allowed; }
        #sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 999; }
        .custom-select-wrapper { position: relative; display: inline-block; user-select: none; }
        .select-selected { color: var(--text-primary); font-size: 1.4em; font-weight: 500; cursor: pointer; display: flex; align-items: center; padding: 4px 8px; border-radius: var(--md-sys-shape-corner-m); transition: background-color 0.2s var(--md-animation-standard); }
        .select-selected:hover { background-color: var(--ai-msg-bg); }
        .select-arrow { margin-left: 6px; width: 24px; height: 24px; fill: currentColor; transition: transform 0.3s var(--md-animation-emphasized); }
        .select-selected.select-arrow-active .select-arrow { transform: rotate(180deg); }
        .select-items { list-style: none; padding: 8px; margin: 0; position: absolute; top: calc(100% + 5px); left: 50%; transform: translateX(-50%); background-color: var(--context-menu-bg); border-radius: var(--md-sys-shape-corner-m); box-shadow: var(--context-menu-shadow); min-width: 120px; text-align: center; z-index: 1101; opacity: 0; visibility: hidden; transition: opacity 0.1s var(--md-animation-standard), transform 0.1s var(--md-animation-standard), visibility 0.1s; }
        .select-items.show { opacity: 1; visibility: visible; }
        .select-item { color: var(--text-primary); padding: 12px 16px; border-radius: var(--md-sys-shape-corner-s); cursor: pointer; transition: background-color 0.2s var(--md-animation-standard); font-size: 1.1em; }
        .select-item:hover { background-color: var(--context-menu-hover-bg); }

        /* --- Date Picker --- */
        #date-picker-popover { position: absolute; top: calc(100% + 10px); right: 0; transform: scale(0.95); z-index: 1100; background-color: var(--md-sys-color-surface-container-high); border-radius: var(--md-sys-shape-corner-xl); padding: 12px 16px 16px; box-shadow: var(--md-sys-elevation-level-3); width: 340px; user-select: none; opacity: 0; visibility: hidden; transform-origin: top right; transition: opacity 0.2s var(--md-animation-emphasized), transform 0.2s var(--md-animation-emphasized), visibility 0.2s; }
        #date-picker-popover.show { opacity: 1; visibility: visible; transform: scale(1); }
        .dp-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 4px 0; }
        .dp-month-year { font-weight: 600; font-size: 1.1em; color: var(--text-primary); line-height: 1.2; }
        .dp-nav-btn { display:flex; align-items:center; justify-content:center; background: none; border: none; width: 40px; height: 40px; cursor: pointer; color: var(--text-primary); font-size: 1.2em; border-radius: 50%; transition: background-color 0.2s var(--md-animation-standard), opacity 0.2s var(--md-animation-standard); touch-action: manipulation; }
        .dp-nav-btn:hover:not(:disabled) { background-color: var(--history-item-hover-bg); }
        .dp-nav-btn.disabled { opacity: 0.4; pointer-events: none; cursor: not-allowed; }
        #dp-weekdays-container { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; padding-bottom: 8px; justify-items: center; }
        .dp-weekday { text-align: center; font-size: 0.85em; color: var(--text-secondary); font-weight: 500; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; line-height: 1; }
        .dp-grid-wrapper { position: relative; overflow: hidden; height: 264px; }
        .dp-grid-container { position: absolute; top: 0; left: 0; width: 100%; display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; justify-items: center; }
        .dp-day { display: flex; justify-content: center; align-items: center; width: 40px; height: 40px; border-radius: 50%; font-size: 0.9em; border: 2px solid transparent; color: var(--text-primary); transition: background-color 0.2s var(--md-animation-standard), color 0.2s var(--md-animation-standard), border-color 0.2s var(--md-animation-standard); }
        .dp-day.other-month { color: var(--text-secondary); }
        .dp-day.disabled { pointer-events: none; color: var(--md-sys-color-outline); }
        .dp-day.available { cursor: pointer; }
        .dp-day.available:hover { background-color: var(--history-item-hover-bg); }
        .dp-day.today { border-color: var(--md-sys-color-outline); }
        .dp-day.selected, .dp-day.available.selected:hover { background-color: var(--accent-color); color: var(--md-sys-color-on-primary) !important; border-color: var(--accent-color); font-weight: bold; }
        
        @media (max-width: 768px) {
            #sidebar { position: fixed; top: 0; left: -260px; height: 100%; z-index: 1000; transition: left 0.3s var(--md-animation-standard); border-right: none; }
            body.sidebar-open #sidebar { left: 0; }
            body.sidebar-open #sidebar-overlay { display: block; }
            #sidebar-toggle-button { display: none; }
            
            #mobile-menu-toggle { display: block; }

            #game-container { border-radius: 0; }
            #app-wrapper.sidebar-collapsed #sidebar { width: 260px; padding: 12px; }
            #app-wrapper.sidebar-collapsed .sidebar-header { flex-direction: row; align-items: center; gap: 0; }
            #app-wrapper.sidebar-collapsed #new-chat-button { width: auto; height: 56px; padding: 0 24px; flex-grow: 1; border-radius: var(--md-sys-shape-corner-l); }
            #app-wrapper.sidebar-collapsed #new-chat-button span:not(.icon) { display: inline-block; }
            #app-wrapper.sidebar-collapsed #new-chat-button .icon { margin-right: 16px; }
            #app-wrapper.sidebar-collapsed #sidebar-toggle-button { display: none; }
            #app-wrapper.sidebar-collapsed #history-list-container { display: block; }
            header { padding-top: calc(10px + env(safe-area-inset-top)); }
            #input-area { padding-bottom: calc(10px + env(safe-area-inset-bottom)); }

            .date-picker-trigger {
                padding: 0;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                border-width: 1px;
            }
            .date-picker-trigger #daily-puzzle-label {
                display: none;
            }
            .date-picker-trigger svg {
                margin: 0;
            }

            #date-picker-popover { 
                left: auto;
                right: 15px;
                transform: scale(0.95); 
                transform-origin: top right;
                width: calc(100vw - 30px); 
                max-width: 340px; 
            }
            #date-picker-popover.show { 
                transform: scale(1);
            }
        }
    </style>
</head>
<body>
    <!-- ä¸»åº”ç”¨ç•Œé¢ -->
    <div id="app-wrapper">
        <aside id="sidebar">
            <div class="sidebar-header">
                <button id="new-chat-button"><span class="icon">ï¼‹</span><span>å¼€å¯æ–°å¯¹è¯</span></button>
                <button id="sidebar-toggle-button" title="æ”¶èµ·/å±•å¼€ä¾§è¾¹æ ">â€¹</button>
            </div>
            <div id="history-list-container"></div>
        </aside>
        <div id="sidebar-overlay"></div>
        <main id="game-container">
            <header>
                <button id="mobile-menu-toggle">â˜°</button>
                <div class="title-container">
                    <h1>çŒœç› - </h1>
                    <div id="game-mode-dropdown" class="custom-select-wrapper"></div>
                </div>
                <div class="header-actions">
                    <button id="daily-puzzle-button" class="date-picker-trigger" title="é€‰æ‹©å¾€æ—¥è°œé¢˜" style="display: none;">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg "><path d="M21 8.5v9.25A3.25 3.25 0 0 1 17.75 21H6.25A3.25 3.25 0 0 1 3 17.75V8.5h18ZM7.25 15a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5ZM12 15a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5Zm-4.75-4.5a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5Zm4.75 0a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5Zm4.75 0a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5Zm1-7.5A3.25 3.25 0 0 1 21 6.25V7H3v-.75A3.25 3.25 0 0 1 6.25 3h11.5Z" fill="currentColor"/></svg>
                        <span id="daily-puzzle-label">é€‰æ‹©æ—¥æœŸ</span>
                    </button>
                    <div id="date-picker-popover">
                        <div class="dp-header">
                            <button id="dp-prev-month" class="dp-nav-btn" title="ä¸Šä¸ªæœˆ">&lt;</button>
                            <div id="dp-month-year" class="dp-month-year"></div>
                            <button id="dp-next-month" class="dp-nav-btn" title="ä¸‹ä¸ªæœˆ">&gt;</button>
                        </div>
                        <div id="dp-weekdays-container"></div>
                        <div class="dp-grid-wrapper"></div>
                    </div>
                    <button id="export-button" class="header-action-btn" title="å¯¼å‡ºå†å²è®°å½•">
                        <svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg "><path d="M6.25 4.75a1.5 1.5 0 0 0-1.5 1.5v11.5a1.5 1.5 0 0 0 1.5 1.5h11.5a1.5 1.5 0 0 0 1.5-1.5v-4a1 1 0 1 1 2 0v4a3.5 3.5 0 0 1-3.5 3.5H6.25a3.5 3.5 0 0 1-3.5-3.5V6.25a3.5 3.5 0 0 1 3.5-3.5h4a1 1 0 1 1 0 2h-4Zm6.5-1a1 1 0 0 1 1-1h6.5a1 1 0 0 1 1 1v6.5a1 1 0 1 1-2 0V6.164l-4.793 4.793a1 1 0 1 1-1.414-1.414l4.793-4.793H13.75a1 1 0 0 1-1-1Z"/></svg>
                    </button>
                    <button id="import-button" class="header-action-btn" title="å¯¼å…¥å†å²è®°å½•">
                        <svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg "><path d="M21.25 4.5a.75.75 0 0 1 .743.648L22 5.25v13.5a.75.75 0 0 1-1.493.102l-.007-.102V5.25a.75.75 0 0 1 .75-.75Zm-9.04 1.887.083-.094a1 1 0 0 1 1.32-.083l.094.083 4.997 4.998a1 1 0 0 1 .083 1.32l-.083.093-4.996 5.004a1 1 0 0 1-1.499-1.32l.083-.094L15.581 13H3a1 1 0 0 1-.993-.883L2 12a1 1 0 0 1 .883-.993L3 11h12.584l-3.291-3.293a1 1 0 0 1-.083-1.32l.083-.094-.083.094Z"/></svg>
                    </button>
                </div>
            </header>
            <div id="chat-window"></div>
            <div id="input-area">
                <input type="text" id="user-input" placeholder="è¯·è¾“å…¥ä½ çš„æé—®æˆ–è¯Šæ–­..." disabled>
                <button id="send-button" disabled title="å‘é€">
                    <svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg "><path d="m12.815 12.197-7.532 1.256a.5.5 0 0 0-.386.318L2.3 20.728c-.248.64.421 1.25 1.035.943l18-9a.75.75 0 0 0 0-1.342l-18-9c-.614-.307-1.283.304-1.035.943l2.598 6.957a.5.5 0 0 0 .386.319l7.532 1.255a.2.2 0 0 1 0 .394Z"/></svg>
                </button>
            </div>
        </main>
    </div>

    <input type="file" id="import-file-input" accept=".json" style="display: none;">

    <div id="context-menu">
        <div class="context-menu-item" id="rename-option"><svg class="context-menu-icon" xmlns="http://www.w3.org/2000/svg " viewBox="0 0 20 20" fill="currentColor"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25-1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg><span>é‡å‘½å</span></div>
        <div class="context-menu-item delete" id="delete-option"><svg class="context-menu-icon" xmlns="http://www.w3.org/2000/svg " viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.58.22-2.365.468a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193v-.443A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25-.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" /></svg><span>åˆ é™¤</span></div>
    </div>
    
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal-dialog"><div class="modal-header"><h2 id="confirm-modal-title">æ°¸ä¹…åˆ é™¤å¯¹è¯</h2><button class="close-btn" id="confirm-modal-close-btn">Ã—</button></div><div class="modal-body"><p id="confirm-modal-message">åˆ é™¤åï¼Œè¯¥å¯¹è¯å°†ä¸å¯æ¢å¤ã€‚ç¡®è®¤åˆ é™¤å—ï¼Ÿ</p></div><div class="modal-footer"><button class="cancel-btn" id="confirm-modal-cancel-btn">å–æ¶ˆ</button><button class="confirm-btn" id="confirm-modal-confirm-btn">åˆ é™¤</button></div></div>
    </div>

    <div class="modal-overlay" id="info-modal">
        <div class="modal-dialog"><div class="modal-header"><h2 id="info-modal-title">æç¤º</h2><button class="close-btn" id="info-modal-close-btn">Ã—</button></div><div class="modal-body"><p id="info-modal-message"></p></div><div class="modal-footer"><button class="confirm-btn import" id="info-modal-ok-btn">å¥½çš„</button></div></div>
    </div>

    <div class="modal-overlay" id="error-modal">
        <div class="modal-dialog"><div class="modal-header"><h2 id="error-modal-title">é”™è¯¯</h2><button class="close-btn" id="error-modal-close-btn">Ã—</button></div><div class="modal-body"><p id="error-modal-message"></p></div><div class="modal-footer"><button class="confirm-btn error" id="error-modal-ok-btn">å¥½çš„</button></div></div>
    </div>
    
    <div class="modal-overlay" id="browser-warning-modal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h2 id="browser-warning-title">æµè§ˆå™¨å…¼å®¹æ€§æç¤º</h2>
                <button class="close-btn" id="browser-warning-close-btn">Ã—</button>
            </div>
            <div class="modal-body">
                <p id="browser-warning-message"></p>
                <div class="checkbox-wrapper">
                    <input class="visually-hidden" type="checkbox" id="dont-show-again-checkbox">
                    <label class="checkbox-container" for="dont-show-again-checkbox">
                        <span class="checkbox-visual">
                            <svg viewBox="0 0 20 20">
                                <path d="M4 10 L8 14 L16 6"></path>
                            </svg>
                        </span>
                        <span>ä¸å†æ˜¾ç¤ºæ­¤è­¦å‘Š</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="confirm-btn error" id="browser-warning-ok-btn">å¥½çš„</button>
            </div>
        </div>
    </div>

    <!-- ä¸ºæ—§ç‰ˆæµè§ˆå™¨å‡†å¤‡çš„é™æ€åå¤‡é¡µé¢ (é»˜è®¤éšè—) -->
    <div id="unsupported-browser-message" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; background-color: #f4f5f7; font-family: 'Helvetica Neue', Helvetica, Arial, 'Microsoft Yahei', sans-serif; overflow-y: auto;">
        <div style="width: 90%; max-width: 560px; margin: 80px auto; background-color: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 32px; box-sizing: border-box; text-align: center;">
            <div style="width: 64px; height: 64px; margin: 0 auto 20px auto; background-color: #fce8e6; border-radius: 50%;">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 8.25V12M12 15.75H12.01M21.75 12C21.75 17.3848 17.3848 21.75 12 21.75C6.61522 21.75 2.25 17.3848 2.25 12C2.25 6.61522 6.61522 2.25 12 2.25C17.3848 2.25 21.75 6.61522 21.75 12Z" stroke="#d93025" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <h2 style="font-size: 26px; color: #202124; margin: 0 0 12px 0; font-weight: 500;">æ‚¨çš„æµè§ˆå™¨ç‰ˆæœ¬éœ€è¦æ›´æ–°</h2>
            <p style="font-size: 16px; line-height: 1.7; color: #5f6368; margin: 0 0 30px 0;">
                å½“å‰æµè§ˆå™¨è¿‡æ—§ï¼Œæ— æ³•æ­£å¸¸è¿è¡Œæ­¤åº”ç”¨ã€‚æˆ‘ä»¬å»ºè®®æ‚¨å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬çš„ç°ä»£æµè§ˆå™¨ï¼Œä»¥äº«å—æ›´å¿«çš„é€Ÿåº¦ã€æ›´ä½³çš„è§†è§‰ä½“éªŒå’Œæ›´é«˜çš„å®‰å…¨æ€§ã€‚
            </p>
            <div style="font-size: 0;">
                <a href="https://www.google.cn/chrome/index.html" target="_blank" rel="noopener noreferrer" style="display: inline-block; text-decoration: none; font-size: 15px; font-weight: 500; color: #ffffff; background-color: #1a73e8; padding: 12px 24px; border-radius: 4px; margin: 8px;">
                    ä¸‹è½½ Chrome
                </a>
                <a href="https://www.microsoft.com/edge/download" target="_blank" rel="noopener noreferrer" style="display: inline-block; text-decoration: none; font-size: 15px; font-weight: 500; color: #ffffff; background-color: #0078d4; padding: 12px 24px; border-radius: 4px; margin: 8px;">
                    ä¸‹è½½ Edge
                </a>
                <a href="https://www.mozilla.org/firefox/new/" target="_blank" rel="noopener noreferrer" style="display: inline-block; text-decoration: none; font-size: 15px; font-weight: 500; color: #202124; background-color: #f1f3f4; padding: 12px 24px; border-radius: 4px; border: 1px solid #dadce0; margin: 8px;">
                    ä¸‹è½½ Firefox
                </a>
            </div>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨è„šæœ¬ï¼ŒåŒ…è£¹åœ¨æ¨¡æ¿ä¸­ä»¥é˜²æ­¢æ—§æµè§ˆå™¨è§£æå´©æºƒ -->
    <script type="text/template" id="main-app-script">
        (function() {
            // --- DOM Elements ---
            const appWrapper = document.getElementById('app-wrapper');
            const sidebar = document.getElementById('sidebar');
            const sidebarToggleButton = document.getElementById('sidebar-toggle-button');
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const newChatButton = document.getElementById('new-chat-button');
            const historyListContainer = document.getElementById('history-list-container');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const gameModeDropdown = document.getElementById('game-mode-dropdown');
            const chatWindow = document.getElementById('chat-window');
            const userInput = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            const contextMenu = document.getElementById('context-menu');
            const renameOption = document.getElementById('rename-option');
            const deleteOption = document.getElementById('delete-option');
            const exportButton = document.getElementById('export-button');
            const importButton = document.getElementById('import-button');
            const importFileInput = document.getElementById('import-file-input');
            const dailyPuzzleButton = document.getElementById('daily-puzzle-button');
            const datePickerPopover = document.getElementById('date-picker-popover');
            const dpMonthYear = document.getElementById('dp-month-year');
            const dpPrevMonthBtn = document.getElementById('dp-prev-month');
            const dpNextMonthBtn = document.getElementById('dp-next-month');
            const dpWeekdaysContainer = document.getElementById('dp-weekdays-container');
            const dpGridWrapper = document.querySelector('#date-picker-popover .dp-grid-wrapper');
            const confirmModal = document.getElementById('confirm-modal');
            const confirmModalTitle = document.getElementById('confirm-modal-title');
            const confirmModalMessage = document.getElementById('confirm-modal-message');
            const confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm-btn');
            const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn');
            const confirmModalCloseBtn = document.getElementById('confirm-modal-close-btn');
            const infoModal = document.getElementById('info-modal');
            const infoModalTitle = document.getElementById('info-modal-title');
            const infoModalMessage = document.getElementById('info-modal-message');
            const infoModalOkBtn = document.getElementById('info-modal-ok-btn');
            const infoModalCloseBtn = document.getElementById('info-modal-close-btn');
            const errorModal = document.getElementById('error-modal');
            const errorModalTitle = document.getElementById('error-modal-title');
            const errorModalMessage = document.getElementById('error-modal-message');
            const errorModalOkBtn = document.getElementById('error-modal-ok-btn');
            const errorModalCloseBtn = document.getElementById('error-modal-close-btn');
            const browserWarningModal = document.getElementById('browser-warning-modal');
            const browserWarningTitle = document.getElementById('browser-warning-title');
            const browserWarningMessage = document.getElementById('browser-warning-message');
            const browserWarningOkBtn = document.getElementById('browser-warning-ok-btn');
            const browserWarningCloseBtn = document.getElementById('browser-warning-close-btn');
            const dontShowAgainCheckbox = document.getElementById('dont-show-again-checkbox');
            
            // --- App State & Constants ---
            const BASE_HEADERS = { 'Accept': 'application/json', 'Accept-Language': 'zh-CN,zh;q=0.9', 'Origin': 'https://xiaoce.fun', 'Referer': 'https://xiaoce.fun/guessdisease', 'Fun-Device': 'web', 'Dnt': '1' };
            
            const GAME_MODES = {
                disease: { title: 'çŒœç—…', typeParam: 'guess_disease', apiUrl: 'https://xiaoce.fun/api/v0/quiz/daily/guessDisease/sendMessage', storagePrefix: 'guessDisease_chat_', activeKey: 'activeGuessDiseaseChat', greeting: 'ä½ å¥½ï¼ŒåŒ»ç”Ÿã€‚', placeholder: 'è¯·è¾“å…¥ä½ çš„æé—®æˆ–è¯Šæ–­â€¦', successMessage: 'ğŸ‰ æ­å–œä½ ï¼Œè¯Šæ–­æ­£ç¡®ï¼æ¸¸æˆèƒœåˆ©ï¼ ğŸ‰' },
                crime: { title: 'çŒœç½ª', typeParam: 'guess_crime', apiUrl: 'https://xiaoce.fun/api/v0/quiz/daily/guessCrime/sendMessage', storagePrefix: 'guessCrime_chat_', activeKey: 'activeGuessCrimeChat', greeting: 'ä½ å¥½ï¼Œå¾‹å¸ˆã€‚', placeholder: 'è¯·è¾“å…¥ä½ çš„æé—®æˆ–ç½ªåçŒœæµ‹', successMessage: 'ğŸ‰ æ­å–œä½ ï¼ŒçŒœç½ªæ­£ç¡®ï¼æ¸¸æˆèƒœåˆ©ï¼ ğŸ‰' }
            };
            let currentGameMode = 'disease';
            let chatHistory = [];
            let currentChatKey = null;
            let chatId = "";
            let isGameActive = false;
            let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            let contextMenuTarget = null;
            let dailySuccessCount = null;
            let currentVictoryRank = null;
            let targetDate = null;
            let activeDatesCache = {};
            let dpDisplayDate = new Date();
            let dpSelectedDate = null;
            let dpAnimationAbortController = null;
            
            // --- æ—¥æœŸå’Œæ ¼å¼åŒ–å·¥å…· ---
            function getLocalISOString(date = new Date()) {
                const d = date;
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}T${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}:${String(d.getSeconds()).padStart(2, '0')}`;
            }

            function getFormattedDate(date = new Date()) {
                return `${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}${String(date.getDate()).padStart(2, '0')}`;
            }
            
            async function fetchActiveDates() {
                const config = GAME_MODES[currentGameMode];
                if (activeDatesCache[currentGameMode]) {
                    return activeDatesCache[currentGameMode];
                }
                try {
                    const response = await fetch(`https://xiaoce.fun/api/v0/quiz/daily/general/fetchActive?type=${config.typeParam}`, { method: 'GET', headers: BASE_HEADERS });
                    if (!response.ok) throw new Error('API request failed');
                    const result = await response.json();
                    if (result.success && Array.isArray(result.data)) {
                        const dates = new Set(result.data);
                        activeDatesCache[currentGameMode] = dates;
                        return dates;
                    }
                    return new Set();
                } catch (error) {
                    console.error("è·å–å¯é€‰æ—¥æœŸå¤±è´¥:", error);
                    await showErrorDialog({ title: 'ç½‘ç»œé”™è¯¯', message: 'æ— æ³•è·å–å¾€æ—¥è°œé¢˜åˆ—è¡¨ï¼Œè¯·ç¨åé‡è¯•ã€‚' });
                    return null;
                }
            }

            function createCalendarGrid(date, activeDatesSet) {
                const grid = document.createElement('div');
                grid.className = 'dp-grid-container';
                const year = date.getFullYear();
                const month = date.getMonth();
                const firstDayOfMonth = new Date(year, month, 1);
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const startDayOfWeek = firstDayOfMonth.getDay();
                const prevMonth = new Date(year, month, 0);
                const daysInPrevMonth = prevMonth.getDate();
                let dateCounter = 1;
                let nextMonthCounter = 1;
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                for (let i = 0; i < 42; i++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'dp-day';
                    let cellDate, isCurrentMonth = false;

                    if (i < startDayOfWeek) {
                        cellDate = new Date(year, month - 1, daysInPrevMonth - startDayOfWeek + i + 1);
                        dayCell.textContent = cellDate.getDate();
                    } else if (dateCounter <= daysInMonth) {
                        cellDate = new Date(year, month, dateCounter);
                        dayCell.textContent = dateCounter;
                        isCurrentMonth = true;
                        dateCounter++;
                    } else {
                        cellDate = new Date(year, month + 1, nextMonthCounter);
                        dayCell.textContent = nextMonthCounter;
                        nextMonthCounter++;
                    }
                    const dateApiString = getFormattedDate(cellDate);
                    dayCell.dataset.date = dateApiString;

                    if (activeDatesSet.has(dateApiString) && isCurrentMonth) {
                        dayCell.classList.add('available');
                    } else {
                        dayCell.classList.add('disabled');
                    }
                    if (!isCurrentMonth) {
                        dayCell.classList.add('other-month');
                    }
                    if (cellDate.getTime() === today.getTime()) {
                        dayCell.classList.add('today');
                    }
                    if (dpSelectedDate && cellDate.getTime() === dpSelectedDate.getTime()) {
                        dayCell.classList.add('selected');
                    }
                    grid.appendChild(dayCell);
                }
                return grid;
            }

            function updateNavButtonStates(activeDatesSet) {
                const sortedDates = [...activeDatesSet].sort();
                if (sortedDates.length === 0) {
                    dpPrevMonthBtn.disabled = true;
                    dpPrevMonthBtn.classList.add('disabled');
                    dpNextMonthBtn.disabled = true;
                    dpNextMonthBtn.classList.add('disabled');
                    return;
                };
                const firstAvailableDateStr = sortedDates[0];
                const minMonthDate = new Date(parseInt(firstAvailableDateStr.substring(0, 4), 10), parseInt(firstAvailableDateStr.substring(4, 6), 10) - 1, 1);
                const today = new Date();
                const maxMonthDate = new Date(today.getFullYear(), today.getMonth(), 1);

                const currentMonthStart = new Date(dpDisplayDate.getFullYear(), dpDisplayDate.getMonth(), 1);
                
                const isPrevDisabled = currentMonthStart.getTime() <= minMonthDate.getTime();
                dpPrevMonthBtn.disabled = isPrevDisabled;
                dpPrevMonthBtn.classList.toggle('disabled', isPrevDisabled);

                const isNextDisabled = currentMonthStart.getTime() >= maxMonthDate.getTime();
                dpNextMonthBtn.disabled = isNextDisabled;
                dpNextMonthBtn.classList.toggle('disabled', isNextDisabled);
            }

            function transitionToMonth(direction, activeDatesSet) {
                if (direction === 'prev' && dpPrevMonthBtn.disabled) return;
                if (direction === 'next' && dpNextMonthBtn.disabled) return;

                if (dpAnimationAbortController) {
                    dpAnimationAbortController.abort();
                }
                dpAnimationAbortController = new AbortController();
                const signal = dpAnimationAbortController.signal;
                
                const existingGrids = dpGridWrapper.querySelectorAll('.dp-grid-container');
                let oldGrid = existingGrids.length > 0 ? existingGrids[existingGrids.length - 1] : null;
                
                if (existingGrids.length > 1) {
                    existingGrids[0].remove();
                }

                dpDisplayDate.setMonth(dpDisplayDate.getMonth() + (direction === 'next' ? 1 : -1));
                const newGrid = createCalendarGrid(dpDisplayDate, activeDatesSet);
                
                newGrid.style.transition = 'none';
                newGrid.style.transform = `translateX(${direction === 'next' ? '100%' : '-100%'})`;
                dpGridWrapper.appendChild(newGrid);
                
                newGrid.offsetHeight; 

                const transitionStyle = 'transform 0.4s var(--md-animation-standard)';
                newGrid.style.transition = transitionStyle;
                if (oldGrid) oldGrid.style.transition = transitionStyle;

                if (oldGrid) {
                    oldGrid.style.transform = `translateX(${direction === 'next' ? '-100%' : '100%'})`;
                }
                newGrid.style.transform = 'translateX(0)';

                newGrid.addEventListener('transitionend', () => {
                    if (oldGrid) oldGrid.remove();
                }, { signal });

                dpMonthYear.textContent = `${dpDisplayDate.getFullYear()}å¹´ ${dpDisplayDate.getMonth() + 1}æœˆ`;
                updateNavButtonStates(activeDatesSet);
            }
            
            // --- æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ---
            function scrollToBottom() {
                chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior: 'smooth' });
            }
            function renderMessage({ text, sender, type }) {
                const messageDiv = document.createElement('div');
                messageDiv.className = sender === 'system' ? `system-message ${type}` : `message ${sender}-message`;
                if (sender !== 'system') {
                    const bubble = document.createElement('div');
                    bubble.className = 'message-bubble';
                    bubble.textContent = text;
                    messageDiv.appendChild(bubble);
                } else {
                    messageDiv.textContent = text;
                }
                chatWindow.appendChild(messageDiv);
                scrollToBottom();
            }
            function setInputState(enabled, placeholderText = "") {
                userInput.disabled = !enabled;
                sendButton.disabled = !enabled;
                if (placeholderText) {
                    userInput.placeholder = placeholderText;
                }
            }
            
            async function saveHistory(firstUserMessage = null) {
                if (!currentChatKey) return;
                const config = GAME_MODES[currentGameMode];
                try {
                    const existingData = JSON.parse(localStorage.getItem(currentChatKey) || '{}');
                    const dataToSave = { ...existingData, messages: chatHistory, chatId: chatId, isGameActive: isGameActive, victoryRank: currentVictoryRank };
                    if (firstUserMessage) {
                        dataToSave.title = firstUserMessage.length > 28 ? firstUserMessage.substring(0, 28) + '...' : firstUserMessage;
                    }
                    localStorage.setItem(currentChatKey, JSON.stringify(dataToSave));
                    if (firstUserMessage) {
                        localStorage.setItem(config.activeKey, currentChatKey);
                    }
                    populateSidebar();
                } catch (error) {
                    console.error("ä¿å­˜èŠå¤©è®°å½•å¤±è´¥:", error);
                    await showErrorDialog({ title: 'ä¿å­˜å¤±è´¥', message: 'æ— æ³•ä¿å­˜èŠå¤©è®°å½•ã€‚è¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®æˆ–ç£ç›˜ç©ºé—´ã€‚' });
                }
            }
            
            async function loadChat(keyToLoad) {
                const config = GAME_MODES[currentGameMode];
                const savedData = localStorage.getItem(keyToLoad);
                if (!savedData) {
                    await startNewChat();
                    return;
                };
                try {
                    const data = JSON.parse(savedData);
                    currentChatKey = keyToLoad;
                    targetDate = null;
                    dpSelectedDate = null;
                    localStorage.setItem(config.activeKey, keyToLoad); 
                    chatHistory = data.messages || [];
                    chatId = data.chatId || "";
                    isGameActive = typeof data.isGameActive === 'boolean' ? data.isGameActive : false;
                    currentVictoryRank = data.victoryRank || null;
                    chatWindow.innerHTML = '';
                    renderMessage({ text: config.greeting, sender: 'ai' });
                    chatHistory.forEach(msg => renderMessage(msg));
                    if (isGameActive) {
                        const puzzleDate = keyToLoad.substring(config.storagePrefix.length, config.storagePrefix.length + 10);
                        dailySuccessCount = await fetchSuccessCount(puzzleDate);
                    } else {
                        dailySuccessCount = null;
                    }
                    updateUIForLoadedChat();
                } catch (error) {
                    console.error("åŠ è½½èŠå¤©è®°å½•å¤±è´¥:", error);
                    await startNewChat();
                }
            }
            
            async function startNewChat(selectedDate = null) {
                const config = GAME_MODES[currentGameMode];
                currentChatKey = null;
                chatId = "";
                isGameActive = true;
                currentVictoryRank = null;
                chatHistory = [];
                localStorage.setItem(config.activeKey, 'new');
                chatWindow.innerHTML = '';
                
                targetDate = selectedDate;
                
                renderMessage({ text: config.greeting, sender: 'ai' });
                
                if (selectedDate) {
                    dailySuccessCount = await fetchSuccessCount(selectedDate.replace(/-/g, ''));
                } else {
                    dailySuccessCount = await fetchSuccessCount();
                }
                
                populateSidebar();
                updateUIForLoadedChat();
                if (isMobile) {
                    document.body.classList.remove('sidebar-open');
                }
            }

            function updateCalendarButtonVisibility() {
                const isNewChat = currentChatKey === null;
                dailyPuzzleButton.style.display = isNewChat ? 'flex' : 'none';
            }
            
            function updateUIForLoadedChat() {
                updateCalendarButtonVisibility();
                const config = GAME_MODES[currentGameMode];
                let placeholder = "";
                if (isGameActive) {
                    placeholder = config.placeholder;
                    const isNewChat = currentChatKey === null;
                    if (dailySuccessCount !== null) {
                        const dayText = isNewChat && !targetDate ? 'ä»Šæ—¥' : 'è¯¥æ—¥';
                        const successText = ` ${dayText}å·²æœ‰ ${dailySuccessCount.toLocaleString()} äººçŒœå‡ºè°œåº•`;
                        if (!isMobile) {
                            placeholder += successText;
                        }
                    }
                } else {
                    if (currentVictoryRank !== null) {
                        placeholder = `æ‚¨æ˜¯è¯¥æ—¥ç¬¬ ${currentVictoryRank.toLocaleString()} ä½çŒœå‡ºè°œåº•çš„äººï¼ğŸ‰`;
                    } else {
                        placeholder = "æ­å–œä½ ï¼Œå·²çŒœå‡ºè°œåº•ï¼è¯·å¼€å¯æ–°å¯¹è¯ã€‚";
                    }
                }
                setInputState(isGameActive, placeholder);
                document.querySelectorAll('.history-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.key === currentChatKey);
                });
                if (!isMobile) {
                    userInput.focus();
                }
            }
            
            async function fetchSuccessCount(puzzleDateStr = null) {
                const config = GAME_MODES[currentGameMode];
                let dateForApi = puzzleDateStr ? puzzleDateStr.replace(/-/g, '') : getFormattedDate();
                const url = `https://xiaoce.fun/api/v0/quiz/daily/getStatus?type=${config.typeParam}&date=${dateForApi}`;
                try {
                    const response = await fetch(url, { method: 'GET', headers: BASE_HEADERS });
                    if (!response.ok) return null;
                    const data = await response.json();
                    return (data.success && data.data) ? data.data.success : null;
                } catch (error) {
                    console.error("è·å–æˆåŠŸäººæ•°æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯:", error);
                    return null;
                }
            }

            async function sendMessage() {
                const messageText = userInput.value.trim();
                if (!messageText || !isGameActive) return;
                const config = GAME_MODES[currentGameMode];
                const isFirstMessage = (currentChatKey === null);
                let puzzleDateForApi;

                if (isFirstMessage) {
                    const baseDate = targetDate ? new Date(targetDate + "T12:00:00") : new Date();
                    currentChatKey = config.storagePrefix + getLocalISOString(baseDate);
                    puzzleDateForApi = targetDate ? targetDate.replace(/-/g, '') : getFormattedDate();
                } else {
                    puzzleDateForApi = currentChatKey.substring(config.storagePrefix.length, config.storagePrefix.length + 10).replace(/-/g, '');
                }
                
                chatHistory.push({ text: messageText, sender: 'user' });
                renderMessage({ text: messageText, sender: 'user' });
                userInput.value = '';
                setInputState(false, "AIæ€è€ƒä¸­...");

                try {
                    const response = await fetch(config.apiUrl, { 
                        method: 'POST', 
                        headers: { 
                            ...BASE_HEADERS, 
                            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' 
                        }, 
                        body: `date=${puzzleDateForApi}&chatId=${chatId}&message=${encodeURIComponent(messageText)}` 
                    });
                    const data = await response.json();
                    if (!response.ok || !data.success) throw new Error(data.message || `è¯·æ±‚å¤±è´¥: ${response.status}`);
                    const d = data.data || {};
                    if (d.chatId) chatId = d.chatId;
                    const aiMessage = { text: d.answer || "æˆ‘ä¸çŸ¥é“è¯¥æ€ä¹ˆå›ç­”ã€‚", sender: 'ai' };
                    chatHistory.push(aiMessage);
                    renderMessage(aiMessage);
                    if (d.right) {
                        isGameActive = false;
                        const successMsg = { text: config.successMessage, sender: 'system', type: 'success'};
                        chatHistory.push(successMsg);
                        renderMessage(successMsg);
                        currentVictoryRank = await fetchSuccessCount(puzzleDateForApi);
                    }
                    updateUIForLoadedChat(); 
                } catch (error) {
                    console.error("å‘é€æ¶ˆæ¯å¤±è´¥:", error);
                    chatHistory.pop();
                    if (chatWindow.lastChild) chatWindow.lastChild.remove();
                    const errorMsg = { text: `é”™è¯¯: æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œå¹¶é‡è¯•ã€‚`, sender: 'system', type: 'error' };
                    chatHistory.push(errorMsg);
                    renderMessage(errorMsg);
                    userInput.value = messageText;
                    setInputState(true, "å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•");
                } finally {
                    await saveHistory(isFirstMessage ? messageText : null);
                    if (!isMobile) userInput.focus();
                }
            }

            async function checkBrowserCompatibility() {
                if (localStorage.getItem('suppressBrowserWarning') === 'true' || sessionStorage.getItem('browserVersionWarningShown') === 'true') {
                    return;
                }
                // æ­¤å‡½æ•°ç°åœ¨ç”¨äºæ˜¾ç¤ºâ€œç‰ˆæœ¬è¾ƒä½â€è€Œéâ€œæ— æ³•è¿è¡Œâ€çš„è­¦å‘Š
                // é€šè¿‡ `isFeatureSupported` å‡½æ•°æ¥å†³å®šæ˜¯å¦æ˜¾ç¤º
                // è¿™é‡Œæˆ‘ä»¬å‡è®¾å¦‚æœä¸»è„šæœ¬èƒ½è¿è¡Œï¼Œä½†æŸäº›ç‰¹æ€§å¯èƒ½ç¼ºå¤±
                const isFeatureSupported = () => {
                    const testEl = document.createElement('div');
                    testEl.style.display = 'flex';
                    testEl.style.gap = '1px';
                    return testEl.style.gap === '1px' && ('backdropFilter' in testEl.style || 'webkitBackdropFilter' in testEl.style);
                };
                if (!isFeatureSupported()) {
                    await showBrowserWarningDialog({
                        title: 'æµè§ˆå™¨å…¼å®¹æ€§æç¤º',
                        message: 'æ‚¨å½“å‰çš„æµè§ˆå™¨ç‰ˆæœ¬è¿‡ä½ï¼Œéƒ¨åˆ†è§†è§‰æ•ˆæœå’Œå¸ƒå±€å¯èƒ½æ— æ³•å®Œç¾æ˜¾ç¤ºã€‚å»ºè®®å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬çš„ç°ä»£æµè§ˆå™¨ï¼ˆå¦‚Chrome, Firefox, Edgeï¼‰ä»¥è·å¾—æœ€ä½³ä½“éªŒã€‚'
                    });
                }
            }
            function getRelativeDateGroup(dateStr) {
                const today = new Date();
                const date = new Date(dateStr);
                today.setHours(0, 0, 0, 0);
                date.setHours(0, 0, 0, 0);
                const diffDays = (today - date) / 864e5;
                if (diffDays === 0) return "ä»Šå¤©";
                if (diffDays === 1) return "æ˜¨å¤©";
                if (diffDays < 7) return "7å¤©å†…";
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            }
            function populateSidebar() {
                const config = GAME_MODES[currentGameMode];
                const prefix = config.storagePrefix;
                const chats = Object.keys(localStorage).filter(k => k.startsWith(prefix)).map(key => ({ key, data: JSON.parse(localStorage.getItem(key) || '{}') })).filter(chat => chat.data && chat.data.title).sort((a, b) => b.key.localeCompare(a.key));
                const groups = {};
                chats.forEach(chat => {
                    const dateStr = chat.key.substring(prefix.length, prefix.length + 10);
                    const groupName = getRelativeDateGroup(dateStr);
                    if (!groups[groupName]) {
                        groups[groupName] = [];
                    }
                    groups[groupName].push(chat);
                });
                historyListContainer.innerHTML = '';
                const groupOrder = ["ä»Šå¤©", "æ˜¨å¤©", "7å¤©å†…"];
                const sortedGroupNames = Object.keys(groups).sort((a, b) => {
                    const aIndex = groupOrder.indexOf(a);
                    const bIndex = groupOrder.indexOf(b);
                    if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
                    if (aIndex !== -1) return -1;
                    if (bIndex !== -1) return 1;
                    return b.localeCompare(a);
                });
                sortedGroupNames.forEach(groupName => {
                    const header = document.createElement('div');
                    header.className = 'history-group-header';
                    header.textContent = groupName;
                    historyListContainer.appendChild(header);
                    groups[groupName].forEach(({ key, data }) => {
                        const li = document.createElement('div');
                        li.className = 'history-item';
                        li.dataset.key = key;
                        li.innerHTML = `<span>${data.title}</span>`;
                        li.title = data.title;
                        if (key === currentChatKey) li.classList.add('active');
                        li.addEventListener('click', () => loadChat(key));
                        historyListContainer.appendChild(li);
                    });
                });
            }
            function handleRename() {
                if (!contextMenuTarget) return;
                const key = contextMenuTarget.dataset.key;
                const titleSpan = contextMenuTarget.querySelector('span');
                if (!titleSpan) return;
                const currentTitle = titleSpan.textContent;
                
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentTitle;
                input.style.cssText = 'width:100%;padding:0;margin:0;border:none;background:transparent;color:inherit;font:inherit;outline:none;';
                
                contextMenuTarget.replaceChild(input, titleSpan);
                input.focus();
                input.select();

                const saveRename = () => {
                    const newTitle = input.value.trim();
                    if (newTitle && newTitle !== currentTitle) {
                        try {
                            const savedData = JSON.parse(localStorage.getItem(key) || '{}');
                            savedData.title = newTitle;
                            localStorage.setItem(key, JSON.stringify(savedData));
                            titleSpan.textContent = newTitle;
                        } catch (e) { 
                            console.error("é‡å‘½åå¤±è´¥", e); 
                            titleSpan.textContent = currentTitle;
                        }
                    } else {
                        titleSpan.textContent = currentTitle;
                    }
                    if (contextMenuTarget.contains(input)) {
                       contextMenuTarget.replaceChild(titleSpan, input);
                    }
                    input.removeEventListener('keydown', onKeydown);
                };

                const onKeydown = (e) => {
                    if (e.key === 'Enter') {
                        input.blur();
                    } else if (e.key === 'Escape') {
                        input.removeEventListener('blur', saveRename);
                        titleSpan.textContent = currentTitle;
                        if (contextMenuTarget.contains(input)) {
                           contextMenuTarget.replaceChild(titleSpan, input);
                        }
                    }
                };

                input.addEventListener('blur', saveRename, { once: true });
                input.addEventListener('keydown', onKeydown);
            }

            function showBrowserWarningDialog({ title = 'æç¤º', message = '' }) {
                return new Promise(resolve => {
                    browserWarningTitle.textContent = title;
                    browserWarningMessage.textContent = message;
                    dontShowAgainCheckbox.checked = false;
                    let resolver = null;
                    const show = () => browserWarningModal.classList.add('show');
                    const hide = () => {
                        if (dontShowAgainCheckbox.checked) {
                            localStorage.setItem('suppressBrowserWarning', 'true');
                        }
                        sessionStorage.setItem('browserVersionWarningShown', 'true');
                        browserWarningModal.classList.remove('show');
                        if (resolver) { resolver(); resolver = null; }
                        browserWarningOkBtn.removeEventListener('click', handleAction);
                        browserWarningCloseBtn.removeEventListener('click', handleAction);
                        browserWarningModal.removeEventListener('click', handleOverlayClick);
                    };
                    const handleAction = () => hide();
                    const handleOverlayClick = (e) => { if (e.target === browserWarningModal) handleAction(); };
                    browserWarningOkBtn.addEventListener('click', handleAction);
                    browserWarningCloseBtn.addEventListener('click', handleAction);
                    browserWarningModal.addEventListener('click', handleOverlayClick);
                    show();
                    resolver = resolve;
                });
            }

            function showErrorDialog({ title = 'é”™è¯¯', message = '' }) {
                return new Promise(resolve => {
                    errorModalTitle.textContent = title;
                    errorModalMessage.textContent = message;
                    let resolver = null;
                    const show = () => errorModal.classList.add('show');
                    const hide = () => {
                        errorModal.classList.remove('show');
                        if (resolver) { resolver(); resolver = null; }
                        errorModalOkBtn.removeEventListener('click', handleAction);
                        errorModalCloseBtn.removeEventListener('click', handleAction);
                        errorModal.removeEventListener('click', handleOverlayClick);
                    };
                    const handleAction = () => hide();
                    const handleOverlayClick = (e) => { if (e.target === errorModal) handleAction(); };
                    errorModalOkBtn.addEventListener('click', handleAction);
                    errorModalCloseBtn.addEventListener('click', handleAction);
                    errorModal.addEventListener('click', handleOverlayClick);
                    show();
                    resolver = resolve;
                });
            }
            function showInfoDialog({ title = 'æç¤º', message = '' }) {
                return new Promise(resolve => {
                    infoModalTitle.textContent = title;
                    infoModalMessage.textContent = message;
                    let resolver = null;
                    const show = () => infoModal.classList.add('show');
                    const hide = () => {
                        infoModal.classList.remove('show');
                        if (resolver) { resolver(); resolver = null; }
                        infoModalOkBtn.removeEventListener('click', handleAction);
                        infoModalCloseBtn.removeEventListener('click', handleAction);
                        infoModal.removeEventListener('click', handleOverlayClick);
                    };
                    const handleAction = () => hide();
                    const handleOverlayClick = (e) => { if (e.target === infoModal) handleAction(); };
                    infoModalOkBtn.addEventListener('click', handleAction);
                    infoModalCloseBtn.addEventListener('click', handleAction);
                    infoModal.addEventListener('click', handleOverlayClick);
                    show();
                    resolver = resolve;
                });
            }
            function showConfirmDialog({ title = 'æ°¸ä¹…åˆ é™¤å¯¹è¯', message = 'åˆ é™¤åï¼Œè¯¥å¯¹è¯å°†ä¸å¯æ¢å¤ã€‚ç¡®è®¤åˆ é™¤å—ï¼Ÿ', confirmText = 'åˆ é™¤', confirmClass = '' }) {
                return new Promise(resolve => {
                    confirmModalTitle.textContent = title;
                    confirmModalMessage.textContent = message;
                    confirmModalConfirmBtn.textContent = confirmText;
                    confirmModalConfirmBtn.className = `confirm-btn ${confirmClass}`;
                    confirmModal.classList.toggle('is-delete', confirmClass === 'delete');
                    let resolver = null;
                    const show = () => confirmModal.classList.add('show');
                    const hide = (value) => {
                        confirmModal.classList.remove('show');
                        if (resolver) { resolver(value); resolver = null; }
                        confirmModalConfirmBtn.removeEventListener('click', handleConfirm);
                        confirmModalCancelBtn.removeEventListener('click', handleCancel);
                        confirmModalCloseBtn.removeEventListener('click', handleCancel);
                        confirmModal.removeEventListener('click', handleOverlayClick);
                    };
                    const handleConfirm = () => hide(true);
                    const handleCancel = () => hide(false);
                    const handleOverlayClick = (e) => { if (e.target === confirmModal) handleCancel(); };
                    confirmModalConfirmBtn.addEventListener('click', handleConfirm);
                    confirmModalCancelBtn.addEventListener('click', handleCancel);
                    confirmModalCloseBtn.addEventListener('click', handleCancel);
                    confirmModal.addEventListener('click', handleOverlayClick);
                    show();
                    resolver = resolve;
                });
            }
            async function handleDelete() {
                if (!contextMenuTarget) return;
                const key = contextMenuTarget.dataset.key;
                const confirmed = await showConfirmDialog({ 
                    title: 'æ°¸ä¹…åˆ é™¤å¯¹è¯', 
                    message: 'åˆ é™¤åï¼Œè¯¥å¯¹è¯å°†ä¸å¯æ¢å¤ã€‚ç¡®è®¤åˆ é™¤å—ï¼Ÿ', 
                    confirmText: 'åˆ é™¤',
                    confirmClass: 'delete' 
                });
                if (confirmed) {
                    localStorage.removeItem(key);
                    populateSidebar();
                    if (key === currentChatKey) {
                        await startNewChat();
                    }
                }
            }
            function createCustomDropdown() {
                gameModeDropdown.innerHTML = '';
                const selected = document.createElement('div');
                selected.className = 'select-selected';
                const selectedText = document.createElement('span');
                selectedText.id = 'selected-game-mode-text';
                selectedText.textContent = GAME_MODES[currentGameMode].title;
                selected.appendChild(selectedText);

                const arrow = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                arrow.setAttribute('class', 'select-arrow');
                arrow.setAttribute('viewBox', '0 0 20 20');
                arrow.innerHTML = `<path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />`;
                selected.appendChild(arrow);
                
                const items = document.createElement('ul');
                items.className = 'select-items';
                Object.keys(GAME_MODES).forEach(key => {
                    const li = document.createElement('li');
                    li.className = 'select-item';
                    li.textContent = GAME_MODES[key].title;
                    li.dataset.value = key;
                    li.addEventListener('click', async function(e) {
                        const newMode = this.dataset.value;
                        if (newMode === currentGameMode) {
                            closeDropdown();
                            return;
                        }
                        selectedText.textContent = this.textContent;
                        closeDropdown();
                        await handleGameModeChange(newMode);
                    });
                    items.appendChild(li);
                });

                gameModeDropdown.appendChild(selected);
                gameModeDropdown.appendChild(items);
                
                selected.addEventListener('click', (e) => {
                    e.stopPropagation();
                    datePickerPopover.classList.remove('show');
                    items.classList.toggle('show');
                    selected.classList.toggle('select-arrow-active');
                });
            }
            function closeDropdown() {
                const items = gameModeDropdown.querySelector('.select-items');
                const selected = gameModeDropdown.querySelector('.select-selected');
                if (items && items.classList.contains('show')) {
                    items.classList.remove('show');
                    if (selected) {
                        selected.classList.remove('select-arrow-active');
                    }
                }
            }
            async function handleGameModeChange(newMode) {
                currentGameMode = newMode;
                localStorage.setItem('lastGameMode', currentGameMode);
                document.title = `çŒœç› - ${GAME_MODES[currentGameMode].title}`;
                activeDatesCache = {};
                createCustomDropdown();
                await startNewChat();
            }
            async function handleExport() {
                const allData = {};
                const prefixes = Object.values(GAME_MODES).map(mode => mode.storagePrefix);
                const settingsKeys = ['lastGameMode', 'sidebarCollapsedState', 'suppressBrowserWarning'];
                const chatKeysFound = [];

                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const isChatKey = prefixes.some(prefix => key.startsWith(prefix));
                    
                    if (isChatKey) {
                        chatKeysFound.push(key);
                        allData[key] = localStorage.getItem(key);
                    } else if (settingsKeys.includes(key)) {
                        allData[key] = localStorage.getItem(key);
                    }
                }

                if (chatKeysFound.length === 0) {
                    await showInfoDialog({ title: 'å¯¼å‡ºæç¤º', message: 'æ²¡æœ‰å¯å¯¼å‡ºçš„å†å²è®°å½•ã€‚' });
                    return;
                }

                const jsonString = JSON.stringify(allData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `caiyan_backup_${getFormattedDate()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            async function handleImport(event) {
                const file = event.target.files[0];
                if (!file) return;
                const confirmed = await showConfirmDialog({
                    title: 'å¯¼å…¥å†å²è®°å½•',
                    message: 'æ­¤æ“ä½œå°†è¦†ç›–æ‰€æœ‰æœ¬åœ°èŠå¤©è®°å½•ï¼Œä¸”ä¸å¯æ¢å¤ã€‚ç¡®å®šè¦å¯¼å…¥å—ï¼Ÿ',
                    confirmText: 'å¯¼å…¥',
                    confirmClass: 'import'
                });
                if (!confirmed) {
                    importFileInput.value = '';
                    return;
                }
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        const prefixes = Object.values(GAME_MODES).map(mode => mode.storagePrefix);
                        const keysToClear = ['lastGameMode', 'sidebarCollapsedState', 'suppressBrowserWarning'];
                        const keysToRemove = [];
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (keysToClear.includes(key) || prefixes.some(prefix => key.startsWith(prefix))) {
                                keysToRemove.push(key);
                            }
                        }
                        keysToRemove.forEach(key => localStorage.removeItem(key));
                        for (const key in importedData) {
                            if (Object.hasOwnProperty.call(importedData, key)) {
                                localStorage.setItem(key, importedData[key]);
                            }
                        }
                        location.reload();
                    } catch (error) {
                        console.error("Import error:", error);
                        await showErrorDialog({ title: 'å¯¼å…¥å¤±è´¥', message: 'æ–‡ä»¶æ ¼å¼æ— æ•ˆæˆ–å·²æŸåã€‚' });
                    } finally {
                        importFileInput.value = '';
                    }
                };
                reader.readAsText(file);
            }

            // --- Event Handlers & Initialization ---
            function setupThemeColorSync() {
                const themeColorMeta = document.querySelector('meta[name="theme-color"]');
                if (!themeColorMeta) return;

                const updateThemeColor = () => {
                    const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    const newColor = isDark ? '#141318' : '#fdf8fd';
                    themeColorMeta.setAttribute('content', newColor);
                };

                updateThemeColor();
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateThemeColor);
            }

            function setupEventHandlers() {
                sidebarToggleButton.addEventListener('click', () => {
                    appWrapper.classList.toggle('sidebar-collapsed');
                    const isCollapsed = appWrapper.classList.contains('sidebar-collapsed');
                    sidebarToggleButton.textContent = isCollapsed ? 'â€º' : 'â€¹';
                    localStorage.setItem('sidebarCollapsedState', isCollapsed);
                });
                mobileMenuToggle.addEventListener('click', () => { document.body.classList.add('sidebar-open'); });
                sidebarOverlay.addEventListener('click', () => {
                    document.body.classList.remove('sidebar-open');
                    if (document.activeElement) document.activeElement.blur();
                });
                
                newChatButton.addEventListener('click', () => {
                    dpSelectedDate = null;
                    startNewChat();
                });

                sendButton.addEventListener('click', sendMessage);
                userInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                userInput.addEventListener('focus', () => {
                    if (isGameActive && dailySuccessCount !== null) {
                        const isNewChat = currentChatKey === null;
                        const dayText = isNewChat && !targetDate ? 'ä»Šæ—¥' : 'è¯¥æ—¥';
                        userInput.placeholder = `${GAME_MODES[currentGameMode].placeholder} ${dayText}å·²æœ‰ ${dailySuccessCount.toLocaleString()} äººçŒœå‡ºè°œåº•`;
                    }
                });
                userInput.addEventListener('blur', () => {
                    if (isGameActive) {
                        let placeholder = GAME_MODES[currentGameMode].placeholder;
                        if (!isMobile && dailySuccessCount !== null) {
                            const isNewChat = currentChatKey === null;
                            const dayText = isNewChat && !targetDate ? 'ä»Šæ—¥' : 'è¯¥æ—¥';
                            placeholder += ` ${dayText}å·²æœ‰ ${dailySuccessCount.toLocaleString()} äººçŒœå‡ºè°œåº•`;
                        }
                        userInput.placeholder = placeholder;
                    }
                });
                const showContextMenu = (target, x, y) => {
                    contextMenuTarget = target;
                    closeDropdown();
                    datePickerPopover.classList.remove('show');

                    requestAnimationFrame(() => {
                        const menuWidth = contextMenu.offsetWidth;
                        const menuHeight = contextMenu.offsetHeight;
                        const viewWidth = window.innerWidth;
                        const viewHeight = window.innerHeight;

                        const finalX = (x + menuWidth > viewWidth) ? viewWidth - menuWidth - 5 : x;
                        const finalY = (y + menuHeight > viewHeight) ? viewHeight - menuHeight - 5 : y;

                        contextMenu.style.top = `${finalY}px`;
                        contextMenu.style.left = `${finalX}px`;
                        contextMenu.classList.add('show');
                    });
                };

                historyListContainer.addEventListener('contextmenu', (e) => {
                    const target = e.target.closest('.history-item');
                    if (target) {
                        e.preventDefault();
                        showContextMenu(target, e.clientX, e.clientY);
                    }
                });

                let longPressTimer = null;
                let touchStartX = 0, touchStartY = 0;
                historyListContainer.addEventListener('touchstart', (e) => {
                    const target = e.target.closest('.history-item');
                    if (target) {
                        touchStartX = e.touches[0].clientX;
                        touchStartY = e.touches[0].clientY;
                        longPressTimer = setTimeout(() => {
                            longPressTimer = null;
                            if (navigator.vibrate) navigator.vibrate(50);
                            showContextMenu(target, e.touches[0].clientX, e.touches[0].clientY);
                        }, 500);
                    }
                }, { passive: true });
                historyListContainer.addEventListener('touchmove', (e) => {
                    if (longPressTimer && (Math.abs(e.touches[0].clientX - touchStartX) > 10 || Math.abs(e.touches[0].clientY - touchStartY) > 10)) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                });
                const clearLongPress = () => { if (longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; } };
                historyListContainer.addEventListener('touchend', clearLongPress);
                historyListContainer.addEventListener('touchcancel', clearLongPress);

                document.addEventListener('click', (e) => {
                    if (contextMenu.classList.contains('show') && !contextMenu.contains(e.target)) {
                        contextMenu.classList.remove('show');
                    }
                    if (!gameModeDropdown.contains(e.target)) {
                        closeDropdown();
                    }
                    if (datePickerPopover.classList.contains('show') && !datePickerPopover.contains(e.target) && !e.target.closest('.header-actions')) {
                        datePickerPopover.classList.remove('show');
                    }
                });
                renameOption.addEventListener('click', (e) => {
                    e.stopPropagation();
                    handleRename();
                    contextMenu.classList.remove('show');
                });
                deleteOption.addEventListener('click', (e) => {
                    e.stopPropagation();
                    handleDelete();
                    contextMenu.classList.remove('show');
                });

                exportButton.addEventListener('click', handleExport);
                importButton.addEventListener('click', () => importFileInput.click());
                importFileInput.addEventListener('change', handleImport);

                dailyPuzzleButton.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    closeDropdown();
                    
                    if (datePickerPopover.classList.contains('show')) {
                        datePickerPopover.classList.remove('show');
                        return;
                    }
                    
                    const activeDatesSet = await fetchActiveDates();
                    if (!activeDatesSet || activeDatesSet.size === 0) return;
                    
                    dpDisplayDate = dpSelectedDate ? new Date(dpSelectedDate.getFullYear(), dpSelectedDate.getMonth(), 1) : new Date();
                    dpGridWrapper.innerHTML = '';
                    dpGridWrapper.appendChild(createCalendarGrid(dpDisplayDate, activeDatesSet));
                    dpMonthYear.textContent = `${dpDisplayDate.getFullYear()}å¹´ ${dpDisplayDate.getMonth() + 1}æœˆ`;
                    updateNavButtonStates(activeDatesSet);
                    datePickerPopover.classList.add('show');
                });

                dpPrevMonthBtn.addEventListener('click', async () => transitionToMonth('prev', await fetchActiveDates()));
                dpNextMonthBtn.addEventListener('click', async () => transitionToMonth('next', await fetchActiveDates()));
                dpGridWrapper.addEventListener('click', (e) => {
                    const target = e.target.closest('.dp-day.available');
                    if (target) {
                        const dateStr = target.dataset.date;
                        const year = parseInt(dateStr.substring(0, 4), 10);
                        const month = parseInt(dateStr.substring(4, 6), 10) - 1;
                        const day = parseInt(dateStr.substring(6, 8), 10);
                        dpSelectedDate = new Date(year, month, day);
                        datePickerPopover.classList.remove('show');
                        startNewChat(`${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`);
                    }
                });
            }

            async function initializeApp() {
                setupThemeColorSync();

                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('/sw.js')
                            .then(registration => { console.log('ServiceWorker registration successful with scope: ', registration.scope); })
                            .catch(err => { console.log('ServiceWorker registration failed: ', err); });
                    });
                }
                await checkBrowserCompatibility();
                if (localStorage.getItem('sidebarCollapsedState') === 'true') {
                    appWrapper.classList.add('sidebar-collapsed');
                    sidebarToggleButton.textContent = 'â€º';
                }
                const lastMode = localStorage.getItem('lastGameMode');
                if (lastMode && GAME_MODES[lastMode]) {
                    currentGameMode = lastMode;
                }
                document.title = `çŒœç› - ${GAME_MODES[currentGameMode].title}`;
                
                const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                dpWeekdaysContainer.innerHTML = '';
                weekdays.forEach(day => {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'dp-weekday';
                    dayEl.textContent = day;
                    dpWeekdaysContainer.appendChild(dayEl);
                });
                
                createCustomDropdown();
                setupEventHandlers();
                
                const config = GAME_MODES[currentGameMode];
                const activeChatKey = localStorage.getItem(config.activeKey);
                
                let keyToLoad = null;
                if (activeChatKey && activeChatKey !== 'new') {
                    keyToLoad = activeChatKey;
                } else if (!activeChatKey) {
                    const keys = Object.keys(localStorage).filter(k => k.startsWith(config.storagePrefix)).sort().reverse();
                    if (keys.length > 0) {
                        keyToLoad = keys[0];
                    }
                }

                if (keyToLoad) {
                    await loadChat(keyToLoad);
                } else {
                    await startNewChat();
                }
                
                populateSidebar();
            }

            // æ£€æŸ¥DOMæ˜¯å¦å·²ç»åŠ è½½å®Œæˆ
            if (document.readyState === 'loading') {
                // å¦‚æœè¿˜åœ¨åŠ è½½ï¼Œåˆ™ç­‰å¾…DOMContentLoadedäº‹ä»¶
                document.addEventListener('DOMContentLoaded', initializeApp);
            } else {
                // å¦‚æœå·²ç»åŠ è½½å®Œæ¯•ï¼ˆinteractive æˆ– completeï¼‰ï¼Œåˆ™ç«‹å³æ‰§è¡Œåˆå§‹åŒ–
                initializeApp();
            }
    })();
    </script>

    <!-- å®ˆå«è„šæœ¬ï¼Œä½¿ç”¨æœ€å®‰å…¨çš„ ES5 è¯­æ³•ï¼Œå¿…é¡»æ”¾åœ¨æœ€å -->
    <script>
        (function () {
            'use strict';

            // åŠŸèƒ½ï¼šæ£€æµ‹æµè§ˆå™¨æ˜¯å¦æ”¯æŒåŸºç¡€çš„ç°ä»£ JS è¯­æ³•ã€‚
            // å°è¯•æ„é€ ä¸€ä¸ªåŒ…å«ç°ä»£è¯­æ³•çš„å‡½æ•°ã€‚
            // åœ¨æ—§ç‰ˆæµè§ˆå™¨ä¸­ï¼Œè¿™ä¼šæŠ›å‡ºè¯­æ³•é”™è¯¯ï¼Œè¢« catch å—æ•è·ã€‚
            function isModernJsSupported() {
                try {
                    // æ£€æŸ¥æœ€æ ¸å¿ƒçš„ ES6+ è¯­æ³•: const, ç®­å¤´å‡½æ•°, async/await ç­‰ã€‚
                    new Function('"use strict"; const test = async () => {};');
                    return true;
                } catch (e) {
                    return false;
                }
            }

            // æ ¹æ®æ£€æµ‹ç»“æœæ‰§è¡Œä¸åŒæ“ä½œ
            if (isModernJsSupported()) {
                // æ˜¯ç°ä»£æµè§ˆå™¨ï¼šåŠ¨æ€æ‰§è¡Œä¸»åº”ç”¨è„šæœ¬
                var scriptTemplate = document.getElementById('main-app-script');
                if (scriptTemplate) {
                    var executableScript = document.createElement('script');
                    executableScript.textContent = scriptTemplate.textContent;
                    document.body.appendChild(executableScript);
                }
            } else {
                // æ˜¯æ—§ç‰ˆæµè§ˆå™¨ï¼šéšè—ä¸»åº”ç”¨ï¼Œæ˜¾ç¤ºé™æ€åå¤‡é¡µé¢
                var app = document.getElementById('app-wrapper');
                if (app) {
                    app.style.display = 'none';
                }
                
                var fallbackMessage = document.getElementById('unsupported-browser-message');
                if (fallbackMessage) {
                    fallbackMessage.style.display = 'block';
                }
            }
        })();
    </script>

</body>
</html>
