<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>猜盐</title>
    <link rel="icon" href="icons/icon-128x128.png" type="image/png">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#fefbff">

    <!-- 
      为IE8及以下版本提供迷你样式表，在JS执行前隐藏所有应用组件，防止无样式内容泄漏。
      此代码块会被IE9+和现代浏览器完全忽略。
    -->
    <!--[if lte IE 8]>
    <style type="text/css">
        #app-wrapper,
        #context-menu,
        #confirm-modal,
        #info-modal,
        #error-modal,
        #browser-warning-modal {
            display: none;
        }
    </style>
    <![endif]-->

    <!-- 
      为主样式表添加条件注释，防止IE8及以下版本的CSS解析器因读取现代CSS而崩溃。
    -->
    <!--[if gt IE 8]><!-->
    <style>
        *, *::before, *::after {
            box-sizing: border-box;
        }

        :root {
            /* M3 Shape Tokens */
            --md-sys-shape-corner-none: 0px;
            --md-sys-shape-corner-xs: 4px;
            --md-sys-shape-corner-s: 8px;
            --md-sys-shape-corner-m: 12px;
            --md-sys-shape-corner-l: 16px;
            --md-sys-shape-corner-xl: 28px;
            --md-sys-shape-corner-full: 100px;

            /* M3 Elevation Tokens (Light) */
            --md-sys-elevation-level-0: none;
            --md-sys-elevation-level-1: 0px 1px 3px 1px rgba(0,0,0,0.15), 0px 1px 2px 0px rgba(0,0,0,0.3);
            --md-sys-elevation-level-2: 0px 2px 6px 2px rgba(0,0,0,0.15), 0px 1px 2px 0px rgba(0,0,0,0.3);
            --md-sys-elevation-level-3: 0px 4px 8px 3px rgba(0,0,0,0.15), 0px 1px 3px 0px rgba(0,0,0,0.3);

            /* Animation Curves */
            --md-animation-standard: cubic-bezier(0.2, 0, 0, 1);
            --md-animation-emphasized: cubic-bezier(0.3, 0, 0, 1);
            
            /* Enhanced System Font Stack */
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI Variable", "Segoe UI", "MiSans", "HarmonyOS Sans", "OPlusSans", "Vivosans", Roboto, "Noto Sans", "Helvetica Neue", Arial, sans-serif;

            /* M3 Light Theme Colors */
            --md-sys-color-primary-rgb: 74, 100, 234;
            --md-sys-color-primary: #4a64ea;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #e0e0ff;
            --md-sys-color-on-primary-container: #001869;
            --md-sys-color-secondary-container: #e2e0f9;
            --md-sys-color-on-secondary-container-rgb: 26, 26, 46;
            --md-sys-color-on-secondary-container: #1a1a2e;
            --md-sys-color-tertiary: #78536b;
            --md-sys-color-on-tertiary: #ffffff;
            --md-sys-color-surface: #fdf8fd;
            --md-sys-color-surface-container: #f3edf7;
            --md-sys-color-surface-container-high: #eeebf1;
            --md-sys-color-surface-container-highest: #e8e5ea;
            --md-sys-color-on-surface-rgb: 28, 27, 31;
            --md-sys-color-on-surface: #1c1b1f;
            --md-sys-color-on-surface-variant: #48454e;
            --md-sys-color-outline: #79757f;
            --md-sys-color-outline-variant: #c9c5d0;
            --md-sys-color-error: #ba1a1a;
            --md-sys-color-on-error: #ffffff;
            --md-sys-color-error-container: #ffdad6;
            --md-sys-color-on-error-container: #410002;
            --md-sys-color-success: #376a20;
            --md-sys-color-shadow: #000000;
            
            /* Component Mappings */
            --sidebar-bg: var(--md-sys-color-surface-container);
            --main-bg: var(--md-sys-color-surface);
            --chat-window-bg: var(--md-sys-color-surface);
            --text-primary: var(--md-sys-color-on-surface);
            --text-secondary: var(--md-sys-color-on-surface-variant);
            --sidebar-text: var(--md-sys-color-on-surface-variant);
            --sidebar-group-text: var(--md-sys-color-on-surface-variant);
            --border-color: var(--md-sys-color-outline-variant);
            --new-chat-btn-bg: var(--md-sys-color-primary-container);
            --new-chat-btn-text: var(--md-sys-color-on-primary-container);
            --new-chat-btn-hover-bg: color-mix(in srgb, var(--md-sys-color-primary-container), var(--md-sys-color-on-primary-container) 8%);
            --history-item-hover-bg: rgba(var(--md-sys-color-on-surface-rgb), 0.08);
            --history-item-active-bg: var(--md-sys-color-secondary-container);
            --history-item-active-text: var(--md-sys-color-on-secondary-container);
            --user-msg-bg: var(--md-sys-color-primary);
            --user-msg-text: var(--md-sys-color-on-primary);
            --ai-msg-bg: var(--md-sys-color-surface-container-high);
            --ai-msg-text: var(--md-sys-color-on-surface);
            --accent-color: var(--md-sys-color-primary);
            --error-color: var(--md-sys-color-error);
            --success-color: var(--md-sys-color-success);
            --context-menu-bg: var(--md-sys-color-surface-container-high);
            --context-menu-shadow: var(--md-sys-elevation-level-2);
            --context-menu-hover-bg: rgba(var(--md-sys-color-on-surface-rgb), 0.08);
            --modal-overlay-bg: rgba(0, 0, 0, 0.4); 
            --modal-bg: var(--md-sys-color-surface-container-highest);
            --modal-cancel-btn-bg: transparent;
            --modal-confirm-btn-text: var(--md-sys-color-on-primary);
            --modal-cancel-btn-text: var(--md-sys-color-primary);
            --modal-error-bg: var(--md-sys-color-error-container);
            --modal-error-text: var(--md-sys-color-on-error-container);
            --modal-error-btn-bg: var(--md-sys-color-error);
            --modal-error-btn-text: var(--md-sys-color-on-error);
        }

        @media (prefers-color-scheme: dark) {
        :root {
            /* M3 Elevation Tokens (Dark) */
            --md-sys-elevation-level-1: 0px 1px 3px 1px rgba(0,0,0,0.4), 0px 1px 2px 0px rgba(0,0,0,0.5);
            --md-sys-elevation-level-2: 0px 2px 6px 2px rgba(0,0,0,0.4), 0px 1px 2px 0px rgba(0,0,0,0.5);
            --md-sys-elevation-level-3: 0px 4px 8px 3px rgba(0,0,0,0.4), 0px 1px 3px 0px rgba(0,0,0,0.5);

            /* M3 Dark Theme Colors */
            --md-sys-color-primary-rgb: 189, 194, 255;
            --md-sys-color-primary: #bdc2ff;
            --md-sys-color-on-primary: #1932b5;
            --md-sys-color-primary-container: #324bbd;
            --md-sys-color-on-primary-container: #e0e0ff;
            --md-sys-color-secondary-container: #454459;
            --md-sys-color-on-secondary-container-rgb: 226, 224, 249;
            --md-sys-color-on-secondary-container: #e2e0f9;
            --md-sys-color-tertiary: #e7b9d5;
            --md-sys-color-on-tertiary: #46263b;
            --md-sys-color-surface: #141318;
            --md-sys-color-surface-container: #201f24;
            --md-sys-color-surface-container-high: #2b292f;
            --md-sys-color-surface-container-highest: #36343a;
            --md-sys-color-on-surface-rgb: 229, 225, 230;
            --md-sys-color-on-surface: #e5e1e6;
            --md-sys-color-on-surface-variant: #c9c5d0;
            --md-sys-color-outline: #949099;
            --md-sys-color-outline-variant: #48454e;
            --md-sys-color-error: #ffb4ab;
            --md-sys-color-on-error: #690005;
            --md-sys-color-error-container: #93000a;
            --md-sys-color-on-error-container: #ffdad6;
            --md-sys-color-success: #a0d38c;
        }

        * {
            scrollbar-width: thin;
            scrollbar-color: var(--md-sys-color-surface-container-highest) var(--md-sys-color-surface);
        }

        @supports not (scrollbar-width: thin) {
            ::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }
            ::-webkit-scrollbar-track {
                background: var(--md-sys-color-surface);
            }
            ::-webkit-scrollbar-thumb {
                background-color: var(--md-sys-color-surface-container-highest);
                border-radius: 4px;
                border: 2px solid var(--md-sys-color-surface);
            }
            ::-webkit-scrollbar-thumb:hover {
                background-color: var(--md-sys-color-on-surface-variant);
            }
        }
    }

        html, body { position: relative; height: 100%; width: 100%; overflow: hidden; overscroll-behavior: none; }
        body { font-family: var(--font-family); background-color: var(--sidebar-bg); margin: 0; color: var(--text-primary); display: flex; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        #app-wrapper { display: flex; width: 100%; height: 100%; }
        #sidebar { background-color: var(--sidebar-bg); color: var(--sidebar-text); width: 260px; display: flex; flex-direction: column; flex-shrink: 0; transition: width 0.3s var(--md-animation-standard); padding: 12px; }
        .sidebar-header { padding-bottom: 12px; display: flex; align-items: center; transition: flex-direction 0.3s var(--md-animation-standard); }
        #new-chat-button { flex-grow: 1; height: 56px; padding: 0 24px; border: none; background-color: var(--new-chat-btn-bg); color: var(--new-chat-btn-text); border-radius: var(--md-sys-shape-corner-l); cursor: pointer; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9em; font-weight: 600; display: flex; align-items: center; transition: background-color 0.2s var(--md-animation-standard); }
        #new-chat-button:hover { background-color: var(--new-chat-btn-hover-bg); }
        #new-chat-button .icon { font-size: 1.8em; margin-right: 16px; font-weight: 400; }
        #sidebar-toggle-button { margin-left: 10px; padding: 0; width: 40px; height: 40px; border: none; background-color: transparent; color: var(--text-secondary); border-radius: 50%; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all 0.2s var(--md-animation-standard); font-size: 1.5em; }
        #sidebar-toggle-button:hover { background-color: var(--history-item-hover-bg); }
        #history-list-container { list-style: none; margin: 0; padding: 0 4px; overflow-y: auto; flex-grow: 1; }
        .history-group-header { font-size: 0.8em; color: var(--sidebar-group-text); padding: 16px 16px 4px; font-weight: 500; }
        .history-item { display: flex; align-items: center; height: 48px; padding: 0 16px; border-radius: var(--md-sys-shape-corner-full); cursor: pointer; margin-bottom: 2px; font-size: 0.9em; color: var(--sidebar-text); transition: background-color 0.2s var(--md-animation-standard), color 0.2s var(--md-animation-standard); -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none; }
        .history-item > span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0; 
        }
        .history-item:hover { background-color: var(--history-item-hover-bg); }
        .history-item.active { background-color: var(--history-item-active-bg); color: var(--history-item-active-text); font-weight: 600; }
        #app-wrapper.sidebar-collapsed #sidebar { width: 80px; padding: 12px 16px; }
        #app-wrapper.sidebar-collapsed .sidebar-header { flex-direction: column-reverse; align-items: center; gap: 16px; }
        #app-wrapper.sidebar-collapsed #new-chat-button { flex-grow: 0; justify-content: center; width: 48px; height: 48px; padding: 0; border-radius: var(--md-sys-shape-corner-l); }
        #app-wrapper.sidebar-collapsed #new-chat-button span:not(.icon) { display: none; }
        #app-wrapper.sidebar-collapsed #new-chat-button .icon { margin: 0; font-size: 1.8em; }
        #app-wrapper.sidebar-collapsed #sidebar-toggle-button { margin: 0; }
        #app-wrapper.sidebar-collapsed #history-list-container { display: none; }
        
        #context-menu { position: absolute; z-index: 1000; background-color: var(--context-menu-bg); border-radius: var(--md-sys-shape-corner-m); padding: 8px; box-shadow: var(--context-menu-shadow); min-width: 200px; opacity: 0; visibility: hidden; transform-origin: top left; transform: scale(0.95) translateY(-8px); transition: opacity 0.15s var(--md-animation-emphasized), transform 0.15s var(--md-animation-emphasized), visibility 0.15s; }
        #context-menu.show { opacity: 1; visibility: visible; transform: scale(1) translateY(0); }
        .context-menu-item { display: flex; align-items: center; padding: 12px 16px; border-radius: var(--md-sys-shape-corner-s); cursor: pointer; color: var(--text-primary); transition: background-color 0.2s var(--md-animation-standard); font-size: 1em; }
        .context-menu-item:hover { background-color: var(--context-menu-hover-bg); }
        .context-menu-item.delete { color: var(--error-color); }
        .context-menu-icon { margin-right: 16px; width: 20px; height: 20px; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-overlay-bg); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.2s var(--md-animation-standard), visibility 0.2s; backdrop-filter: blur(2px); -webkit-backdrop-filter: blur(2px); }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-dialog { background-color: var(--modal-bg); padding: 24px; border-radius: var(--md-sys-shape-corner-xl); box-shadow: var(--context-menu-shadow); width: 90%; max-width: 420px; transform: scale(0.95); transition: transform 0.2s var(--md-animation-standard); }
        .modal-overlay.show .modal-dialog { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .modal-header h2 { margin: 0; font-size: 1.5em; font-weight: 500; color: var(--text-primary); }
        .modal-header .close-btn { background: none; border: none; font-size: 1.8em; color: var(--text-secondary); cursor: pointer; padding: 0; line-height: 1; opacity: 0.7; }
        .modal-body p { margin: 0 0 24px 0; color: var(--text-secondary); font-size: 1em; line-height: 1.5; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 8px; }
        .modal-footer button { padding: 10px 24px; border-radius: var(--md-sys-shape-corner-full); border: none; cursor: pointer; font-weight: 600; font-size: 0.9em; transition: opacity 0.2s var(--md-animation-standard), background-color 0.2s var(--md-animation-standard); }
        .modal-footer button:hover:not(:disabled) { opacity: 0.9; }
        .modal-footer .cancel-btn { background-color: var(--modal-cancel-btn-bg); color: var(--modal-cancel-btn-text); }
        .modal-footer .cancel-btn:hover { background-color: rgba(var(--md-sys-color-primary-rgb), 0.08); }
        .modal-footer .confirm-btn { background-color: var(--accent-color); color: var(--modal-confirm-btn-text); }
        #confirm-modal.is-delete .modal-footer .confirm-btn { background-color: var(--md-sys-color-error); color: var(--md-sys-color-on-error); }
        
        #error-modal .modal-dialog { background-color: var(--modal-error-bg); color: var(--modal-error-text); }
        #error-modal .modal-dialog h2, #error-modal .modal-dialog p { color: var(--modal-error-text); }
        .modal-footer .confirm-btn.error { background-color: var(--modal-error-btn-bg); color: var(--modal-error-btn-text); }

        /* Browser Warning Dialog Styles */
        #browser-warning-modal .modal-dialog { background-color: var(--modal-error-bg); color: var(--modal-error-text); }
        #browser-warning-modal .modal-dialog h2, #browser-warning-modal .modal-body > p { color: var(--modal-error-text); }
        #browser-warning-message { white-space: pre-wrap; text-align: left; }
        .browser-links-container { margin: 24px 0 16px; padding: 16px; background-color: rgba(0, 0, 0, 0.05); border-radius: var(--md-sys-shape-corner-s); }
        .browser-links-container > p { text-align: center; color: var(--modal-error-text); margin: 0 0 12px 0; }
        .browser-links { display: flex; justify-content: space-around; align-items: flex-start; gap: 16px; margin-top: 8px; }
        .browser-link-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: var(--modal-error-text); border-radius: var(--md-sys-shape-corner-s); padding: 8px; transition: background-color 0.2s; flex: 1; max-width: 100px; }
        .browser-link-item:hover { background-color: rgba(0, 0, 0, 0.1); }
        .browser-link-item svg { width: 44px; height: 44px; }
        .browser-link-item span { margin-top: 8px; font-size: 0.85em; font-weight: 500; }
        #browser-warning-modal .modal-footer .confirm-btn { background-color: var(--modal-error-btn-bg); color: var(--modal-error-btn-text); }

        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .checkbox-wrapper { margin-top: 20px; }
        .checkbox-container { display: flex; align-items: center; cursor: pointer; user-select: none; font-size: 15px; color: var(--text-secondary); }
        .checkbox-visual { width: 18px; height: 18px; border: 2px solid var(--md-sys-color-on-error-container); border-radius: var(--md-sys-shape-corner-xs); margin-right: 12px; display: flex; justify-content: center; align-items: center; background-color: transparent; transition: background-color 0.2s var(--md-animation-standard), border-color 0.2s var(--md-animation-standard); }
        .checkbox-visual svg { width: 14px; height: 14px; stroke: var(--md-sys-color-on-error); stroke-width: 2.5; fill: none; stroke-linecap: round; stroke-linejoin: round; transform: scale(0); opacity: 0; transition: transform 0.3s var(--md-animation-emphasized), opacity 0.2s var(--md-animation-standard); }
        .visually-hidden:checked + .checkbox-container .checkbox-visual { background-color: var(--md-sys-color-error); border-color: var(--md-sys-color-error); }
        .visually-hidden:checked + .checkbox-container .checkbox-visual svg { transform: scale(1); opacity: 1; }
        .visually-hidden:focus-visible + .checkbox-container .checkbox-visual { box-shadow: 0 0 0 3px rgba(var(--md-sys-color-primary-rgb), 0.4); }
        #browser-warning-modal .checkbox-container { color: var(--modal-error-text); }
        
        #game-container { flex-grow: 1; background-color: var(--main-bg); display: flex; flex-direction: column; overflow: hidden; height: 100%; border-radius: var(--md-sys-shape-corner-l) 0 0 var(--md-sys-shape-corner-l); }
        #chat-window, header, #input-area { transition: background-color 0.2s var(--md-animation-standard), border-color 0.2s var(--md-animation-standard); }

        header { 
            padding: 12px 20px; 
            border-bottom: 1px solid var(--border-color); 
            background-color: var(--main-bg); 
            flex-shrink: 0; 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            position: relative; 
            height: 64px; 
        }
        #mobile-menu-toggle { 
            display: none;
            background: none; 
            border: none; 
            font-size: 1.5em; 
            cursor: pointer; 
            color: var(--text-secondary); 
        }
        .title-container { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            position: relative;
            white-space: nowrap;
        }
        .title-container h1 { margin: 0; font-size: 1.4em; font-weight: 500; color: var(--text-primary); }
        .header-actions { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }

        .header-action-btn { padding: 0; width: 40px; height: 40px; border: none; background-color: transparent; color: var(--text-secondary); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s var(--md-animation-standard); }
        .header-action-btn:hover { background-color: var(--history-item-hover-bg); }
        .header-action-btn svg { width: 24px; height: 24px; fill: currentColor; }
        
        .date-picker-trigger { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 6px 16px; background-color: transparent; border: 1px solid var(--md-sys-color-outline); border-radius: var(--md-sys-shape-corner-full); font-size: 0.9em; font-weight: 600; color: var(--md-sys-color-on-surface-variant); cursor: pointer; transition: all 0.2s var(--md-animation-standard); }
        .date-picker-trigger:hover { background-color: var(--history-item-hover-bg); }
        .date-picker-trigger svg { width: 20px; height: 20px; fill: currentColor; flex-shrink: 0; }
        
        #chat-window { flex: 1; padding: 20px; overflow-y: auto; background-color: var(--chat-window-bg); scroll-behavior: smooth; -webkit-overflow-scrolling: touch; min-height: 0; display: flex; flex-direction: column; gap: 12px; }
        .message { display: flex; max-width: 85%; align-self: flex-start; animation: fadeIn 0.5s var(--md-animation-standard); }
        .message-bubble { padding: 12px 18px; border-radius: var(--md-sys-shape-corner-l); word-wrap: break-word; line-height: 1.5; font-size: 1em; }
        .ai-message .message-bubble { background-color: var(--ai-msg-bg); color: var(--ai-msg-text); border-bottom-left-radius: var(--md-sys-shape-corner-xs); }
        .user-message { align-self: flex-end; } .user-message .message-bubble { background-color: var(--user-msg-bg); color: var(--user-msg-text); border-bottom-right-radius: var(--md-sys-shape-corner-xs); }
        .system-message { text-align: center; margin: 15px 0; font-size: 0.9em; color: var(--text-secondary); align-self: center; }
        .system-message.success { color: var(--success-color); font-weight: bold; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #input-area { display: flex; padding: 12px 16px; border-top: 1px solid var(--border-color); background-color: var(--main-bg); flex-shrink: 0; align-items: center; gap: 12px; }
        #user-input { flex-grow: 1; border: 1px solid var(--md-sys-color-outline); border-radius: var(--md-sys-shape-corner-full); padding: 14px 20px; font-size: 16px; outline: none; transition: border-color 0.3s var(--md-animation-standard), box-shadow 0.3s var(--md-animation-standard); background-color: transparent; color: var(--text-primary); height: 52px; }
        #user-input::placeholder { color: var(--text-secondary); }
        #user-input:focus { border-color: var(--accent-color); box-shadow: 0 0 0 1px var(--accent-color); }
        #user-input:disabled { background-color: var(--ai-msg-bg); cursor: not-allowed; opacity: 0.7; }
        #send-button { width: 52px; height: 52px; border: none; background-color: var(--accent-color); color: var(--md-sys-color-on-primary); border-radius: 50%; cursor: pointer; transition: background-color 0.3s var(--md-animation-standard), opacity 0.3s var(--md-animation-standard), transform 0.2s var(--md-animation-emphasized); flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        #send-button svg { width: 24px; height: 24px; fill: currentColor; }
        #send-button:hover:not(:disabled) { box-shadow: var(--md-sys-elevation-level-1); }
        #send-button:active:not(:disabled) { transform: scale(0.95); }
        #send-button:disabled { background-color: var(--accent-color); opacity: 0.4; cursor: not-allowed; }
        #sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 999; }
        .custom-select-wrapper { position: relative; display: inline-block; user-select: none; }
        .select-selected { color: var(--text-primary); font-size: 1.4em; font-weight: 500; cursor: pointer; display: flex; align-items: center; padding: 4px 8px; border-radius: var(--md-sys-shape-corner-m); transition: background-color 0.2s var(--md-animation-standard); }
        .select-selected:hover { background-color: var(--ai-msg-bg); }
        .select-arrow { margin-left: 6px; width: 24px; height: 24px; fill: currentColor; transition: transform 0.3s var(--md-animation-emphasized); }
        .select-selected.select-arrow-active .select-arrow { transform: rotate(180deg); }
        .select-items { list-style: none; padding: 8px; margin: 0; position: absolute; top: calc(100% + 5px); left: 50%; transform: translateX(-50%); background-color: var(--context-menu-bg); border-radius: var(--md-sys-shape-corner-m); box-shadow: var(--context-menu-shadow); min-width: 120px; text-align: center; z-index: 1101; opacity: 0; visibility: hidden; transition: opacity 0.1s var(--md-animation-standard), transform 0.1s var(--md-animation-standard), visibility 0.1s; }
        .select-items.show { opacity: 1; visibility: visible; }
        .select-item { color: var(--text-primary); padding: 12px 16px; border-radius: var(--md-sys-shape-corner-s); cursor: pointer; transition: background-color 0.2s var(--md-animation-standard); font-size: 1.1em; }
        .select-item:hover { background-color: var(--context-menu-hover-bg); }

        #date-picker-popover {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            z-index: 1100;
            background-color: var(--md-sys-color-surface-container-high);
            border-radius: var(--md-sys-shape-corner-xl);
            padding: 12px 16px 16px;
            box-shadow: var(--md-sys-elevation-level-3);
            width: 340px;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: none; /* Important for pointer events */
            opacity: 0;
            visibility: hidden;
            transform-origin: top right;
            transform: scale(0.95);
            transition: opacity 0.2s var(--md-animation-emphasized), transform 0.2s var(--md-animation-emphasized), visibility 0.2s;
        }

        #date-picker-popover.show {
            opacity: 1;
            visibility: visible;
            transform: scale(1);
        }

        .dp-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 4px 0;
            color: var(--md-sys-color-on-surface);
            height: 40px;
        }

        .dp-title-wrapper {
            position: relative;
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 600;
            font-size: 1.1em;
            gap: 0.1em;
        }

        .digit-group {
            display: flex;
        }

        .digit-slot {
            height: 1.2em;
            line-height: 1.2em;
            overflow: hidden;
            position: relative;
            transition: width 0.35s cubic-bezier(0.25, 1, 0.5, 1);
            width: 0.6em;
            text-align: center;
        }

        .digit-slot.is-placeholder {
            width: 0;
        }

        .digit-reel {
            transition: transform 0.35s cubic-bezier(0.25, 1, 0.5, 1);
        }

        .dp-nav-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            width: 40px;
            height: 40px;
            cursor: pointer;
            color: var(--md-sys-color-on-surface);
            font-size: 20px;
            border-radius: 50%;
            transition: background-color 0.2s;
            touch-action: manipulation;
        }

        .dp-nav-btn:hover:not(:disabled) {
            background-color: var(--history-item-hover-bg);
        }
        
        .dp-nav-btn.disabled {
            opacity: 0.4;
            pointer-events: none;
            cursor: not-allowed;
        }

        .dp-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            padding-bottom: 8px;
            justify-items: center;
        }

        .dp-weekday {
            text-align: center;
            font-size: 0.85em;
            color: var(--md-sys-color-on-surface-variant);
            font-weight: 500;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .dp-grid-wrapper {
            position: relative;
            overflow: hidden;
            height: 260px;
        }

        .dp-track {
            display: flex;
            height: 100%;
            will-change: transform;
        }

        .dp-grid {
            flex: 0 0 100%;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            justify-items: center;
            align-content: flex-start;
        }
        
        .dp-day {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 0.9em;
            border: 2px solid transparent;
            color: var(--md-sys-color-on-surface);
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        
        .dp-day.other-month {
            color: var(--md-sys-color-on-surface-variant);
        }
        
        .dp-day.available {
            cursor: pointer;
        }

        .dp-day.available:hover {
            background-color: var(--history-item-hover-bg);
        }
        
        .dp-day.disabled {
            pointer-events: none;
            color: var(--md-sys-color-outline);
        }

        .dp-day.today {
            border-color: var(--md-sys-color-outline);
        }

        .dp-day.selected, .dp-day.available.selected:hover {
            background-color: var(--accent-color);
            color: var(--md-sys-color-on-primary) !important; /* important to override other states */
            border-color: var(--accent-color);
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            #sidebar { position: fixed; top: 0; left: -260px; height: 100%; z-index: 1000; transition: left 0.3s var(--md-animation-standard); border-right: none; }
            body.sidebar-open #sidebar { left: 0; }
            body.sidebar-open #sidebar-overlay { display: block; }
            #sidebar-toggle-button { display: none; }
            
            #mobile-menu-toggle { display: block; }

            #game-container { border-radius: 0; }
            #app-wrapper.sidebar-collapsed #sidebar { width: 260px; padding: 12px; }
            #app-wrapper.sidebar-collapsed .sidebar-header { flex-direction: row; align-items: center; gap: 0; }
            #app-wrapper.sidebar-collapsed #new-chat-button { width: auto; height: 56px; padding: 0 24px; flex-grow: 1; border-radius: var(--md-sys-shape-corner-l); }
            #app-wrapper.sidebar-collapsed #new-chat-button span:not(.icon) { display: inline-block; }
            #app-wrapper.sidebar-collapsed #new-chat-button .icon { margin-right: 16px; }
            #app-wrapper.sidebar-collapsed #sidebar-toggle-button { display: none; }
            #app-wrapper.sidebar-collapsed #history-list-container { display: block; }
            header { padding-top: calc(10px + env(safe-area-inset-top)); }
            #input-area { padding-bottom: calc(10px + env(safe-area-inset-bottom)); }

            .date-picker-trigger {
                padding: 0;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                border-width: 1px;
            }
            .date-picker-trigger #daily-puzzle-label {
                display: none;
            }
            .date-picker-trigger svg {
                margin: 0;
            }

            #date-picker-popover { 
                left: auto;
                right: 15px;
                transform: scale(0.95); 
                transform-origin: top right;
                width: calc(100vw - 30px); 
                max-width: 340px; 
            }
            #date-picker-popover.show { 
                transform: scale(1);
            }
        }
    </style>
    <!--<![endif]-->
</head>
<body>
    <!-- 主应用界面 -->
    <div id="app-wrapper">
        <aside id="sidebar">
            <div class="sidebar-header">
                <button id="new-chat-button"><span class="icon">＋</span><span>开启新对话</span></button>
                <button id="sidebar-toggle-button" title="收起/展开侧边栏">‹</button>
            </div>
            <div id="history-list-container"></div>
        </aside>
        <div id="sidebar-overlay"></div>
        <main id="game-container">
            <header>
                <button id="mobile-menu-toggle">☰</button>
                <div class="title-container">
                    <h1>猜盐 - </h1>
                    <div id="game-mode-dropdown" class="custom-select-wrapper"></div>
                </div>
                <div class="header-actions">
                    <button id="daily-puzzle-button" class="date-picker-trigger" title="选择往日谜题" style="display: none;">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21 8.5v9.25A3.25 3.25 0 0 1 17.75 21H6.25A3.25 3.25 0 0 1 3 17.75V8.5h18ZM7.25 15a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5ZM12 15a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5Zm-4.75-4.5a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5Zm4.75 0a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5Zm4.75 0a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5Zm1-7.5A3.25 3.25 0 0 1 21 6.25V7H3v-.75A3.25 3.25 0 0 1 6.25 3h11.5Z" fill="currentColor"/></svg>
                        <span id="daily-puzzle-label">选择日期</span>
                    </button>
                    <div id="date-picker-popover">
                        <div class="dp-header">
                          <button id="dp-prev" class="dp-nav-btn" title="上个月">&lt;</button>
                          <div class="dp-title-wrapper"></div>
                          <button id="dp-next" class="dp-nav-btn" title="下个月">&gt;</button>
                        </div>
                        <div class="dp-weekdays"></div>
                        <div class="dp-grid-wrapper">
                          <div class="dp-track"></div>
                        </div>
                    </div>
                    <button id="export-button" class="header-action-btn" title="导出历史记录">
                        <svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M6.25 4.75a1.5 1.5 0 0 0-1.5 1.5v11.5a1.5 1.5 0 0 0 1.5 1.5h11.5a1.5 1.5 0 0 0 1.5-1.5v-4a1 1 0 1 1 2 0v4a3.5 3.5 0 0 1-3.5 3.5H6.25a3.5 3.5 0 0 1-3.5-3.5V6.25a3.5 3.5 0 0 1 3.5-3.5h4a1 1 0 1 1 0 2h-4Zm6.5-1a1 1 0 0 1 1-1h6.5a1 1 0 0 1 1 1v6.5a1 1 0 1 1-2 0V6.164l-4.793 4.793a1 1 0 1 1-1.414-1.414l4.793-4.793H13.75a1 1 0 0 1-1-1Z"/></svg>
                    </button>
                    <button id="import-button" class="header-action-btn" title="导入历史记录">
                        <svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21.25 4.5a.75.75 0 0 1 .743.648L22 5.25v13.5a.75.75 0 0 1-1.493.102l-.007-.102V5.25a.75.75 0 0 1 .75-.75Zm-9.04 1.887.083-.094a1 1 0 0 1 1.32-.083l.094.083 4.997 4.998a1 1 0 0 1 .083 1.32l-.083.093-4.996 5.004a1 1 0 0 1-1.499-1.32l.083-.094L15.581 13H3a1 1 0 0 1-.993-.883L2 12a1 1 0 0 1 .883-.993L3 11h12.584l-3.291-3.293a1 1 0 0 1-.083-1.32l.083-.094-.083.094Z"/></svg>
                    </button>
                </div>
            </header>
            <div id="chat-window"></div>
            <div id="input-area">
                <input type="text" id="user-input" placeholder="请输入你的提问或诊断..." disabled>
                <button id="send-button" disabled title="发送">
                    <svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m12.815 12.197-7.532 1.256a.5.5 0 0 0-.386.318L2.3 20.728c-.248.64.421 1.25 1.035.943l18-9a.75.75 0 0 0 0-1.342l-18-9c-.614-.307-1.283.304-1.035.943l2.598 6.957a.5.5 0 0 0 .386.319l7.532 1.255a.2.2 0 0 1 0 .394Z"/></svg>
                </button>
            </div>
        </main>
    </div>

    <input type="file" id="import-file-input" accept=".json" style="display: none;">

    <div id="context-menu">
        <div class="context-menu-item" id="rename-option"><svg class="context-menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25-1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg><span>重命名</span></div>
        <div class="context-menu-item delete" id="delete-option"><svg class="context-menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.58.22-2.365.468a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193v-.443A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25-.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" /></svg><span>删除</span></div>
    </div>
    
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal-dialog"><div class="modal-header"><h2 id="confirm-modal-title">永久删除对话</h2><button class="close-btn" id="confirm-modal-close-btn">×</button></div><div class="modal-body"><p id="confirm-modal-message">删除后，该对话将不可恢复。确认删除吗？</p></div><div class="modal-footer"><button class="cancel-btn" id="confirm-modal-cancel-btn">取消</button><button class="confirm-btn" id="confirm-modal-confirm-btn">删除</button></div></div>
    </div>

    <div class="modal-overlay" id="info-modal">
        <div class="modal-dialog"><div class="modal-header"><h2 id="info-modal-title">提示</h2><button class="close-btn" id="info-modal-close-btn">×</button></div><div class="modal-body"><p id="info-modal-message"></p></div><div class="modal-footer"><button class="confirm-btn import" id="info-modal-ok-btn">好的</button></div></div>
    </div>

    <div class="modal-overlay" id="error-modal">
        <div class="modal-dialog"><div class="modal-header"><h2 id="error-modal-title">错误</h2><button class="close-btn" id="error-modal-close-btn">×</button></div><div class="modal-body"><p id="error-modal-message"></p></div><div class="modal-footer"><button class="confirm-btn error" id="error-modal-ok-btn">好的</button></div></div>
    </div>
    
    <div class="modal-overlay" id="browser-warning-modal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h2 id="browser-warning-title">浏览器兼容性提示</h2>
                <button class="close-btn" id="browser-warning-close-btn">×</button>
            </div>
            <div class="modal-body">
                <p id="browser-warning-message"></p>
                
                <div class="browser-links-container">
                    <p>为了获得最佳体验，我们推荐您使用以下现代浏览器：</p>
                    <div class="browser-links">
                        <a href="https://www.google.cn/chrome/" target="_blank" rel="noopener noreferrer" class="browser-link-item">
                            <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><title>Google Chrome</title><path d="M12 0C8.21 0 4.831 1.757 2.632 4.501l3.953 6.848A5.454 5.454 0 0 1 12 6.545h10.691A12 12 0 0 0 12 0zM1.931 5.47A11.943 11.943 0 0 0 0 12c0 6.012 4.42 10.991 10.189 11.864l3.953-6.847a5.45 5.45 0 0 1-6.865-2.29zm13.342 2.166a5.446 5.446 0 0 1 1.45 7.09l.002.001h-.002l-5.344 9.257c.206.01.413.016.621.016 6.627 0 12-5.373 12-12 0-1.54-.29-3.011-.818-4.364zM12 16.364a4.364 4.364 0 1 1 0-8.728 4.364 4.364 0 0 1 0 8.728Z"/></svg>
                            <span>Chrome</span>
                        </a>
                        <a href="https://www.microsoft.com/edge/download" target="_blank" rel="noopener noreferrer" class="browser-link-item">
                            <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><title>Microsoft Edge</title><path d="M21.86 17.86q.14 0 .25.12.1.13.1.25t-.11.33l-.32.46-.43.53-.44.5q-.21.25-.38.42l-.22.23q-.58.53-1.34 1.04-.76.51-1.6.91-.86.4-1.74.64t-1.67.24q-.9 0-1.69-.28-.8-.28-1.48-.78-.68-.5-1.22-1.17-.53-.66-.92-1.44-.38-.77-.58-1.6-.2-.83-.2-1.67 0-1 .32-1.96.33-.97.87-1.8.14.95.55 1.77.41.82 1.02 1.5.6.68 1.38 1.21.78.54 1.64.9.86.36 1.77.56.92.2 1.8.2 1.12 0 2.18-.24 1.06-.23 2.06-.72l.2-.1.2-.05zm-15.5-1.27q0 1.1.27 2.15.27 1.06.78 2.03.51.96 1.24 1.77.74.82 1.66 1.4-1.47-.2-2.8-.74-1.33-.55-2.48-1.37-1.15-.83-2.08-1.9-.92-1.07-1.58-2.33T.36 14.94Q0 13.54 0 12.06q0-.81.32-1.49.31-.68.83-1.23.53-.55 1.2-.96.66-.4 1.35-.66.74-.27 1.5-.39.78-.12 1.55-.12.7 0 1.42.1.72.12 1.4.35.68.23 1.32.57.63.35 1.16.83-.35 0-.7.07-.33.07-.65.23v-.02q-.63.28-1.2.74-.57.46-1.05 1.04-.48.58-.87 1.26-.38.67-.65 1.39-.27.71-.42 1.44-.15.72-.15 1.38zM11.96.06q1.7 0 3.33.39 1.63.38 3.07 1.15 1.43.77 2.62 1.93 1.18 1.16 1.98 2.7.49.94.76 1.96.28 1 .28 2.08 0 .89-.23 1.7-.24.8-.69 1.48-.45.68-1.1 1.22-.64.53-1.45.88-.54.24-1.11.36-.58.13-1.16.13-.42 0-.97-.03-.54-.03-1.1-.12-.55-.1-1.05-.28-.5-.19-.84-.5-.12-.09-.23-.24-.1-.16-.1-.33 0-.15.16-.35.16-.2.35-.5.2-.28.36-.68.16-.4.16-.95 0-1.06-.4-1.96-.4-.91-1.06-1.64-.66-.74-1.52-1.28-.86-.55-1.79-.89-.84-.3-1.72-.44-.87-.14-1.76-.14-1.55 0-3.06.45T.94 7.55q.71-1.74 1.81-3.13 1.1-1.38 2.52-2.35Q6.68 1.1 8.37.58q1.7-.52 3.58-.52Z"/></svg>
                            <span>Edge</span>
                        </a>
                        <a href="https://www.mozilla.org/firefox/new/" target="_blank" rel="noopener noreferrer" class="browser-link-item">
                            <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><title>Mozilla Firefox</title><path d="M8.824 7.287c.008 0 .004 0 0 0zm-2.8-1.4c.006 0 .003 0 0 0zm16.754 2.161c-.505-1.215-1.53-2.528-2.333-2.943.654 1.283 1.033 2.57 1.177 3.53l.002.02c-1.314-3.278-3.544-4.6-5.366-7.477-.091-.147-.184-.292-.273-.446a3.545 3.545 0 01-.13-.24 2.118 2.118 0 01-.172-.46.03.03 0 00-.027-.03.038.038 0 00-.021 0l-.006.001a.037.037 0 00-.01.005L15.624 0c-2.585 1.515-3.657 4.168-3.932 5.856a6.197 6.197 0 00-2.305.587.297.297 0 00-.147.37c.057.162.24.24.396.17a5.622 5.622 0 012.008-.523l.067-.005a5.847 5.847 0 011.957.222l.095.03a5.816 5.816 0 01.616.228c.08.036.16.073.238.112l.107.055a5.835 5.835 0 01.368.211 5.953 5.953 0 012.034 2.104c-.62-.437-1.733-.868-2.803-.681 4.183 2.09 3.06 9.292-2.737 9.02a5.164 5.164 0 01-1.513-.292 4.42 4.42 0 01-.538-.232c-1.42-.735-2.593-2.121-2.74-3.806 0 0 .537-2 3.845-2 .357 0 1.38-.998 1.398-1.287-.005-.095-2.029-.9-2.817-1.677-.422-.416-.622-.616-.8-.767a3.47 3.47 0 00-.301-.227 5.388 5.388 0 01-.032-2.842c-1.195.544-2.124 1.403-2.8 2.163h-.006c-.46-.584-.428-2.51-.402-2.913-.006-.025-.343.176-.389.206-.406.29-.787.616-1.136.974-.397.403-.76.839-1.085 1.303a9.816 9.816 0 00-1.562 3.52c-.003.013-.11.487-.19 1.073-.013.09-.026.181-.037.272a7.8 7.8 0 00-.069.667l-.002.034-.023.387-.001.06C.386 18.795 5.593 24 12.016 24c5.752 0 10.527-4.176 11.463-9.661.02-.149.035-.298.052-.448.232-1.994-.025-4.09-.753-5.844z"/></svg>
                            <span>Firefox</span>
                        </a>
                    </div>
                </div>

                <div class="checkbox-wrapper">
                    <input class="visually-hidden" type="checkbox" id="dont-show-again-checkbox">
                    <label class="checkbox-container" for="dont-show-again-checkbox">
                        <span class="checkbox-visual">
                            <svg viewBox="0 0 20 20">
                                <path d="M4 10 L8 14 L16 6"></path>
                            </svg>
                        </span>
                        <span>不再显示此警告</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="confirm-btn" id="browser-warning-ok-btn">好的</button>
            </div>
        </div>
    </div>

    <div id="unsupported-browser-message">
        <style>
            #unsupported-browser-message {
                display: none; /* 由JS改为 'block' 来显示 */
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 9999;
                background-color: #f8f9fa;
                font-family: 'Roboto', 'Helvetica Neue', Helvetica, Arial, 'Microsoft Yahei', sans-serif;
                overflow-y: auto;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
    
            #unsupported-browser-message .unsupported-content {
                width: 90%;
                max-width: 560px;
                /* 为IE8提供回退的固定外边距 */
                margin: 80px auto; 
                /* 为现代浏览器提供更优的动态外边距 */
                margin: 10vh auto; 
                background-color: #ffffff;
                border: 1px solid #dee2e6;
                padding: 40px;
                text-align: center;
                box-sizing: border-box; 
    
                /* IE9+及现代浏览器的美化 */
                border-radius: 24px; 
                border-color: transparent;
                box-shadow: 0 4px 8px 3px rgba(0,0,0,0.15), 0 1px 3px rgba(0,0,0,0.3);
            }
            
            #unsupported-browser-message .icon-container {
                width: 64px;
                height: 64px;
                margin: 0 auto 20px auto;
                background-color: #fce8e6;
                /* IE9+ 支持 */
                border-radius: 50%;
                /* 为IE9提供后备居中方案 */
                line-height: 64px;
                /* 为现代浏览器提供Flexbox居中方案 */
                display: flex;
                align-items: center;
                justify-content: center;
            }
    
            #unsupported-browser-message .icon-container svg {
                /* 配合line-height在IE9中生效 */
                vertical-align: middle; 
                width: 64px;
                height: 64px;
            }
    
            #unsupported-browser-message .unsupported-title {
                font-size: 24px;
                color: #1f1f1f;
                margin: 0 0 16px 0;
                font-weight: 500;
            }
    
            #unsupported-browser-message .unsupported-text {
                font-size: 16px;
                line-height: 1.75;
                color: #444746;
                margin: 0 0 32px 0;
            }
    
            #unsupported-browser-message .unsupported-actions {
                /* 兼容IE8的移除inline-block间隙的技巧 */
                font-size: 0;
            }
    
            #unsupported-browser-message .unsupported-actions a {
                display: inline-block;
                text-decoration: none;
                font-size: 15px; 
                font-weight: 500;
                padding: 10px 24px;
                margin: 8px;
                border: 1px solid transparent;
                /* IE9+ 支持 */
                border-radius: 999px;
                transition: background-color 0.2s cubic-bezier(0.3, 0, 0.5, 1), box-shadow 0.2s cubic-bezier(0.3, 0, 0.5, 1);
            }
    
            #unsupported-browser-message a.btn-chrome { color: #ffffff; background-color: #4285F4; }
            #unsupported-browser-message a.btn-edge { color: #0078d4; background-color: #f0f6ff; }
            #unsupported-browser-message a.btn-firefox { color: #1f1f1f; background-color: transparent; border-color: #747775; }
    
            /* 交互效果 */
            #unsupported-browser-message .unsupported-actions a:hover {
                box-shadow: 0 1px 2px 0 rgba(0,0,0,0.3), 0 1px 3px 1px rgba(0,0,0,0.15);
            }
            #unsupported-browser-message a.btn-chrome:hover { background-color: #387ae3; }
            #unsupported-browser-message a.btn-edge:hover { background-color: #e2eefe; }
            #unsupported-browser-message a.btn-firefox:hover { background-color: #f2f2f2; }
            #unsupported-browser-message .unsupported-actions a:active { box-shadow: none; }
        </style>
    
        <div class="unsupported-content">
            <!--[if gt IE 8]><!-->
            <div class="icon-container">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 8.25V12M12 15.75H12.01M21.75 12C21.75 17.3848 17.3848 21.75 12 21.75C6.61522 21.75 2.25 17.3848 2.25 12C2.25 6.61522 6.61522 2.25 12 2.25C17.3848 2.25 21.75 6.61522 21.75 12Z" stroke="#d93025" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
            </div>
            <!--<![endif]-->
    
            <h2 class="unsupported-title">您的浏览器需要更新</h2>
            <p class="unsupported-text">
                当前浏览器过旧，无法正常运行此应用。我们建议您升级到最新版本的现代浏览器，以享受更快的速度、更佳的视觉体验和更高的安全性。
            </p>
            <div class="unsupported-actions">
                <a href="https://www.google.cn/chrome/index.html" target="_blank" rel="noopener noreferrer" class="btn-chrome">
                    下载 Chrome
                </a>
                <a href="https://www.microsoft.com/edge/download" target="_blank" rel="noopener noreferrer" class="btn-edge">
                    下载 Edge
                </a>
                <a href="https://www.mozilla.org/firefox/new/" target="_blank" rel="noopener noreferrer" class="btn-firefox">
                    下载 Firefox
                </a>
            </div>
        </div>
    </div>

    <!-- 主应用脚本，包裹在模板中以防止旧浏览器解析崩溃 -->
    <script type="text/template" id="main-app-script">
        (function() {
            // --- DOM Elements ---
            const appWrapper = document.getElementById('app-wrapper');
            const sidebar = document.getElementById('sidebar');
            const sidebarToggleButton = document.getElementById('sidebar-toggle-button');
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const newChatButton = document.getElementById('new-chat-button');
            const historyListContainer = document.getElementById('history-list-container');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const gameModeDropdown = document.getElementById('game-mode-dropdown');
            const chatWindow = document.getElementById('chat-window');
            const userInput = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            const contextMenu = document.getElementById('context-menu');
            const renameOption = document.getElementById('rename-option');
            const deleteOption = document.getElementById('delete-option');
            const exportButton = document.getElementById('export-button');
            const importButton = document.getElementById('import-button');
            const importFileInput = document.getElementById('import-file-input');
            const dailyPuzzleButton = document.getElementById('daily-puzzle-button');
            const datePickerPopover = document.getElementById('date-picker-popover');
            const dpPrevBtn = document.getElementById('dp-prev');
            const dpNextBtn = document.getElementById('dp-next');
            const dpGridWrapper = datePickerPopover.querySelector('.dp-grid-wrapper');
            const confirmModal = document.getElementById('confirm-modal');
            const confirmModalTitle = document.getElementById('confirm-modal-title');
            const confirmModalMessage = document.getElementById('confirm-modal-message');
            const confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm-btn');
            const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn');
            const confirmModalCloseBtn = document.getElementById('confirm-modal-close-btn');
            const infoModal = document.getElementById('info-modal');
            const infoModalTitle = document.getElementById('info-modal-title');
            const infoModalMessage = document.getElementById('info-modal-message');
            const infoModalOkBtn = document.getElementById('info-modal-ok-btn');
            const infoModalCloseBtn = document.getElementById('info-modal-close-btn');
            const errorModal = document.getElementById('error-modal');
            const errorModalTitle = document.getElementById('error-modal-title');
            const errorModalMessage = document.getElementById('error-modal-message');
            const errorModalOkBtn = document.getElementById('error-modal-ok-btn');
            const errorModalCloseBtn = document.getElementById('error-modal-close-btn');
            const browserWarningModal = document.getElementById('browser-warning-modal');
            const browserWarningTitle = document.getElementById('browser-warning-title');
            const browserWarningMessage = document.getElementById('browser-warning-message');
            const browserWarningOkBtn = document.getElementById('browser-warning-ok-btn');
            const browserWarningCloseBtn = document.getElementById('browser-warning-close-btn');
            const dontShowAgainCheckbox = document.getElementById('dont-show-again-checkbox');

            // --- App State & Constants ---
            const LOGIN_URL = "/api/login";
            const USERNAME = "NewbieXvwu";
            const PASSWORD = "NewbieXvwu";
            
            const BASE_HEADERS = { 'Accept': 'application/json', 'Accept-Language': 'zh-CN,zh;q=0.9', 'Fun-Device': 'web', 'Dnt': '1' };
            
            const GAME_MODES = {
                disease: { title: '猜病', typeParam: 'guess_disease', apiUrl: '/api/v0/quiz/daily/guessDisease/sendMessage', storagePrefix: 'guessDisease_chat_', activeKey: 'activeGuessDiseaseChat', greeting: '你好，医生。', placeholder: '请输入你的提问或诊断…', successMessage: '🎉 恭喜你，诊断正确！游戏胜利！ 🎉' },
                crime: { title: '猜罪', typeParam: 'guess_crime', apiUrl: '/api/v0/quiz/daily/guessCrime/sendMessage', storagePrefix: 'guessCrime_chat_', activeKey: 'activeGuessCrimeChat', greeting: '你好，律师。', placeholder: '请输入你的提问或罪名猜测', successMessage: '🎉 恭喜你，猜罪正确！游戏胜利！ 🎉' }
            };

            let currentGameMode = 'disease';
            let chatHistory = [];
            let currentChatKey = null;
            let chatId = "";
            let isGameActive = false;
            let isMobile = false;
            try {
                if ('userAgentData' in navigator && typeof navigator.userAgentData === 'object') {
                    isMobile = navigator.userAgentData.mobile;
                }
                const maxTouchPoints = navigator.maxTouchPoints || navigator.msMaxTouchPoints || 0;
                const hasTouch = 'ontouchstart' in window || maxTouchPoints > 0;
                if (!hasTouch) {
                    isMobile = false;
                }
                else if (typeof window.orientation !== 'undefined') {
                    isMobile = true;
                }
                else if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobi/i.test(navigator.userAgent)) {
                    isMobile = true;
                }
            } catch (e) {
                isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobi/i.test(navigator.userAgent);
            }
            let contextMenuTarget = null;
            let dailySuccessCount = null;
            let currentVictoryRank = null;
            let targetDate = null;
            let activeDatesCache = {};
            let datePickerDragged = false;

            const DatePickerM3 = (() => {
                const popoverEl = document.getElementById('date-picker-popover');
                const track = popoverEl.querySelector('.dp-track');
                const wrapper = popoverEl.querySelector('.dp-grid-wrapper');
                const titleWrapper = popoverEl.querySelector('.dp-title-wrapper');
                const weekdaysContainer = popoverEl.querySelector('.dp-weekdays');
                const prevBtn = document.getElementById('dp-prev');
                const nextBtn = document.getElementById('dp-next');

                let displayDate = new Date();
                let selectedDate = null;
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                let panelIndex = 0;
                let currentTranslateX = 0;
                let animationFrameId = null;
                let activeDatesSet = new Set();
                let onDateSelectCallback = () => {};

                const easeOutCubic = t => 1 - Math.pow(1 - t, 3);

                if (!String.prototype.padStart) {
                    String.prototype.padStart = function padStart(targetLength, padString) {
                        targetLength = targetLength >> 0;
                        var str = String(this);
                        if (str.length >= targetLength) return str;
                        padString = String(typeof padString !== 'undefined' ? padString : ' ');
                        if (padString.length === 0) return str;
                        var fillLen = targetLength - str.length;
                        var padding = padString.repeat(Math.ceil(fillLen / padString.length));
                        return padding.slice(0, fillLen) + str;
                    };
                }

                function initWeekdays() {
                    const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                    weekdaysContainer.innerHTML = '';
                    weekdays.forEach(day => {
                        const dayEl = document.createElement('div');
                        dayEl.className = 'dp-weekday';
                        dayEl.textContent = day;
                        weekdaysContainer.appendChild(dayEl);
                    });
                }

                function buildGrid(date) {
                    const g = document.createElement('div');
                    g.className = 'dp-grid';
                    const year = date.getFullYear();
                    const month = date.getMonth();
                    const start = new Date(year, month, 1).getDay();
                    const days = new Date(year, month + 1, 0).getDate();
                    const prevMonthDate = new Date(year, month, 0);
                    const prevDays = prevMonthDate.getDate();

                    for (let i = 0; i < 42; i++) {
                        let day, cellDate;
                        const cell = document.createElement('div');
                        cell.className = 'dp-day';
                        let isCurrentMonth = false;

                        if (i < start) {
                            day = prevDays - start + i + 1;
                            cellDate = new Date(year, month - 1, day);
                            cell.classList.add('other-month');
                        } else if (i >= start + days) {
                            day = i - start - days + 1;
                            cellDate = new Date(year, month + 1, day);
                            cell.classList.add('other-month');
                        } else {
                            day = i - start + 1;
                            cellDate = new Date(year, month, day);
                            isCurrentMonth = true;
                        }

                        cell.textContent = day;
                        const dateApiString = getFormattedDate(cellDate);
                        cell.dataset.date = dateApiString;

                        if (activeDatesSet.has(dateApiString) && isCurrentMonth) {
                            cell.classList.add('available');
                            cell.addEventListener('click', () => {
                                if (datePickerDragged) return;
                                onDateSelectCallback(dateApiString.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'));
                                popoverEl.classList.remove('show');
                            });
                        } else {
                            cell.classList.add('disabled');
                        }

                        if (cellDate.getTime() === today.getTime()) cell.classList.add('today');
                        if (selectedDate && cellDate.getTime() === selectedDate.getTime()) cell.classList.add('selected');
                        g.appendChild(cell);
                    }
                    return g;
                }

                function updateAnimatedTitle(newDate, oldDate, direction) {
                    titleWrapper.innerHTML = '';
                    const newYear = String(newDate.getFullYear());
                    const oldYear = String(oldDate.getFullYear());
                    const newMonth = String(newDate.getMonth() + 1).padStart(2, ' ');
                    const oldMonth = String(oldDate.getMonth() + 1).padStart(2, ' ');
                    const reelsToAnimate = [];

                    const createDigitGroup = (newStr, oldStr) => {
                        const group = document.createElement('div');
                        group.className = 'digit-group';
                        for (let i = 0; i < newStr.length; i++) {
                            const slot = document.createElement('div');
                            slot.className = 'digit-slot';
                            const isInitiallyPlaceholder = direction === 0 ? (newStr[i] === ' ') : (oldStr[i] === ' ');
                            const isFinallyPlaceholder = newStr[i] === ' ';
                            if (isInitiallyPlaceholder) slot.classList.add('is-placeholder');

                            if (direction === 0 || newStr[i] === oldStr[i]) {
                                if (newStr[i] !== ' ') slot.textContent = newStr[i];
                            } else {
                                const reel = document.createElement('div');
                                reel.className = 'digit-reel';
                                const oldDigit = document.createElement('div');
                                oldDigit.innerHTML = oldStr[i] === ' ' ? ' ' : oldStr[i];
                                const newDigit = document.createElement('div');
                                newDigit.innerHTML = newStr[i] === ' ' ? ' ' : newStr[i];
                                if (direction === 1) {
                                    reel.appendChild(oldDigit); reel.appendChild(newDigit);
                                } else {
                                    reel.appendChild(newDigit); reel.appendChild(oldDigit);
                                    reel.style.transform = 'translateY(-1.2em)';
                                }
                                slot.appendChild(reel);
                                reelsToAnimate.push({ reel, direction });
                            }
                            group.appendChild(slot);
                            if (isInitiallyPlaceholder !== isFinallyPlaceholder) {
                                requestAnimationFrame(() => {
                                    slot.classList.toggle('is-placeholder', isFinallyPlaceholder);
                                });
                            }
                        }
                        return group;
                    };

                    const createStaticText = (text) => {
                        const el = document.createElement('span');
                        el.textContent = text;
                        return el;
                    };
                    titleWrapper.appendChild(createDigitGroup(newYear, oldYear));
                    titleWrapper.appendChild(createStaticText('年'));
                    titleWrapper.appendChild(createDigitGroup(newMonth, oldMonth));
                    titleWrapper.appendChild(createStaticText('月'));
                    requestAnimationFrame(() => {
                        reelsToAnimate.forEach(({ reel, direction }) => {
                            reel.style.transform = direction === 1 ? 'translateY(-1.2em)' : 'translateY(0)';
                        });
                    });
                }

                function setTranslate(x) {
                    currentTranslateX = x;
                    track.style.transform = `translateX(${x}px)`;
                }

                function animateTo(targetX, duration = 350, onComplete) {
                    cancelAnimationFrame(animationFrameId);
                    const startX = currentTranslateX;
                    const distance = targetX - startX;
                    let startTime = null;
                    function step(timestamp) {
                        if (!startTime) startTime = timestamp;
                        const elapsed = timestamp - startTime;
                        const progress = Math.min(elapsed / duration, 1);
                        setTranslate(startX + distance * easeOutCubic(progress));
                        if (progress < 1) animationFrameId = requestAnimationFrame(step);
                        else if (onComplete) onComplete();
                    }
                    animationFrameId = requestAnimationFrame(step);
                }

                function updateNavButtonStates() {
                    const sortedDates = Array.from(activeDatesSet).sort();
                    if (sortedDates.length === 0) {
                        prevBtn.disabled = true; prevBtn.classList.add('disabled');
                        nextBtn.disabled = true; nextBtn.classList.add('disabled');
                        return;
                    }
                    const firstAvailableDateStr = sortedDates[0];
                    const minMonthDate = new Date(parseInt(firstAvailableDateStr.substring(0, 4), 10), parseInt(firstAvailableDateStr.substring(4, 6), 10) - 1, 1);
                    const todayForNav = new Date();
                    const maxMonthDate = new Date(todayForNav.getFullYear(), todayForNav.getMonth(), 1);
                    const currentMonthStart = new Date(displayDate.getFullYear(), displayDate.getMonth(), 1);
                    const isPrevDisabled = currentMonthStart.getTime() <= minMonthDate.getTime();
                    prevBtn.disabled = isPrevDisabled;
                    prevBtn.classList.toggle('disabled', isPrevDisabled);
                    const isNextDisabled = currentMonthStart.getTime() >= maxMonthDate.getTime();
                    nextBtn.disabled = isNextDisabled;
                    nextBtn.classList.toggle('disabled', isNextDisabled);
                }

                function updatePanels(direction) {
                    if (direction === 1) {
                        if (panelIndex >= track.children.length - 2) {
                            const newDate = new Date(displayDate.getFullYear(), displayDate.getMonth() + 1, 1);
                            track.appendChild(buildGrid(newDate));
                        }
                    } else if (direction === -1) {
                        if (panelIndex <= 1) {
                            const newDate = new Date(displayDate.getFullYear(), displayDate.getMonth() - 1, 1);
                            track.insertBefore(buildGrid(newDate), track.firstChild);
                            panelIndex++;
                            setTranslate(currentTranslateX - wrapper.clientWidth);
                        }
                    }
                    updateNavButtonStates();
                }

                function cleanupPanels() {
                    const children = track.children;
                    while(panelIndex > 1 && children.length > 3) {
                        track.removeChild(children[0]);
                        panelIndex--;
                        setTranslate(currentTranslateX + wrapper.clientWidth);
                    }
                    while(children.length - panelIndex > 2 && children.length > 3) {
                        track.removeChild(children[children.length-1]);
                    }
                }

                function moveTo(direction) {
                    if ((direction === 1 && nextBtn.disabled) || (direction === -1 && prevBtn.disabled)) {
                        animateTo(-panelIndex * wrapper.clientWidth);
                        return;
                    }
                    const oldDate = new Date(displayDate);
                    if (direction !== 0) {
                        panelIndex += direction;
                        displayDate.setMonth(displayDate.getMonth() + direction);
                        updateAnimatedTitle(displayDate, oldDate, direction);
                        updatePanels(direction);
                    }
                    const targetX = -panelIndex * wrapper.clientWidth;
                    animateTo(targetX, 350, cleanupPanels);
                }

                let startX, currentDragX, dx = 0, dragging = false;
                function pointerDown(e) {
                    cancelAnimationFrame(animationFrameId);
                    dragging = true;
                    startX = e.clientX || e.touches[0].clientX;
                    currentDragX = currentTranslateX;
                    dx = 0;
                    wrapper.style.cursor = 'grabbing';
                    datePickerDragged = false;
                }
                function pointerMove(e) {
                    if (!dragging) return;
                    dx = (e.clientX || e.touches[0].clientX) - startX;
                    if (!datePickerDragged && Math.abs(dx) > 5) datePickerDragged = true;
                    setTranslate(currentDragX + dx);
                    e.preventDefault();
                }
                function pointerUp() {
                    if (!dragging) return;
                    dragging = false;
                    wrapper.style.cursor = 'grab';
                    const threshold = wrapper.clientWidth * 0.2;
                    let direction = 0;
                    if (dx < -threshold) direction = 1;
                    else if (dx > threshold) direction = -1;
                    moveTo(direction);
                }

                function initialize() {
                    initWeekdays();
                    wrapper.addEventListener('pointerdown', pointerDown);
                    document.addEventListener('pointermove', pointerMove, { passive: false });
                    document.addEventListener('pointerup', pointerUp);
                    document.addEventListener('pointercancel', pointerUp);
                    prevBtn.onclick = () => moveTo(-1);
                    nextBtn.onclick = () => moveTo(1);
                    wrapper.style.cursor = 'grab';
                }

                function render(newActiveDates, currentSelDate, onSelect) {
                    activeDatesSet = newActiveDates || new Set();
                    selectedDate = currentSelDate ? new Date(currentSelDate) : null;
                    onDateSelectCallback = onSelect || (() => {});
                    displayDate = selectedDate || new Date();
                    updateAnimatedTitle(displayDate, displayDate, 0);
                    track.innerHTML = '';
                    const initialDates = [
                        new Date(displayDate.getFullYear(), displayDate.getMonth() - 1, 1),
                        displayDate,
                        new Date(displayDate.getFullYear(), displayDate.getMonth() + 1, 1)
                    ];
                    initialDates.forEach(date => track.appendChild(buildGrid(date)));
                    panelIndex = 1;
                    const initialX = -panelIndex * wrapper.clientWidth;
                    setTranslate(initialX);
                    updateNavButtonStates();
                }
                initialize();
                return { render };
            })();

            function padZero(num) {
                var s = String(num);
                return s.length < 2 ? '0' + s : s;
            }
            function getLocalISOString(date) {
                date = date || new Date();
                return date.getFullYear() + '-' + padZero(date.getMonth() + 1) + '-' + padZero(date.getDate()) +
                       'T' + padZero(date.getHours()) + ':' + padZero(date.getMinutes()) + ':' + padZero(date.getSeconds());
            }
            function getFormattedDate(date) {
                date = date || new Date();
                return String(date.getFullYear()) + padZero(date.getMonth() + 1) + padZero(date.getDate());
            }

            async function performLogin() {
                try {
                    const loginParams = new URLSearchParams({ userName: USERNAME, password: PASSWORD });
                    const response = await fetch(`${LOGIN_URL}?${loginParams.toString()}`, {
                        method: 'GET',
                        headers: BASE_HEADERS,
                        credentials: 'include'
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    if (data.success) {
                        return true;
                    } else {
                        throw new Error(data.hintMessage || 'Unknown login error');
                    }
                } catch (error) {
                    console.error('Login process failed:', error);
                    return false;
                }
            }

            function enableChatFunctionality() {
                const config = GAME_MODES[currentGameMode];
                setInputState(true, config.placeholder);
                updateUIForLoadedChat(); // 再次调用以确保placeholder包含成功人数等信息
            }

            function handleLoginFailure() {
                showErrorDialog({ title: '连接失败', message: '无法连接到游戏服务，请刷新页面重试。' });
                setInputState(false, "连接失败，请刷新重试");
            }
            
            function scrollToBottom() {
                if (chatWindow && typeof chatWindow.scrollTo === 'function') {
                    chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior: 'smooth' });
                } else if (chatWindow) {
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                }
            }

            function renderMessage({ text, sender, type }) {
                const messageDiv = document.createElement('div');
                messageDiv.className = sender === 'system' ? 'system-message ' + type : 'message ' + sender + '-message';
                if (sender !== 'system') {
                    const bubble = document.createElement('div');
                    bubble.className = 'message-bubble';
                    bubble.textContent = text;
                    messageDiv.appendChild(bubble);
                } else {
                    messageDiv.textContent = text;
                }
                chatWindow.appendChild(messageDiv);
                scrollToBottom();
            }

            function setInputState(enabled, placeholderText) {
                userInput.disabled = !enabled;
                sendButton.disabled = !enabled;
                if (placeholderText) {
                    userInput.placeholder = placeholderText;
                }
            }

            async function saveHistory(firstUserMessage) {
                if (!currentChatKey) return;
                const config = GAME_MODES[currentGameMode];
                try {
                    const existingData = JSON.parse(localStorage.getItem(currentChatKey) || '{}');
                    const dataToSave = Object.assign({}, existingData, {
                        messages: chatHistory,
                        chatId: chatId,
                        isGameActive: isGameActive,
                        victoryRank: currentVictoryRank
                    });
                    if (firstUserMessage) {
                        dataToSave.title = firstUserMessage.length > 28 ? firstUserMessage.substring(0, 28) + '...' : firstUserMessage;
                    }
                    localStorage.setItem(currentChatKey, JSON.stringify(dataToSave));
                    if (firstUserMessage) {
                        localStorage.setItem(config.activeKey, currentChatKey);
                    }
                    populateSidebar();
                } catch (error) {
                    console.error("保存聊天记录失败:", error);
                    await showErrorDialog({ title: '保存失败', message: '无法保存聊天记录。请检查浏览器设置或磁盘空间。' });
                }
            }

            async function loadChat(keyToLoad, isInitialLoad = false) {
                const config = GAME_MODES[currentGameMode];
                const savedData = localStorage.getItem(keyToLoad);
                if (!savedData) {
                    await startNewChat(null, isInitialLoad);
                    return;
                };
                try {
                    const data = JSON.parse(savedData);
                    currentChatKey = keyToLoad;
                    targetDate = null;
                    localStorage.setItem(config.activeKey, keyToLoad);
                    chatHistory = data.messages || [];
                    chatId = data.chatId || "";
                    isGameActive = typeof data.isGameActive === 'boolean' ? data.isGameActive : false;
                    currentVictoryRank = data.victoryRank || null;
                    chatWindow.innerHTML = '';
                    renderMessage({ text: config.greeting, sender: 'ai' });
                    chatHistory.forEach(msg => renderMessage(msg));
                    
                    if (isInitialLoad && isGameActive) {
                        updateUIForLoadedChat(true); 
                    } else if (!isInitialLoad) {
                         if (isGameActive) {
                            const puzzleDate = keyToLoad.substring(config.storagePrefix.length, config.storagePrefix.length + 10);
                            dailySuccessCount = await fetchSuccessCount(puzzleDate);
                        } else {
                            dailySuccessCount = null;
                        }
                        updateUIForLoadedChat();
                    }
                } catch (error) {
                    console.error("加载聊天记录失败:", error);
                    await startNewChat();
                }
            }

            async function startNewChat(selectedDate, isInitialLoad = false) {
                const config = GAME_MODES[currentGameMode];
                currentChatKey = null;
                chatId = "";
                isGameActive = true;
                currentVictoryRank = null;
                chatHistory = [];
                localStorage.setItem(config.activeKey, 'new');
                chatWindow.innerHTML = '';
                targetDate = selectedDate;
                renderMessage({ text: config.greeting, sender: 'ai' });
                
                if (isInitialLoad) {
                    dailySuccessCount = null;
                } else {
                    if (selectedDate) {
                        dailySuccessCount = await fetchSuccessCount(selectedDate.replace(/-/g, ''));
                    } else {
                        dailySuccessCount = await fetchSuccessCount();
                    }
                }
                
                populateSidebar();
                updateUIForLoadedChat(isInitialLoad);
                if (isMobile) {
                    document.body.classList.remove('sidebar-open');
                }
            }

            function updateCalendarButtonVisibility() {
                const isNewChat = currentChatKey === null;
                dailyPuzzleButton.style.display = isNewChat ? 'flex' : 'none';
            }

            function updateUIForLoadedChat(isInitialLoad = false) {
                updateCalendarButtonVisibility();
                const config = GAME_MODES[currentGameMode];
                let placeholder = config.placeholder;
                
                if (userInput.disabled && !isInitialLoad) {
                     if (isGameActive) {
                        if (dailySuccessCount !== null) {
                            const isNewChat = currentChatKey === null;
                            const successText = ' ' + '已有 ' + dailySuccessCount.toLocaleString() + ' 人猜出谜底';
                            if (!isMobile) {
                                placeholder += successText;
                            }
                        }
                    } else {
                        if (currentVictoryRank !== null) {
                            placeholder = '您是第 ' + currentVictoryRank.toLocaleString() + ' 位猜出谜底的人！🎉';
                        } else {
                            placeholder = "恭喜你，已猜出谜底！请开启新对话。";
                        }
                    }
                    userInput.placeholder = placeholder;
                } else if (isInitialLoad) {
                    userInput.placeholder = "正在连接服务...";
                }

                document.querySelectorAll('.history-item').forEach(function(item) {
                    item.classList.toggle('active', item.dataset.key === currentChatKey);
                });

                if (!isMobile && !userInput.disabled) {
                    userInput.focus();
                }
            }

            async function fetchActiveDates() {
                const config = GAME_MODES[currentGameMode];
                if (activeDatesCache[currentGameMode]) return activeDatesCache[currentGameMode];
                try {
                    const response = await fetch(`/api/v0/quiz/daily/general/fetchActive?type=${config.typeParam}`, {
                        method: 'GET',
                        headers: BASE_HEADERS
                    });
                    if (!response.ok) throw new Error('API request failed');
                    const result = await response.json();
                    if (result.success && Array.isArray(result.data)) {
                        const dates = new Set(result.data);
                        activeDatesCache[currentGameMode] = dates;
                        return dates;
                    }
                    return new Set();
                } catch (error) {
                    console.error("获取可选日期失败:", error);
                    await showErrorDialog({ title: '网络错误', message: '无法获取往日谜题列表，请稍后重试。' });
                    return null;
                }
            }

            async function fetchSuccessCount(puzzleDateStr) {
                const config = GAME_MODES[currentGameMode];
                let dateForApi = puzzleDateStr ? puzzleDateStr.replace(/-/g, '') : getFormattedDate();
                const url = `/api/v0/quiz/daily/getStatus?type=${config.typeParam}&date=${dateForApi}`;
                try {
                    // 这个API需要登录
                    const response = await fetch(url, { method: 'GET', headers: BASE_HEADERS, credentials: 'include' });
                    if (!response.ok) return null;
                    const data = await response.json();
                    return (data.success && data.data) ? data.data.success : null;
                } catch (error) {
                    console.error("获取成功人数时发生网络错误:", error);
                    return null;
                }
            }

            async function sendMessage() {
                const messageText = userInput.value.trim();
                if (!messageText || !isGameActive) return;
                const config = GAME_MODES[currentGameMode];
                const isFirstMessage = (currentChatKey === null);
                let puzzleDateForApi;

                if (isFirstMessage) {
                    const baseDate = targetDate ? new Date(targetDate + "T12:00:00") : new Date();
                    currentChatKey = config.storagePrefix + getLocalISOString(baseDate);
                    puzzleDateForApi = targetDate ? targetDate.replace(/-/g, '') : getFormattedDate();
                } else {
                    puzzleDateForApi = currentChatKey.substring(config.storagePrefix.length, config.storagePrefix.length + 10).replace(/-/g, '');
                }

                chatHistory.push({ text: messageText, sender: 'user' });
                renderMessage({ text: messageText, sender: 'user' });
                userInput.value = '';
                setInputState(false, "AI思考中...");

                try {
                    const bodyParams = new URLSearchParams({
                        date: puzzleDateForApi,
                        chatId: chatId,
                        message: messageText
                    });
                    const response = await fetch(config.apiUrl, {
                        method: 'POST',
                        headers: Object.assign({}, BASE_HEADERS, {
                            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
                        }),
                        credentials: 'include',
                        body: bodyParams.toString()
                    });
                    const data = await response.json();
                    if (!response.ok || !data.success) throw new Error(data.hintMessage || '请求失败: ' + response.status);
                    const d = data.data || {};
                    if (d.chatId) chatId = d.chatId;
                    const aiMessage = { text: d.answer || "我不知道该怎么回答。", sender: 'ai' };
                    chatHistory.push(aiMessage);
                    renderMessage(aiMessage);
                    if (d.right) {
                        isGameActive = false;
                        const successMsg = { text: config.successMessage, sender: 'system', type: 'success' };
                        chatHistory.push(successMsg);
                        renderMessage(successMsg);
                        currentVictoryRank = await fetchSuccessCount(puzzleDateForApi);
                    }
                } catch (error) {
                    console.error("发送消息失败:", error);
                    chatHistory.pop();
                    if (chatWindow.lastChild && chatWindow.lastChild.classList.contains('user-message')) chatWindow.lastChild.remove();
                    const errorMsg = { text: '错误: 消息发送失败，请检查网络并重试。', sender: 'system', type: 'error' };
                    chatHistory.push(errorMsg);
                    renderMessage(errorMsg);
                    userInput.value = messageText;
                } finally {
                    setInputState(isGameActive, config.placeholder);
                    await saveHistory(isFirstMessage ? messageText : null);
                    updateUIForLoadedChat();
                    if (!isMobile) userInput.focus();
                }
            }
            
            async function checkBrowserCompatibility() {
                if (localStorage.getItem('suppressBrowserWarning') === 'true' || sessionStorage.getItem('browserVersionWarningShown') === 'true') return;
                const warningMessages = [];
                const testEl = document.createElement('div');
                testEl.style.display = 'flex';
                testEl.style.gap = '1px';
                if (testEl.style.gap !== '1px') warningMessages.push("页面元素间距错位。");
                if (typeof CSS === 'undefined' || !CSS.supports('color', 'color-mix(in srgb, red, blue)')) warningMessages.push("按钮颜色略有不同。");
                if (typeof CSS === 'undefined' || !CSS.supports('display', 'grid')) warningMessages.push("日期选择器无法正常渲染。");
                if (!('backdropFilter' in testEl.style || 'webkitBackdropFilter' in testEl.style)) warningMessages.push("弹窗背景模糊效果无法呈现。");
                if (typeof window.PointerEvent === 'undefined') warningMessages.push("日期选择器无法响应拖动操作。");
                if (!('serviceWorker' in navigator)) warningMessages.push("无法利用缓存加速第二次打开。");
                if (!window.matchMedia || !window.matchMedia('(prefers-color-scheme: dark)').matches && !window.matchMedia('(prefers-color-scheme: light)').matches) warningMessages.push("无法跟随系统切换浅色/深色模式。");
                if (typeof CSS === 'undefined' || !CSS.supports('padding-top', 'env(safe-area-inset-top)')) warningMessages.push("在部分全面屏手机上，顶部可能被遮挡。");
                if (warningMessages.length > 0) {
                    const baseMessage = '我们检测到您当前的浏览器版本较低，继续使用可能会遇到以下情况：';
                    const fullMessage = baseMessage + '\n\n• ' + warningMessages.join('\n• ');
                    await showBrowserWarningDialog({ title: '浏览器兼容性提示', message: fullMessage });
                }
            }
            function getRelativeDateGroup(dateStr) {
                const today = new Date();
                const date = new Date(dateStr);
                today.setHours(0, 0, 0, 0);
                date.setHours(0, 0, 0, 0);
                const diffDays = (today - date) / 864e5;
                if (diffDays === 0) return "今天";
                if (diffDays === 1) return "昨天";
                if (diffDays < 7) return "7天内";
                return date.getFullYear() + '-' + padZero(date.getMonth() + 1);
            }
            function populateSidebar() {
                const config = GAME_MODES[currentGameMode];
                const prefix = config.storagePrefix;
                const chats = Object.keys(localStorage).filter(k => k.startsWith(prefix)).map(key => ({ key: key, data: JSON.parse(localStorage.getItem(key) || '{}') })).filter(chat => chat.data && chat.data.title).sort((a, b) => b.key.localeCompare(a.key));
                const groups = {};
                chats.forEach(function(chat) {
                    const dateStr = chat.key.substring(prefix.length, prefix.length + 10);
                    const groupName = getRelativeDateGroup(dateStr);
                    if (!groups[groupName]) groups[groupName] = [];
                    groups[groupName].push(chat);
                });
                historyListContainer.innerHTML = '';
                const groupOrder = ["今天", "昨天", "7天内"];
                const sortedGroupNames = Object.keys(groups).sort((a, b) => {
                    const aIndex = groupOrder.indexOf(a);
                    const bIndex = groupOrder.indexOf(b);
                    if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
                    if (aIndex !== -1) return -1;
                    if (bIndex !== -1) return 1;
                    return b.localeCompare(a);
                });
                sortedGroupNames.forEach(function(groupName) {
                    const header = document.createElement('div');
                    header.className = 'history-group-header';
                    header.textContent = groupName;
                    historyListContainer.appendChild(header);
                    groups[groupName].forEach(function({ key, data }) {
                        const li = document.createElement('div');
                        li.className = 'history-item';
                        li.dataset.key = key;
                        li.innerHTML = '<span>' + data.title + '</span>';
                        li.title = data.title;
                        if (key === currentChatKey) li.classList.add('active');
                        li.addEventListener('click', () => loadChat(key));
                        historyListContainer.appendChild(li);
                    });
                });
            }
            function handleRename() {
                if (!contextMenuTarget) return;
                const key = contextMenuTarget.dataset.key;
                const titleSpan = contextMenuTarget.querySelector('span');
                if (!titleSpan) return;
                const currentTitle = titleSpan.textContent;
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentTitle;
                input.style.cssText = 'width:100%;padding:0;margin:0;border:none;background:transparent;color:inherit;font:inherit;outline:none;';
                contextMenuTarget.replaceChild(input, titleSpan);
                input.focus();
                input.select();
                const saveRename = () => {
                    const newTitle = input.value.trim();
                    if (newTitle && newTitle !== currentTitle) {
                        try {
                            const savedData = JSON.parse(localStorage.getItem(key) || '{}');
                            savedData.title = newTitle;
                            localStorage.setItem(key, JSON.stringify(savedData));
                            titleSpan.textContent = newTitle;
                        } catch (e) {
                            console.error("重命名失败", e);
                            titleSpan.textContent = currentTitle;
                        }
                    } else {
                        titleSpan.textContent = currentTitle;
                    }
                    if (contextMenuTarget.contains(input)) contextMenuTarget.replaceChild(titleSpan, input);
                    input.removeEventListener('keydown', onKeydown);
                };
                const onKeydown = (e) => {
                    if (e.key === 'Enter') input.blur();
                    else if (e.key === 'Escape') {
                        input.removeEventListener('blur', saveRename);
                        titleSpan.textContent = currentTitle;
                        if (contextMenuTarget.contains(input)) contextMenuTarget.replaceChild(titleSpan, input);
                    }
                };
                input.addEventListener('blur', saveRename, { once: true });
                input.addEventListener('keydown', onKeydown);
            }
            function showBrowserWarningDialog({ title, message }) {
                title = title || '提示';
                message = message || '';
                return new Promise(resolve => {
                    browserWarningTitle.textContent = title;
                    browserWarningMessage.textContent = message;
                    dontShowAgainCheckbox.checked = false;
                    let resolver = null;
                    const show = () => browserWarningModal.classList.add('show');
                    const hide = () => {
                        if (dontShowAgainCheckbox.checked) localStorage.setItem('suppressBrowserWarning', 'true');
                        sessionStorage.setItem('browserVersionWarningShown', 'true');
                        browserWarningModal.classList.remove('show');
                        if (resolver) { resolver(); resolver = null; }
                        browserWarningOkBtn.removeEventListener('click', handleAction);
                        browserWarningCloseBtn.removeEventListener('click', handleAction);
                        browserWarningModal.removeEventListener('click', handleOverlayClick);
                    };
                    const handleAction = () => hide();
                    const handleOverlayClick = (e) => { if (e.target === browserWarningModal) handleAction(); };
                    browserWarningOkBtn.addEventListener('click', handleAction);
                    browserWarningCloseBtn.addEventListener('click', handleAction);
                    browserWarningModal.addEventListener('click', handleOverlayClick);
                    show();
                    resolver = resolve;
                });
            }
            function showErrorDialog({ title, message }) {
                title = title || '错误';
                message = message || '';
                return new Promise(resolve => {
                    errorModalTitle.textContent = title;
                    errorModalMessage.textContent = message;
                    let resolver = null;
                    const show = () => errorModal.classList.add('show');
                    const hide = () => {
                        errorModal.classList.remove('show');
                        if (resolver) { resolver(); resolver = null; }
                        errorModalOkBtn.removeEventListener('click', handleAction);
                        errorModalCloseBtn.removeEventListener('click', handleAction);
                        errorModal.removeEventListener('click', handleOverlayClick);
                    };
                    const handleAction = () => hide();
                    const handleOverlayClick = (e) => { if (e.target === errorModal) handleAction(); };
                    errorModalOkBtn.addEventListener('click', handleAction);
                    errorModalCloseBtn.addEventListener('click', handleAction);
                    errorModal.addEventListener('click', handleOverlayClick);
                    show();
                    resolver = resolve;
                });
            }
            function showInfoDialog({ title, message }) {
                title = title || '提示';
                message = message || '';
                return new Promise(resolve => {
                    infoModalTitle.textContent = title;
                    infoModalMessage.textContent = message;
                    let resolver = null;
                    const show = () => infoModal.classList.add('show');
                    const hide = () => {
                        infoModal.classList.remove('show');
                        if (resolver) { resolver(); resolver = null; }
                        infoModalOkBtn.removeEventListener('click', handleAction);
                        infoModalCloseBtn.removeEventListener('click', handleAction);
                        infoModal.removeEventListener('click', handleOverlayClick);
                    };
                    const handleAction = () => hide();
                    const handleOverlayClick = (e) => { if (e.target === infoModal) handleAction(); };
                    infoModalOkBtn.addEventListener('click', handleAction);
                    infoModalCloseBtn.addEventListener('click', handleAction);
                    infoModal.addEventListener('click', handleOverlayClick);
                    show();
                    resolver = resolve;
                });
            }
            function showConfirmDialog({ title, message, confirmText, confirmClass }) {
                title = title || '永久删除对话';
                message = message || '删除后，该对话将不可恢复。确认删除吗？';
                confirmText = confirmText || '删除';
                confirmClass = confirmClass || '';
                return new Promise(resolve => {
                    confirmModalTitle.textContent = title;
                    confirmModalMessage.textContent = message;
                    confirmModalConfirmBtn.textContent = confirmText;
                    confirmModalConfirmBtn.className = 'confirm-btn ' + confirmClass;
                    confirmModal.classList.toggle('is-delete', confirmClass === 'delete');
                    let resolver = null;
                    const show = () => confirmModal.classList.add('show');
                    const hide = (value) => {
                        confirmModal.classList.remove('show');
                        if (resolver) { resolver(value); resolver = null; }
                        confirmModalConfirmBtn.removeEventListener('click', handleConfirm);
                        confirmModalCancelBtn.removeEventListener('click', handleCancel);
                        confirmModalCloseBtn.removeEventListener('click', handleCancel);
                        confirmModal.removeEventListener('click', handleOverlayClick);
                    };
                    const handleConfirm = () => hide(true);
                    const handleCancel = () => hide(false);
                    const handleOverlayClick = (e) => { if (e.target === confirmModal) handleCancel(); };
                    confirmModalConfirmBtn.addEventListener('click', handleConfirm);
                    confirmModalCancelBtn.addEventListener('click', handleCancel);
                    confirmModalCloseBtn.addEventListener('click', handleCancel);
                    confirmModal.addEventListener('click', handleOverlayClick);
                    show();
                    resolver = resolve;
                });
            }
            async function handleDelete() {
                if (!contextMenuTarget) return;
                const key = contextMenuTarget.dataset.key;
                const confirmed = await showConfirmDialog({
                    title: '永久删除对话',
                    message: '删除后，该对话将不可恢复。确认删除吗？',
                    confirmText: '删除',
                    confirmClass: 'delete'
                });
                if (confirmed) {
                    localStorage.removeItem(key);
                    populateSidebar();
                    if (key === currentChatKey) {
                        await startNewChat();
                    }
                }
            }
            function createCustomDropdown() {
                gameModeDropdown.innerHTML = '';
                const selected = document.createElement('div');
                selected.className = 'select-selected';
                const selectedText = document.createElement('span');
                selectedText.id = 'selected-game-mode-text';
                selectedText.textContent = GAME_MODES[currentGameMode].title;
                selected.appendChild(selectedText);
                const arrow = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                arrow.setAttribute('class', 'select-arrow');
                arrow.setAttribute('viewBox', '0 0 20 20');
                arrow.innerHTML = '<path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />';
                selected.appendChild(arrow);
                const items = document.createElement('ul');
                items.className = 'select-items';
                Object.keys(GAME_MODES).forEach(key => {
                    const li = document.createElement('li');
                    li.className = 'select-item';
                    li.textContent = GAME_MODES[key].title;
                    li.dataset.value = key;
                    li.addEventListener('click', async function(e) {
                        const newMode = this.dataset.value;
                        if (newMode === currentGameMode) {
                            closeDropdown();
                            return;
                        }
                        selectedText.textContent = this.textContent;
                        closeDropdown();
                        await handleGameModeChange(newMode);
                    });
                    items.appendChild(li);
                });
                gameModeDropdown.appendChild(selected);
                gameModeDropdown.appendChild(items);
                selected.addEventListener('click', (e) => {
                    e.stopPropagation();
                    datePickerPopover.classList.remove('show');
                    items.classList.toggle('show');
                    selected.classList.toggle('select-arrow-active');
                });
            }
            function closeDropdown() {
                const items = gameModeDropdown.querySelector('.select-items');
                const selected = gameModeDropdown.querySelector('.select-selected');
                if (items && items.classList.contains('show')) {
                    items.classList.remove('show');
                    if (selected) selected.classList.remove('select-arrow-active');
                }
            }
            async function handleGameModeChange(newMode) {
                currentGameMode = newMode;
                localStorage.setItem('lastGameMode', currentGameMode);
                document.title = '猜盐 - ' + GAME_MODES[currentGameMode].title;
                activeDatesCache = {};
                createCustomDropdown();
                await startNewChat();
            }
            async function handleExport() {
                const allData = {};
                const prefixes = Object.values(GAME_MODES).map(mode => mode.storagePrefix);
                const settingsKeys = ['lastGameMode', 'sidebarCollapsedState', 'suppressBrowserWarning'];
                const chatKeysFound = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const isChatKey = prefixes.some(prefix => key.startsWith(prefix));
                    if (isChatKey) {
                        chatKeysFound.push(key);
                        allData[key] = localStorage.getItem(key);
                    } else if (settingsKeys.includes(key)) {
                        allData[key] = localStorage.getItem(key);
                    }
                }
                if (chatKeysFound.length === 0) {
                    await showInfoDialog({ title: '导出提示', message: '没有可导出的历史记录。' });
                    return;
                }
                const jsonString = JSON.stringify(allData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'caiyan_backup_' + getFormattedDate() + '.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            async function handleImport(event) {
                const file = event.target.files[0];
                if (!file) return;
                const confirmed = await showConfirmDialog({
                    title: '导入历史记录',
                    message: '此操作将覆盖所有本地聊天记录，且不可恢复。确定要导入吗？',
                    confirmText: '导入',
                    confirmClass: 'import'
                });
                if (!confirmed) {
                    importFileInput.value = '';
                    return;
                }
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        const prefixes = Object.values(GAME_MODES).map(mode => mode.storagePrefix);
                        const keysToClear = ['lastGameMode', 'sidebarCollapsedState', 'suppressBrowserWarning'];
                        const keysToRemove = [];
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (keysToClear.includes(key) || prefixes.some(prefix => key.startsWith(prefix))) {
                                keysToRemove.push(key);
                            }
                        }
                        keysToRemove.forEach(key => localStorage.removeItem(key));
                        for (const key in importedData) {
                            if (Object.hasOwnProperty.call(importedData, key)) localStorage.setItem(key, importedData[key]);
                        }
                        location.reload();
                    } catch (error) {
                        console.error("Import error:", error);
                        await showErrorDialog({ title: '导入失败', message: '文件格式无效或已损坏。' });
                    } finally {
                        importFileInput.value = '';
                    }
                };
                reader.readAsText(file);
            }
            function setupThemeColorSync() {
                const themeColorMeta = document.querySelector('meta[name="theme-color"]');
                if (!themeColorMeta) return;
                const updateThemeColor = () => {
                    const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    const newColor = isDark ? '#141318' : '#fdf8fd';
                    themeColorMeta.setAttribute('content', newColor);
                };
                updateThemeColor();
                const mediaQueryList = window.matchMedia('(prefers-color-scheme: dark)');
                if (mediaQueryList.addEventListener) mediaQueryList.addEventListener('change', updateThemeColor);
                else if (mediaQueryList.addListener) mediaQueryList.addListener(updateThemeColor);
            }
            function setupEventHandlers() {
                sidebarToggleButton.addEventListener('click', () => {
                    appWrapper.classList.toggle('sidebar-collapsed');
                    const isCollapsed = appWrapper.classList.contains('sidebar-collapsed');
                    sidebarToggleButton.textContent = isCollapsed ? '›' : '‹';
                    localStorage.setItem('sidebarCollapsedState', isCollapsed);
                });
                mobileMenuToggle.addEventListener('click', () => { document.body.classList.add('sidebar-open'); });
                sidebarOverlay.addEventListener('click', () => {
                    document.body.classList.remove('sidebar-open');
                    if (document.activeElement) document.activeElement.blur();
                });
                newChatButton.addEventListener('click', () => startNewChat());
                sendButton.addEventListener('click', sendMessage);
                userInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                userInput.addEventListener('focus', () => {
                    if (isGameActive && dailySuccessCount !== null && !userInput.disabled) {
                        const isNewChat = currentChatKey === null;
                        const dayText = isNewChat && !targetDate ? '今日' : '该日';
                        userInput.placeholder = GAME_MODES[currentGameMode].placeholder + ' ' + dayText + '已有 ' + dailySuccessCount.toLocaleString() + ' 人猜出谜底';
                    }
                });
                userInput.addEventListener('blur', () => {
                    if (isGameActive && !userInput.disabled) {
                        let placeholder = GAME_MODES[currentGameMode].placeholder;
                        if (!isMobile && dailySuccessCount !== null) {
                            const isNewChat = currentChatKey === null;
                            const dayText = isNewChat && !targetDate ? '今日' : '该日';
                            placeholder += ' ' + dayText + '已有 ' + dailySuccessCount.toLocaleString() + ' 人猜出谜底';
                        }
                        userInput.placeholder = placeholder;
                    }
                });
                const showContextMenu = (target, x, y) => {
                    contextMenuTarget = target;
                    closeDropdown();
                    datePickerPopover.classList.remove('show');
                    requestAnimationFrame(() => {
                        const menuWidth = contextMenu.offsetWidth, menuHeight = contextMenu.offsetHeight;
                        const viewWidth = window.innerWidth, viewHeight = window.innerHeight;
                        const finalX = (x + menuWidth > viewWidth) ? viewWidth - menuWidth - 5 : x;
                        const finalY = (y + menuHeight > viewHeight) ? viewHeight - menuHeight - 5 : y;
                        contextMenu.style.top = finalY + 'px';
                        contextMenu.style.left = finalX + 'px';
                        contextMenu.classList.add('show');
                    });
                };
                historyListContainer.addEventListener('contextmenu', (e) => {
                    const target = e.target.closest('.history-item');
                    if (target) {
                        e.preventDefault();
                        showContextMenu(target, e.clientX, e.clientY);
                    }
                });
                let longPressTimer = null, touchStartX = 0, touchStartY = 0;
                historyListContainer.addEventListener('touchstart', (e) => {
                    const target = e.target.closest('.history-item');
                    if (target) {
                        touchStartX = e.touches[0].clientX;
                        touchStartY = e.touches[0].clientY;
                        longPressTimer = setTimeout(() => {
                            longPressTimer = null;
                            if (navigator.vibrate) navigator.vibrate(50);
                            showContextMenu(target, e.touches[0].clientX, e.touches[0].clientY);
                        }, 500);
                    }
                }, { passive: true });
                historyListContainer.addEventListener('touchmove', (e) => {
                    if (longPressTimer && (Math.abs(e.touches[0].clientX - touchStartX) > 10 || Math.abs(e.touches[0].clientY - touchStartY) > 10)) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                });
                const clearLongPress = () => { if (longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; } };
                historyListContainer.addEventListener('touchend', clearLongPress);
                historyListContainer.addEventListener('touchcancel', clearLongPress);
                document.addEventListener('click', (e) => {
                    if (contextMenu.classList.contains('show') && !contextMenu.contains(e.target)) contextMenu.classList.remove('show');
                    if (!gameModeDropdown.contains(e.target)) closeDropdown();
                    if (datePickerPopover.classList.contains('show') && !datePickerPopover.contains(e.target) && !e.target.closest('#daily-puzzle-button')) datePickerPopover.classList.remove('show');
                });
                renameOption.addEventListener('click', (e) => { e.stopPropagation(); handleRename(); contextMenu.classList.remove('show'); });
                deleteOption.addEventListener('click', (e) => { e.stopPropagation(); handleDelete(); contextMenu.classList.remove('show'); });
                exportButton.addEventListener('click', handleExport);
                importButton.addEventListener('click', () => importFileInput.click());
                importFileInput.addEventListener('change', handleImport);
                dailyPuzzleButton.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    closeDropdown();
                    if (datePickerPopover.classList.contains('show')) {
                        datePickerPopover.classList.remove('show');
                        return;
                    }
                    const activeDatesSet = await fetchActiveDates();
                    if (!activeDatesSet || activeDatesSet.size === 0) return;
                    DatePickerM3.render(activeDatesSet, targetDate, (selectedDateStr) => {
                        startNewChat(selectedDateStr);
                    });
                    datePickerPopover.classList.add('show');
                });
            }

            async function initializeApp() {
                setupThemeColorSync();
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('/sw.js')
                            .then(registration => { console.log('ServiceWorker registration successful with scope: ', registration.scope); })
                            .catch(err => { console.log('ServiceWorker registration failed: ', err); });
                    });
                }
                await checkBrowserCompatibility();

                if (localStorage.getItem('sidebarCollapsedState') === 'true') {
                    appWrapper.classList.add('sidebar-collapsed');
                    sidebarToggleButton.textContent = '›';
                }
                const lastMode = localStorage.getItem('lastGameMode');
                if (lastMode && GAME_MODES[lastMode]) {
                    currentGameMode = lastMode;
                }
                document.title = '猜盐 - ' + GAME_MODES[currentGameMode].title;

                createCustomDropdown();
                setupEventHandlers();
                
                const config = GAME_MODES[currentGameMode];
                const activeChatKey = localStorage.getItem(config.activeKey);
                let keyToLoad = null;
                if (activeChatKey && activeChatKey !== 'new') {
                    keyToLoad = activeChatKey;
                } else if (!activeChatKey) {
                    const keys = Object.keys(localStorage).filter(k => k.startsWith(config.storagePrefix)).sort().reverse();
                    if (keys.length > 0) keyToLoad = keys[0];
                }

                if (keyToLoad) {
                    await loadChat(keyToLoad, true);
                } else {
                    await startNewChat(null, true);
                }
                populateSidebar();

                (async () => {
                    const isLoggedIn = await performLogin();
                    if (isLoggedIn) {
                        enableChatFunctionality();
                    } else {
                        handleLoginFailure();
                    }
                })();
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeApp);
            } else {
                initializeApp();
            }
        })();
    </script>

    <script>
        (function () {
            'use strict';

            function isModernBrowserSupported() {
                // 1. Critical JS API check
                try {
                    new Function('"use strict"; const test = async () => {};');
                } catch (e) {
                    return false;
                }
                if (typeof window.fetch !== 'function' ||
                    typeof window.Promise !== 'function' ||
                    typeof window.localStorage === 'undefined' ||
                    typeof window.Set !== 'function' ||
                    typeof Object.assign !== 'function') {
                    return false;
                }
                
                // 2. Critical CSS API check
                if (typeof window.CSS === 'undefined' || !window.CSS.supports || !window.CSS.supports('color', 'var(--a)')) {
                    return false;
                }
                
                return true;
            }

            if (isModernBrowserSupported()) {
                try {
                    (function(c,l,a,r,i,t,y){
                        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
                        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
                        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
                    })(window, document, "clarity", "script", "sfopgxayyt");
                } catch (e) {
                    console.error("Clarity script initialization failed, but continuing with main app.", e);
                }
                try {
					var simpleAnalyticsScript = document.createElement('script');
					simpleAnalyticsScript.src = 'https://scripts.simpleanalyticscdn.com/latest.js';
					simpleAnalyticsScript.setAttribute('data-collect-dnt', 'true');
					simpleAnalyticsScript.async = true;
					document.head.appendChild(simpleAnalyticsScript);
				} catch (e) {
					console.error("Simple Analytics script initialization failed.", e);
				}
                var scriptTemplate = document.getElementById('main-app-script');
                if (scriptTemplate) {
                    var executableScript = document.createElement('script');
                    executableScript.textContent = scriptTemplate.textContent;
                    document.body.appendChild(executableScript);
                }

            } else {
                var app = document.getElementById('app-wrapper');
                if (app) { app.style.display = 'none'; }
                
                var fallbackMessage = document.getElementById('unsupported-browser-message');
                if (fallbackMessage) { fallbackMessage.style.display = 'block'; }
            }
        })();
    </script>

</body>
</html>
