<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>ÁåúÁõê</title>
    <link rel="icon" href="icons/icon-128x128.png" type="image/png">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">

    <style>
        :root {
            /* ÊµÖËâ≤Ê®°Âºè */
            --sidebar-bg: #f9fbff; --main-bg: #ffffff; --chat-window-bg: #ffffff;
            --text-primary: #1f2937; --text-secondary: #6b7280; --sidebar-text: #374151;
            --sidebar-group-text: #9ca3af; --border-color: #e5e7eb;
            --new-chat-btn-bg: #dbe9fe; --new-chat-btn-text: #1e40af; --new-chat-btn-hover-bg: #cfe2fd;
            --history-item-hover-bg: #eff6fe; --history-item-active-bg: #dbe9fe; --history-item-active-text: #1d4ed8;
            --user-msg-bg: #0084ff; --user-msg-text: #ffffff; --ai-msg-bg: #f3f4f6; --ai-msg-text: #11182c;
            --accent-color: #409eff; --error-color: #ef4444; --success-color: #67c23a;
            --context-menu-bg: rgba(255, 255, 255, 0.7); --context-menu-shadow: 0 4px 12px rgba(0,0,0,0.1); --context-menu-hover-bg: rgba(243, 244, 246, 0.7);
            --modal-overlay-bg: rgba(0, 0, 0, 0.4); 
            --modal-bg: rgba(255, 255, 255, 0.7);
            --modal-cancel-btn-bg: #e5e7eb;
            --modal-error-bg: rgba(255, 235, 235, 0.7);
            --modal-error-btn-bg: #FF6666;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --sidebar-bg: #212327; --main-bg: #292a2d; --chat-window-bg: #292a2d;
                --text-primary: #f9fafb; --text-secondary: #9ca3af; --sidebar-text: #d1d5db;
                --sidebar-group-text: #9ca3af; --border-color: #374151;
                --new-chat-btn-bg: #4d6bfe; --new-chat-btn-text: #ffffff; --new-chat-btn-hover-bg: #435fe1;
                --history-item-hover-bg: #333333; --history-item-active-bg: #494949; --history-item-active-text: #f9fafb;
                --user-msg-bg: #4d6bfe; --user-msg-text: #ffffff; --ai-msg-bg: #374151; --ai-msg-text: #f9fafb;
                --accent-color: #60a5fa; --error-color: #f87171;
                --context-menu-bg: rgba(33, 35, 39, 0.7); --context-menu-shadow: 0 4px 12px rgba(0,0,0,0.2); --context-menu-hover-bg: rgba(67, 67, 67, 0.7);
                --modal-overlay-bg: rgba(0, 0, 0, 0.6); 
                --modal-bg: rgba(41, 42, 45, 0.7);
                --modal-cancel-btn-bg: #4b5563;
                --modal-error-bg: rgba(60, 45, 45, 0.75);
            }
            * { scrollbar-width: thin; scrollbar-color: var(--modal-cancel-btn-bg) var(--main-bg); }
            ::-webkit-scrollbar { width: 8px; height: 8px; } ::-webkit-scrollbar-track { background: var(--main-bg); } ::-webkit-scrollbar-thumb { background-color: var(--modal-cancel-btn-bg); border-radius: 4px; border: 2px solid var(--main-bg); } ::-webkit-scrollbar-thumb:hover { background-color: var(--text-secondary); }
        }

        html, body { position: relative; height: 100%; width: 100%; overflow: hidden; overscroll-behavior: none; }
        body { font-family: var(--font-family); background-color: var(--sidebar-bg); margin: 0; color: var(--text-primary); display: flex; }
        #app-wrapper { display: flex; width: 100%; height: 100%; }
        #sidebar { background-color: var(--sidebar-bg); color: var(--sidebar-text); width: 260px; display: flex; flex-direction: column; flex-shrink: 0; transition: width 0.3s ease-in-out; padding: 8px; box-sizing: border-box; }
        .sidebar-header { padding-bottom: 8px; display: flex; align-items: center; transition: flex-direction 0.3s ease; }
        #new-chat-button { flex-grow: 1; padding: 10px; border: none; background-color: var(--new-chat-btn-bg); color: var(--new-chat-btn-text); border-radius: 8px; cursor: pointer; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9em; font-weight: 500; display: flex; align-items: center; transition: all 0.2s; }
        #new-chat-button:hover { background-color: var(--new-chat-btn-hover-bg); }
        #sidebar-toggle-button { margin-left: 10px; padding: 0; width: 36px; height: 36px; border: 1px solid var(--border-color); background-color: transparent; color: var(--text-secondary); border-radius: 8px; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 1.5em; }
        #sidebar-toggle-button:hover { background-color: var(--history-item-hover-bg); }
        #history-list-container { list-style: none; margin: 0; padding: 0; overflow-y: auto; flex-grow: 1; }
        .history-group-header { font-size: 0.75em; color: var(--sidebar-group-text); padding: 16px 12px 4px; font-weight: 500; }
        .history-item { padding: 10px 12px; border-radius: 8px; cursor: pointer; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9em; color: var(--sidebar-text); transition: background-color 0.2s, color 0.2s; 
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
        .history-item:hover { background-color: var(--history-item-hover-bg); }
        .history-item.active { background-color: var(--history-item-active-bg); color: var(--history-item-active-text); font-weight: 500; }
        .icon { font-size: 1.5em; display: inline-block; width: 24px; height: 24px; text-align: center; line-height: 24px; margin-right: 12px; }
        #app-wrapper.sidebar-collapsed #sidebar { width: 68px; }
        #app-wrapper.sidebar-collapsed .sidebar-header { flex-direction: column-reverse; align-items: center; gap: 8px; }
        #app-wrapper.sidebar-collapsed #new-chat-button { flex-grow: 0; justify-content: center; width: 36px; height: 36px; padding: 0; }
        #app-wrapper.sidebar-collapsed #new-chat-button span:not(.icon) { display: none; }
        #app-wrapper.sidebar-collapsed #new-chat-button .icon { margin: 0; }
        #app-wrapper.sidebar-collapsed #sidebar-toggle-button { margin: 0; }
        #app-wrapper.sidebar-collapsed #history-list-container { display: none; }
        #context-menu { position: absolute; z-index: 1000; background-color: var(--context-menu-bg); border-radius: 8px; padding: 6px; box-shadow: var(--context-menu-shadow); border: 1px solid var(--border-color); min-width: 160px; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); opacity: 0; visibility: hidden; transform: scale(0.95); transition: opacity 0.1s ease-out, transform 0.1s ease-out, visibility 0.1s; }
        #context-menu.show { opacity: 1; visibility: visible; transform: scale(1); }
        .context-menu-item { position: relative; z-index: 1; display: flex; align-items: center; padding: 8px 12px; border-radius: 6px; cursor: pointer; color: var(--sidebar-text); overflow: hidden; }
        .context-menu-item::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: -1; background-color: var(--context-menu-hover-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); opacity: 0; transition: opacity 0.2s ease; }
        .context-menu-item:hover::before { opacity: 1; }
        .context-menu-item.delete { color: var(--error-color); }
        .context-menu-icon { margin-right: 12px; width: 16px; height: 16px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-overlay-bg); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.2s ease, visibility 0.2s; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-dialog { background-color: var(--modal-bg); padding: 24px; border-radius: 12px; box-shadow: var(--context-menu-shadow); width: 90%; max-width: 400px; border: 1px solid var(--border-color); transform: scale(0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); transition: transform 0.2s ease; }
        .modal-overlay.show .modal-dialog { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .modal-header h2 { margin: 0; font-size: 1.1em; font-weight: 600; color: var(--text-primary); }
        .modal-header .close-btn { background: none; border: none; font-size: 1.5em; color: var(--text-secondary); cursor: pointer; padding: 0; line-height: 1; }
        .modal-body p { margin: 0 0 12px 0; color: var(--text-secondary); font-size: 0.9em; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 12px; }
        .modal-footer button { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 500; transition: opacity 0.2s ease; }
        .modal-footer button:hover:not(:disabled) { opacity: 0.85; }
        .modal-footer .cancel-btn { background-color: var(--modal-cancel-btn-bg); color: var(--text-primary); }
        .modal-footer .confirm-btn { background-color: var(--error-color); color: white; }
        .modal-footer .confirm-btn.import { background-color: var(--accent-color); }
        #error-modal .modal-dialog { background-color: var(--modal-error-bg); }
        #browser-warning-modal .modal-dialog { background-color: var(--modal-error-bg); }
        .modal-footer .confirm-btn.error { background-color: var(--modal-error-btn-bg); color: white; }
        
        .checkbox-wrapper {
            margin-top: 20px;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
            font-size: 15px;
            color: var(--text-secondary);
        }
        .checkbox-visual {
            width: 18px;
            height: 18px;
            border: 2px solid #9ca3af;
            border-radius: 5px;
            margin-right: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: transparent;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .checkbox-visual svg {
            width: 12px;
            height: 12px;
            stroke: white;
            stroke-width: 2.5;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
            transform: scale(0);
            opacity: 0;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.2s ease-out;
        }
        .checkbox-visual svg path {
            stroke-dasharray: 24;
            stroke-dashoffset: 24;
            transition: stroke-dashoffset 0.3s ease-out;
            transition-delay: 0.1s;
        }
        .visually-hidden:checked + .checkbox-container .checkbox-visual {
            background-color: var(--modal-error-btn-bg);
            border-color: var(--modal-error-btn-bg);
        }
        .visually-hidden:checked + .checkbox-container .checkbox-visual svg {
            transform: scale(1);
            opacity: 1;
        }
        .visually-hidden:checked + .checkbox-container .checkbox-visual svg path {
            stroke-dashoffset: 0;
        }
        .checkbox-container:hover .checkbox-visual {
            border-color: #6b7280;
        }
        .visually-hidden:focus-visible + .checkbox-container .checkbox-visual {
            box-shadow: 0 0 0 3px rgba(255, 102, 102, 0.4);
        }
        
        #game-container { flex-grow: 1; background-color: var(--main-bg); display: flex; flex-direction: column; overflow: hidden; height: 100%;}
        #chat-window, header, #input-area { transition: background-color 0.2s, border-color 0.2s; }
        header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); background-color: var(--main-bg); text-align: center; flex-shrink: 0; display: flex; align-items: center; justify-content: center; position: relative; }
        #mobile-menu-toggle { display: none; position: absolute; left: 15px; background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--text-secondary); }
        .title-container { display: flex; align-items: center; gap: 12px; margin: 0 auto; position: relative; }
        .title-container h1 { margin: 0; font-size: 1.2em; color: var(--text-primary); }
        .header-actions { display: flex; align-items: center; gap: 8px; position: absolute; right: 15px; }
        .header-action-btn { padding: 0; width: 28px; height: 28px; border: 1px solid var(--border-color); background-color: transparent; color: var(--text-secondary); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .header-action-btn:hover { background-color: var(--history-item-hover-bg); }
        .header-action-btn svg { width: 16px; height: 16px; fill: currentColor; }
        
        .date-picker-trigger {
            display: flex; align-items: center; justify-content: center; gap: 6px;
            padding: 4px 10px;
            background-color: transparent; border: 1px solid var(--border-color);
            border-radius: 6px; font-size: 0.9em; font-weight: 500;
            color: var(--text-secondary); cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .date-picker-trigger:hover { background-color: var(--history-item-hover-bg); }
        .date-picker-trigger svg { width: 18px; height: 18px; fill: currentColor; flex-shrink: 0; }
        
        #chat-window { flex: 1; padding: 20px; overflow-y: auto; background-color: var(--chat-window-bg); scroll-behavior: smooth; -webkit-overflow-scrolling: touch; min-height: 0; display: flex; flex-direction: column; }
        .message { display: flex; margin-bottom: 15px; animation: fadeIn 0.5s ease-in-out; }
        .message-bubble { max-width: 75%; padding: 10px 15px; border-radius: 18px; word-wrap: break-word; line-height: 1.4; }
        .ai-message { justify-content: flex-start; } .ai-message .message-bubble { background-color: var(--ai-msg-bg); color: var(--ai-msg-text); border-bottom-left-radius: 4px; }
        .user-message { justify-content: flex-end; } .user-message .message-bubble { background-color: var(--user-msg-bg); color: var(--user-msg-text); border-bottom-right-radius: 4px; }
        .system-message { text-align: center; margin: 15px 0; font-size: 0.9em; color: var(--text-secondary); }
        .system-message.success { color: var(--success-color); font-weight: bold; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #input-area { display: flex; padding: 15px; border-top: 1px solid var(--border-color); background-color: var(--main-bg); flex-shrink: 0; align-items: center; }
        #user-input { flex-grow: 1; border: 1px solid var(--border-color); border-radius: 20px; padding: 10px 15px; font-size: 16px; outline: none; transition: border-color 0.3s; background-color: var(--main-bg); color: var(--text-primary); }
        #user-input::placeholder { color: var(--text-secondary); }
        #user-input:focus { border-color: var(--accent-color); }
        #user-input:disabled { background-color: var(--ai-msg-bg); cursor: not-allowed; }
        #send-button { margin-left: 10px; padding: 0; width: 40px; height: 40px; border: none; background-color: var(--accent-color); color: white; border-radius: 50%; cursor: pointer; transition: background-color 0.3s, opacity 0.3s; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        #send-button svg { width: 20px; height: 20px; fill: currentColor; }
        #send-button:hover:not(:disabled) { opacity: 0.85; }
        #send-button:disabled { background-color: var(--accent-color); opacity: 0.5; cursor: not-allowed; }
        #sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 999; }
        .custom-select-wrapper { position: relative; display: inline-block; user-select: none; }
        .select-selected { color: var(--text-primary); font-size: 1.2em; font-weight: bold; cursor: pointer; display: flex; align-items: center; padding: 2px 4px; border-radius: 6px; transition: background-color 0.2s; }
        .select-selected:hover { background-color: var(--ai-msg-bg); }
        .select-arrow { margin-left: 6px; width: 16px; height: 16px; fill: currentColor; transition: transform 0.2s ease; }
        .select-selected.select-arrow-active .select-arrow { transform: rotate(180deg); }
        .select-items { list-style: none; padding: 6px; margin: 0; position: absolute; top: calc(100% + 5px); left: 50%; transform: translateX(-50%); background-color: var(--context-menu-bg); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: var(--context-menu-shadow); min-width: 100px; text-align: center; z-index: 1101; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); opacity: 0; visibility: hidden; transition: opacity 0.1s ease-out, transform 0.1s ease-out, visibility 0.1s; }
        .select-items.show { opacity: 1; visibility: visible; }
        .select-item { color: var(--sidebar-text); padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; position: relative; overflow: hidden; }
        .select-item::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: -1; background-color: var(--context-menu-hover-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); opacity: 0; transition: opacity 0.2s ease; }
        .select-item:hover::before { opacity: 1; }
        .visually-hidden { position: absolute; opacity: 0; width: 0; height: 0; pointer-events: none; }

        /* --- Êó•ÊúüÈÄâÊã©Âô®Ê†∑Âºè --- */
        #date-picker-popover {
            position: absolute; top: calc(100% + 10px); 
            left: 0; 
            transform: scale(0.95); z-index: 1100;
            background-color: var(--context-menu-bg); border-radius: 12px;
            padding: 12px 16px 16px; box-shadow: var(--context-menu-shadow);
            border: 1px solid var(--border-color); width: 300px;
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            user-select: none; opacity: 0; visibility: hidden;
            transform-origin: top center;
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
        }
        #date-picker-popover.show { opacity: 1; visibility: visible; transform: scale(1); }
        .dp-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 4px 0; }
        .dp-month-year { font-weight: 600; font-size: 1.1em; color: var(--text-primary); }
        .dp-nav-btn { display:flex; align-items:center; justify-content:center; background: none; border: 1px solid var(--border-color); width: 32px; height: 32px; cursor: pointer; color: var(--text-primary); font-size: 1.2em; border-radius: 8px; transition: background-color 0.2s, border-color 0.2s, opacity 0.2s; 
            touch-action: manipulation;
        }
        .dp-nav-btn:hover:not(:disabled) { background-color: var(--history-item-hover-bg); }
        .dp-nav-btn.disabled { opacity: 0.4; pointer-events: none; cursor: not-allowed; }
        #dp-weekdays-container { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; padding-bottom: 8px; }
        .dp-weekday { text-align: center; font-size: 0.85em; color: var(--text-secondary); font-weight: 500; }
        .dp-grid-wrapper { position: relative; overflow: hidden; height: 236px; }
        .dp-grid-container { position: absolute; top: 0; left: 0; width: 100%; display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .dp-day { display: flex; justify-content: center; align-items: center; height: 36px; border-radius: 50%; font-size: 0.9em; border: 1px solid transparent; color: var(--text-primary); transition: background-color 0.2s, color 0.2s, border-color 0.2s; }
        .dp-day.other-month { color: var(--text-secondary); }
        .dp-day.disabled { pointer-events: none; opacity: 0.5; }
        .dp-day.available { cursor: pointer; }
        .dp-day.available:hover { background-color: var(--history-item-hover-bg); }
        .dp-day.today { border-color: var(--accent-color); }
        .dp-day.selected { background-color: var(--accent-color); color: white !important; border-color: var(--accent-color); font-weight: bold; }
        .dp-day.selected:hover { opacity: 0.9; background-color: var(--accent-color); }

        @media (max-width: 768px) {
            #sidebar { position: fixed; top: 0; left: -260px; height: 100%; z-index: 1000; transition: left 0.3s ease-in-out; border-right: 1px solid var(--border-color); }
            body.sidebar-open #sidebar { left: 0; }
            body.sidebar-open #sidebar-overlay { display: block; }
            #sidebar-toggle-button { display: none; }
            #mobile-menu-toggle { display: block; }
            #app-wrapper.sidebar-collapsed #sidebar { width: 260px; }
            #app-wrapper.sidebar-collapsed .sidebar-header { flex-direction: row; align-items: center; gap: 0; }
            #app-wrapper.sidebar-collapsed #new-chat-button { width: auto; height: auto; padding: 10px; flex-grow: 1; }
            #app-wrapper.sidebar-collapsed #new-chat-button span:not(.icon) { display: inline-block; }
            #app-wrapper.sidebar-collapsed #new-chat-button .icon { margin-right: 12px; }
            #app-wrapper.sidebar-collapsed #sidebar-toggle-button { display: none; }
            #app-wrapper.sidebar-collapsed #history-list-container { display: block; }
            #game-container { max-width: 100%; border-radius: 0; border: none; }
            header { padding-top: calc(10px + env(safe-area-inset-top)); }
            #input-area { padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
            .header-actions { position: absolute; right: 15px; margin-left: 0; }
            
            .date-picker-trigger { padding: 4px; width: 28px; height: 28px; }
            .date-picker-trigger #daily-puzzle-label { display: none; }
            #date-picker-popover { left: 50%; transform: translateX(-50%) scale(0.95); width: calc(100vw - 20px); max-width: 320px; }
            #date-picker-popover.show { transform: translateX(-50%) scale(1); }
        }
    </style>
</head>
<body>
    <div id="app-wrapper">
        <aside id="sidebar">
            <div class="sidebar-header">
                <button id="new-chat-button"><span class="icon">Ôºã</span><span>ÂºÄÂêØÊñ∞ÂØπËØù</span></button>
                <button id="sidebar-toggle-button" title="Êî∂Ëµ∑/Â±ïÂºÄ‰æßËæπÊ†è">‚Äπ</button>
            </div>
            <div id="history-list-container"></div>
        </aside>
        <div id="sidebar-overlay"></div>
        <main id="game-container">
            <header>
                <button id="mobile-menu-toggle">‚ò∞</button>
                <div class="title-container">
                    <h1>ÁåúÁõê - </h1>
                    <div id="game-mode-dropdown" class="custom-select-wrapper"></div>
                    <button id="daily-puzzle-button" class="date-picker-trigger" title="ÈÄâÊã©ÂæÄÊó•Ë∞úÈ¢ò" style="display: none;">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21 8.5v9.25A3.25 3.25 0 0 1 17.75 21H6.25A3.25 3.25 0 0 1 3 17.75V8.5h18ZM7.25 15a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5ZM12 15a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5Zm-4.75-4.5a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5Zm4.75 0a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5Zm4.75 0a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5Zm1-7.5A3.25 3.25 0 0 1 21 6.25V7H3v-.75A3.25 3.25 0 0 1 6.25 3h11.5Z" fill="currentColor"/></svg>
                        <span id="daily-puzzle-label">ÈÄâÊã©Êó•Êúü</span>
                    </button>
                    <div id="date-picker-popover">
                        <div class="dp-header">
                            <button id="dp-prev-month" class="dp-nav-btn" title="‰∏ä‰∏™Êúà">&lt;</button>
                            <div id="dp-month-year" class="dp-month-year"></div>
                            <button id="dp-next-month" class="dp-nav-btn" title="‰∏ã‰∏™Êúà">&gt;</button>
                        </div>
                        <div id="dp-weekdays-container"></div>
                        <div class="dp-grid-wrapper"></div>
                    </div>
                </div>
                <div class="header-actions">
                    <button id="export-button" class="header-action-btn" title="ÂØºÂá∫ÂéÜÂè≤ËÆ∞ÂΩï">
                        <svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M6.25 4.75a1.5 1.5 0 0 0-1.5 1.5v11.5a1.5 1.5 0 0 0 1.5 1.5h11.5a1.5 1.5 0 0 0 1.5-1.5v-4a1 1 0 1 1 2 0v4a3.5 3.5 0 0 1-3.5 3.5H6.25a3.5 3.5 0 0 1-3.5-3.5V6.25a3.5 3.5 0 0 1 3.5-3.5h4a1 1 0 1 1 0 2h-4Zm6.5-1a1 1 0 0 1 1-1h6.5a1 1 0 0 1 1 1v6.5a1 1 0 1 1-2 0V6.164l-4.793 4.793a1 1 0 1 1-1.414-1.414l4.793-4.793H13.75a1 1 0 0 1-1-1Z"/></svg>
                    </button>
                    <button id="import-button" class="header-action-btn" title="ÂØºÂÖ•ÂéÜÂè≤ËÆ∞ÂΩï">
                        <svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21.25 4.5a.75.75 0 0 1 .743.648L22 5.25v13.5a.75.75 0 0 1-1.493.102l-.007-.102V5.25a.75.75 0 0 1 .75-.75Zm-9.04 1.887.083-.094a1 1 0 0 1 1.32-.083l.094.083 4.997 4.998a1 1 0 0 1 .083 1.32l-.083.093-4.996 5.004a1 1 0 0 1-1.499-1.32l.083-.094L15.581 13H3a1 1 0 0 1-.993-.883L2 12a1 1 0 0 1 .883-.993L3 11h12.584l-3.291-3.293a1 1 0 0 1-.083-1.32l.083-.094-.083.094Z"/></svg>
                    </button>
                </div>
            </header>
            <div id="chat-window"></div>
            <div id="input-area">
                <input type="text" id="user-input" placeholder="ËØ∑ËæìÂÖ•‰Ω†ÁöÑÊèêÈóÆÊàñËØäÊñ≠..." disabled>
                <button id="send-button" disabled title="ÂèëÈÄÅ">
                    <svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m12.815 12.197-7.532 1.256a.5.5 0 0 0-.386.318L2.3 20.728c-.248.64.421 1.25 1.035.943l18-9a.75.75 0 0 0 0-1.342l-18-9c-.614-.307-1.283.304-1.035.943l2.598 6.957a.5.5 0 0 0 .386.319l7.532 1.255a.2.2 0 0 1 0 .394Z"/></svg>
                </button>
            </div>
        </main>
    </div>

    <input type="file" id="import-file-input" accept=".json" style="display: none;">

    <div id="context-menu">
        <div class="context-menu-item" id="rename-option"><svg class="context-menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25-1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg><span>ÈáçÂëΩÂêç</span></div>
        <div class="context-menu-item delete" id="delete-option"><svg class="context-menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.58.22-2.365.468a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193v-.443A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25-.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" /></svg><span>Âà†Èô§</span></div>
    </div>
    
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal-dialog"><div class="modal-header"><h2 id="confirm-modal-title">Ê∞∏‰πÖÂà†Èô§ÂØπËØù</h2><button class="close-btn" id="confirm-modal-close-btn">√ó</button></div><div class="modal-body"><p id="confirm-modal-message">Âà†Èô§ÂêéÔºåËØ•ÂØπËØùÂ∞Ü‰∏çÂèØÊÅ¢Â§ç„ÄÇÁ°ÆËÆ§Âà†Èô§ÂêóÔºü</p></div><div class="modal-footer"><button class="cancel-btn" id="confirm-modal-cancel-btn">ÂèñÊ∂à</button><button class="confirm-btn" id="confirm-modal-confirm-btn">Âà†Èô§</button></div></div>
    </div>

    <div class="modal-overlay" id="info-modal">
        <div class="modal-dialog"><div class="modal-header"><h2 id="info-modal-title">ÊèêÁ§∫</h2><button class="close-btn" id="info-modal-close-btn">√ó</button></div><div class="modal-body"><p id="info-modal-message"></p></div><div class="modal-footer"><button class="confirm-btn import" id="info-modal-ok-btn">Â•ΩÁöÑ</button></div></div>
    </div>

    <div class="modal-overlay" id="error-modal">
        <div class="modal-dialog"><div class="modal-header"><h2 id="error-modal-title">ÈîôËØØ</h2><button class="close-btn" id="error-modal-close-btn">√ó</button></div><div class="modal-body"><p id="error-modal-message"></p></div><div class="modal-footer"><button class="confirm-btn error" id="error-modal-ok-btn">Â•ΩÁöÑ</button></div></div>
    </div>
    
    <!-- Êñ∞Â¢ûÔºöÊµèËßàÂô®ÂÖºÂÆπÊÄßË≠¶ÂëäÊ®°ÊÄÅÊ°Ü -->
    <div class="modal-overlay" id="browser-warning-modal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h2 id="browser-warning-title">ÊµèËßàÂô®ÂÖºÂÆπÊÄßÊèêÁ§∫</h2>
                <button class="close-btn" id="browser-warning-close-btn">√ó</button>
            </div>
            <div class="modal-body">
                <p id="browser-warning-message"></p>
                <div class="checkbox-wrapper">
                    <input class="visually-hidden" type="checkbox" id="dont-show-again-checkbox">
                    <label class="checkbox-container" for="dont-show-again-checkbox">
                        <span class="checkbox-visual">
                            <svg viewBox="0 0 20 20">
                                <path d="M4 10 L8 14 L16 6"></path>
                            </svg>
                        </span>
                        <span>‰∏çÂÜçÊòæÁ§∫Ê≠§Ë≠¶Âëä</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="confirm-btn error" id="browser-warning-ok-btn">Â•ΩÁöÑ</button>
            </div>
        </div>
    </div>


    <script>
        // --- DOM Elements ---
        const appWrapper = document.getElementById('app-wrapper');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggleButton = document.getElementById('sidebar-toggle-button');
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const newChatButton = document.getElementById('new-chat-button');
        const historyListContainer = document.getElementById('history-list-container');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const gameModeDropdown = document.getElementById('game-mode-dropdown');
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const contextMenu = document.getElementById('context-menu');
        const renameOption = document.getElementById('rename-option');
        const deleteOption = document.getElementById('delete-option');
        const exportButton = document.getElementById('export-button');
        const importButton = document.getElementById('import-button');
        const importFileInput = document.getElementById('import-file-input');
        const dailyPuzzleButton = document.getElementById('daily-puzzle-button');
        const datePickerPopover = document.getElementById('date-picker-popover');
        const dpMonthYear = document.getElementById('dp-month-year');
        const dpPrevMonthBtn = document.getElementById('dp-prev-month');
        const dpNextMonthBtn = document.getElementById('dp-next-month');
        const dpWeekdaysContainer = document.getElementById('dp-weekdays-container');
        const dpGridWrapper = document.querySelector('#date-picker-popover .dp-grid-wrapper');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalMessage = document.getElementById('confirm-modal-message');
        const confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm-btn');
        const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn');
        const confirmModalCloseBtn = document.getElementById('confirm-modal-close-btn');
        const infoModal = document.getElementById('info-modal');
        const infoModalTitle = document.getElementById('info-modal-title');
        const infoModalMessage = document.getElementById('info-modal-message');
        const infoModalOkBtn = document.getElementById('info-modal-ok-btn');
        const infoModalCloseBtn = document.getElementById('info-modal-close-btn');
        const errorModal = document.getElementById('error-modal');
        const errorModalTitle = document.getElementById('error-modal-title');
        const errorModalMessage = document.getElementById('error-modal-message');
        const errorModalOkBtn = document.getElementById('error-modal-ok-btn');
        const errorModalCloseBtn = document.getElementById('error-modal-close-btn');
        // Êñ∞Â¢ûÔºöÊµèËßàÂô®Ë≠¶ÂëäÊ®°ÊÄÅÊ°ÜÂÖÉÁ¥†
        const browserWarningModal = document.getElementById('browser-warning-modal');
        const browserWarningTitle = document.getElementById('browser-warning-title');
        const browserWarningMessage = document.getElementById('browser-warning-message');
        const browserWarningOkBtn = document.getElementById('browser-warning-ok-btn');
        const browserWarningCloseBtn = document.getElementById('browser-warning-close-btn');
        const dontShowAgainCheckbox = document.getElementById('dont-show-again-checkbox');
        
        // --- App State & Constants ---
        const BASE_HEADERS = { 'Accept': 'application/json', 'Accept-Language': 'zh-CN,zh;q=0.9', 'Origin': 'https://xiaoce.fun', 'Referer': 'https://xiaoce.fun/guessdisease', 'Fun-Device': 'web', 'Dnt': '1' };
        const GAME_MODES = {
            disease: { title: 'ÁåúÁóÖ', typeParam: 'guess_disease', apiUrl: 'https://xiaoce.fun/api/v0/quiz/daily/guessDisease/sendMessage', storagePrefix: 'guessDisease_chat_', activeKey: 'activeGuessDiseaseChat', greeting: '‰Ω†Â•ΩÔºåÂåªÁîü„ÄÇ', placeholder: 'ËØ∑ËæìÂÖ•‰Ω†ÁöÑÊèêÈóÆÊàñËØäÊñ≠‚Ä¶', successMessage: 'üéâ ÊÅ≠Âñú‰Ω†ÔºåËØäÊñ≠Ê≠£Á°ÆÔºÅÊ∏∏ÊàèËÉúÂà©ÔºÅ üéâ' },
            crime: { title: 'ÁåúÁΩ™', typeParam: 'guess_crime', apiUrl: 'https://xiaoce.fun/api/v0/quiz/daily/guessCrime/sendMessage', storagePrefix: 'guessCrime_chat_', activeKey: 'activeGuessCrimeChat', greeting: '‰Ω†Â•ΩÔºåÂæãÂ∏à„ÄÇ', placeholder: 'ËØ∑ËæìÂÖ•‰Ω†ÁöÑÊèêÈóÆÊàñÁΩ™ÂêçÁåúÊµã', successMessage: 'üéâ ÊÅ≠Âñú‰Ω†ÔºåÁåúÁΩ™Ê≠£Á°ÆÔºÅÊ∏∏ÊàèËÉúÂà©ÔºÅ üéâ' }
        };
        let currentGameMode = 'disease';
        let chatHistory = [];
        let currentChatKey = null;
        let chatId = "";
        let isGameActive = false;
        let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        let contextMenuTarget = null;
        let dailySuccessCount = null;
        let currentVictoryRank = null;
        let targetDate = null;
        let activeDatesCache = {};
        let dpDisplayDate = new Date();
        let dpSelectedDate = null;
        let dpAnimationAbortController = null;
        
        // --- Êó•ÊúüÂíåÊ†ºÂºèÂåñÂ∑•ÂÖ∑ ---
        function getLocalISOString(date = new Date()) {
            const d = date;
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}T${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}:${String(d.getSeconds()).padStart(2, '0')}`;
        }

        function getFormattedDate(date = new Date()) {
            return `${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}${String(date.getDate()).padStart(2, '0')}`;
        }
        
        async function fetchActiveDates() {
            const config = GAME_MODES[currentGameMode];
            if (activeDatesCache[currentGameMode]) {
                return activeDatesCache[currentGameMode];
            }
            try {
                const response = await fetch(`https://xiaoce.fun/api/v0/quiz/daily/general/fetchActive?type=${config.typeParam}`, { method: 'GET', headers: BASE_HEADERS });
                if (!response.ok) throw new Error('API request failed');
                const result = await response.json();
                if (result.success && Array.isArray(result.data)) {
                    const dates = new Set(result.data);
                    activeDatesCache[currentGameMode] = dates;
                    return dates;
                }
                return new Set();
            } catch (error) {
                console.error("Ëé∑ÂèñÂèØÈÄâÊó•ÊúüÂ§±Ë¥•:", error);
                await showErrorDialog({ title: 'ÁΩëÁªúÈîôËØØ', message: 'Êó†Ê≥ïËé∑ÂèñÂæÄÊó•Ë∞úÈ¢òÂàóË°®ÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ' });
                return null;
            }
        }

        function createCalendarGrid(date, activeDatesSet) {
            const grid = document.createElement('div');
            grid.className = 'dp-grid-container';
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startDayOfWeek = firstDayOfMonth.getDay();
            const prevMonth = new Date(year, month, 0);
            const daysInPrevMonth = prevMonth.getDate();
            let dateCounter = 1;
            let nextMonthCounter = 1;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = 0; i < 42; i++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'dp-day';
                let cellDate, isCurrentMonth = false;

                if (i < startDayOfWeek) {
                    cellDate = new Date(year, month - 1, daysInPrevMonth - startDayOfWeek + i + 1);
                    dayCell.textContent = cellDate.getDate();
                } else if (dateCounter <= daysInMonth) {
                    cellDate = new Date(year, month, dateCounter);
                    dayCell.textContent = dateCounter;
                    isCurrentMonth = true;
                    dateCounter++;
                } else {
                    cellDate = new Date(year, month + 1, nextMonthCounter);
                    dayCell.textContent = nextMonthCounter;
                    nextMonthCounter++;
                }
                const dateApiString = getFormattedDate(cellDate);
                dayCell.dataset.date = dateApiString;

                if (activeDatesSet.has(dateApiString) && isCurrentMonth) {
                    dayCell.classList.add('available');
                } else {
                    dayCell.classList.add('disabled');
                }
                if (!isCurrentMonth) {
                    dayCell.classList.add('other-month');
                }
                if (cellDate.getTime() === today.getTime()) {
                    dayCell.classList.add('today');
                }
                if (dpSelectedDate && cellDate.getTime() === dpSelectedDate.getTime()) {
                    dayCell.classList.add('selected');
                }
                grid.appendChild(dayCell);
            }
            return grid;
        }

        function updateNavButtonStates(activeDatesSet) {
            const sortedDates = [...activeDatesSet].sort();
            if (sortedDates.length === 0) {
                dpPrevMonthBtn.disabled = true;
                dpPrevMonthBtn.classList.add('disabled');
                dpNextMonthBtn.disabled = true;
                dpNextMonthBtn.classList.add('disabled');
                return;
            };
            const firstAvailableDateStr = sortedDates[0];
            const minMonthDate = new Date(parseInt(firstAvailableDateStr.substring(0, 4), 10), parseInt(firstAvailableDateStr.substring(4, 6), 10) - 1, 1);
            const today = new Date();
            const maxMonthDate = new Date(today.getFullYear(), today.getMonth(), 1);

            const currentMonthStart = new Date(dpDisplayDate.getFullYear(), dpDisplayDate.getMonth(), 1);
            
            const isPrevDisabled = currentMonthStart.getTime() <= minMonthDate.getTime();
            dpPrevMonthBtn.disabled = isPrevDisabled;
            dpPrevMonthBtn.classList.toggle('disabled', isPrevDisabled);

            const isNextDisabled = currentMonthStart.getTime() >= maxMonthDate.getTime();
            dpNextMonthBtn.disabled = isNextDisabled;
            dpNextMonthBtn.classList.toggle('disabled', isNextDisabled);
        }

        function transitionToMonth(direction, activeDatesSet) {
            if (direction === 'prev' && dpPrevMonthBtn.disabled) return;
            if (direction === 'next' && dpNextMonthBtn.disabled) return;

            if (dpAnimationAbortController) {
                dpAnimationAbortController.abort();
            }
            dpAnimationAbortController = new AbortController();
            const signal = dpAnimationAbortController.signal;
            
            const existingGrids = dpGridWrapper.querySelectorAll('.dp-grid-container');
            let oldGrid = existingGrids.length > 0 ? existingGrids[existingGrids.length - 1] : null;
            
            if (existingGrids.length > 1) {
                existingGrids[0].remove();
            }

            dpDisplayDate.setMonth(dpDisplayDate.getMonth() + (direction === 'next' ? 1 : -1));
            const newGrid = createCalendarGrid(dpDisplayDate, activeDatesSet);
            
            newGrid.style.transition = 'none';
            newGrid.style.transform = `translateX(${direction === 'next' ? '100%' : '-100%'})`;
            dpGridWrapper.appendChild(newGrid);
            
            newGrid.offsetHeight; 

            const transitionStyle = 'transform 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
            newGrid.style.transition = transitionStyle;
            if (oldGrid) oldGrid.style.transition = transitionStyle;

            if (oldGrid) {
                oldGrid.style.transform = `translateX(${direction === 'next' ? '-100%' : '100%'})`;
            }
            newGrid.style.transform = 'translateX(0)';

            newGrid.addEventListener('transitionend', () => {
                if (oldGrid) oldGrid.remove();
            }, { signal });

            dpMonthYear.textContent = `${dpDisplayDate.getFullYear()}Âπ¥ ${dpDisplayDate.getMonth() + 1}Êúà`;
            updateNavButtonStates(activeDatesSet);
        }
        
        // --- Ê†∏ÂøÉÂäüËÉΩÂáΩÊï∞ ---
        function scrollToBottom() {
            chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior: 'smooth' });
        }
        function renderMessage({ text, sender, type }) {
            const messageDiv = document.createElement('div');
            messageDiv.className = sender === 'system' ? `system-message ${type}` : `message ${sender}-message`;
            if (sender !== 'system') {
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.textContent = text;
                messageDiv.appendChild(bubble);
            } else {
                messageDiv.textContent = text;
            }
            chatWindow.appendChild(messageDiv);
            scrollToBottom();
        }
        function setInputState(enabled, placeholderText = "") {
            userInput.disabled = !enabled;
            sendButton.disabled = !enabled;
            if (placeholderText) {
                userInput.placeholder = placeholderText;
            }
        }
        
        async function saveHistory(firstUserMessage = null) {
            if (!currentChatKey) return;
            const config = GAME_MODES[currentGameMode];
            try {
                const existingData = JSON.parse(localStorage.getItem(currentChatKey) || '{}');
                const dataToSave = { ...existingData, messages: chatHistory, chatId: chatId, isGameActive: isGameActive, victoryRank: currentVictoryRank };
                if (firstUserMessage) {
                    dataToSave.title = firstUserMessage.length > 28 ? firstUserMessage.substring(0, 28) + '...' : firstUserMessage;
                }
                localStorage.setItem(currentChatKey, JSON.stringify(dataToSave));
                if (firstUserMessage) {
                    localStorage.setItem(config.activeKey, currentChatKey);
                }
                populateSidebar();
            } catch (error) {
                console.error("‰øùÂ≠òËÅäÂ§©ËÆ∞ÂΩïÂ§±Ë¥•:", error);
                await showErrorDialog({ title: '‰øùÂ≠òÂ§±Ë¥•', message: 'Êó†Ê≥ï‰øùÂ≠òËÅäÂ§©ËÆ∞ÂΩï„ÄÇËØ∑Ê£ÄÊü•ÊµèËßàÂô®ËÆæÁΩÆÊàñÁ£ÅÁõòÁ©∫Èó¥„ÄÇ' });
            }
        }
        
        async function loadChat(keyToLoad) {
            const config = GAME_MODES[currentGameMode];
            const savedData = localStorage.getItem(keyToLoad);
            if (!savedData) {
                await startNewChat();
                return;
            };
            try {
                const data = JSON.parse(savedData);
                currentChatKey = keyToLoad;
                targetDate = null;
                dpSelectedDate = null;
                localStorage.setItem(config.activeKey, keyToLoad); 
                chatHistory = data.messages || [];
                chatId = data.chatId || "";
                isGameActive = typeof data.isGameActive === 'boolean' ? data.isGameActive : false;
                currentVictoryRank = data.victoryRank || null;
                chatWindow.innerHTML = '';
                renderMessage({ text: config.greeting, sender: 'ai' });
                chatHistory.forEach(msg => renderMessage(msg));
                if (isGameActive) {
                    const puzzleDate = keyToLoad.substring(config.storagePrefix.length, config.storagePrefix.length + 10);
                    dailySuccessCount = await fetchSuccessCount(puzzleDate);
                } else {
                    dailySuccessCount = null;
                }
                updateUIForLoadedChat();
            } catch (error) {
                console.error("Âä†ËΩΩËÅäÂ§©ËÆ∞ÂΩïÂ§±Ë¥•:", error);
                await startNewChat();
            }
        }
        
        async function startNewChat(selectedDate = null) {
            const config = GAME_MODES[currentGameMode];
            currentChatKey = null;
            chatId = "";
            isGameActive = true;
            currentVictoryRank = null;
            localStorage.setItem(config.activeKey, 'new');
            chatWindow.innerHTML = '';
            
            targetDate = selectedDate;
            
            renderMessage({ text: config.greeting, sender: 'ai' });
            
            if (selectedDate) {
                dailySuccessCount = await fetchSuccessCount(selectedDate.replace(/-/g, ''));
            } else {
                dailySuccessCount = await fetchSuccessCount();
            }
            
            populateSidebar();
            updateUIForLoadedChat();
            if (isMobile) {
                document.body.classList.remove('sidebar-open');
            }
        }

        function updateCalendarButtonVisibility() {
            const isNewChat = currentChatKey === null;
            dailyPuzzleButton.style.display = isNewChat ? 'flex' : 'none';
        }
        
        function updateUIForLoadedChat() {
            updateCalendarButtonVisibility();
            const config = GAME_MODES[currentGameMode];
            let placeholder = "";
            if (isGameActive) {
                placeholder = config.placeholder;
                const isNewChat = currentChatKey === null;
                if (!isMobile && dailySuccessCount !== null) {
                    const dayText = isNewChat && !targetDate ? '‰ªäÊó•' : 'ËØ•Êó•';
                    placeholder += ` ${dayText}Â∑≤Êúâ ${dailySuccessCount.toLocaleString()} ‰∫∫ÁåúÂá∫Ë∞úÂ∫ï`;
                }
            } else {
                if (currentVictoryRank !== null) {
                    placeholder = `ÊÇ®ÊòØËØ•Êó•Á¨¨ ${currentVictoryRank.toLocaleString()} ‰ΩçÁåúÂá∫Ë∞úÂ∫ïÁöÑ‰∫∫ÔºÅüéâ`;
                } else {
                    placeholder = "ÊÅ≠Âñú‰Ω†ÔºåÂ∑≤ÁåúÂá∫Ë∞úÂ∫ïÔºÅËØ∑ÂºÄÂêØÊñ∞ÂØπËØù„ÄÇ";
                }
            }
            setInputState(isGameActive, placeholder);
            document.querySelectorAll('.history-item').forEach(item => {
                item.classList.toggle('active', item.dataset.key === currentChatKey);
            });
            if (!isMobile) {
                userInput.focus();
            }
        }
        
        async function fetchSuccessCount(puzzleDateStr = null) {
            const config = GAME_MODES[currentGameMode];
            let dateForApi = puzzleDateStr ? puzzleDateStr.replace(/-/g, '') : getFormattedDate();
            const url = `https://xiaoce.fun/api/v0/quiz/daily/getStatus?type=${config.typeParam}&date=${dateForApi}`;
            try {
                const response = await fetch(url, { method: 'GET', headers: BASE_HEADERS });
                if (!response.ok) return null;
                const data = await response.json();
                return (data.success && data.data) ? data.data.success : null;
            } catch (error) {
                console.error("Ëé∑ÂèñÊàêÂäü‰∫∫Êï∞Êó∂ÂèëÁîüÁΩëÁªúÈîôËØØ:", error);
                return null;
            }
        }

        async function sendMessage() {
            const messageText = userInput.value.trim();
            if (!messageText || !isGameActive) return;
            const config = GAME_MODES[currentGameMode];
            const isFirstMessage = (currentChatKey === null);
            let puzzleDateForApi;

            if (isFirstMessage) {
                const baseDate = targetDate ? new Date(targetDate + "T12:00:00") : new Date();
                currentChatKey = config.storagePrefix + getLocalISOString(baseDate);
                puzzleDateForApi = targetDate ? targetDate.replace(/-/g, '') : getFormattedDate();
            } else {
                puzzleDateForApi = currentChatKey.substring(config.storagePrefix.length, config.storagePrefix.length + 10).replace(/-/g, '');
            }
            
            chatHistory.push({ text: messageText, sender: 'user' });
            renderMessage({ text: messageText, sender: 'user' });
            userInput.value = '';
            setInputState(false, "AIÊÄùËÄÉ‰∏≠...");

            try {
                const response = await fetch(config.apiUrl, { method: 'POST', headers: { ...BASE_HEADERS, 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' }, body: `date=${puzzleDateForApi}&chatId=${chatId}&message=${encodeURIComponent(messageText)}` });
                const data = await response.json();
                if (!response.ok || !data.success) throw new Error(data.message || `ËØ∑Ê±ÇÂ§±Ë¥•: ${response.status}`);
                const d = data.data || {};
                if (d.chatId) chatId = d.chatId;
                const aiMessage = { text: d.answer || "Êàë‰∏çÁü•ÈÅìËØ•ÊÄé‰πàÂõûÁ≠î„ÄÇ", sender: 'ai' };
                chatHistory.push(aiMessage);
                renderMessage(aiMessage);
                if (d.right) {
                    isGameActive = false;
                    const successMsg = { text: config.successMessage, sender: 'system', type: 'success'};
                    chatHistory.push(successMsg);
                    renderMessage(successMsg);
                    currentVictoryRank = await fetchSuccessCount(puzzleDateForApi);
                }
                updateUIForLoadedChat(); 
            } catch (error) {
                console.error("ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•:", error);
                chatHistory.pop();
                if (chatWindow.lastChild) chatWindow.lastChild.remove();
                const errorMsg = { text: `ÈîôËØØ: Ê∂àÊÅØÂèëÈÄÅÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÂπ∂ÈáçËØï„ÄÇ`, sender: 'system', type: 'error' };
                chatHistory.push(errorMsg);
                renderMessage(errorMsg);
                userInput.value = messageText;
                setInputState(true, "ÂèëÁîüÈîôËØØÔºåËØ∑ÈáçËØï");
            } finally {
                await saveHistory(isFirstMessage ? messageText : null);
                if (!isMobile) userInput.focus();
            }
        }

        async function checkBrowserCompatibility() {
            // ‰ºòÂÖàÊ£ÄÊü•Ê∞∏‰πÖÂøΩÁï•Ê†áËÆ∞
            if (localStorage.getItem('suppressBrowserWarning') === 'true') {
                return;
            }
            // ÁÑ∂ÂêéÊ£ÄÊü•‰ºöËØùÂøΩÁï•Ê†áËÆ∞
            if (sessionStorage.getItem('browserVersionWarningShown') === 'true') {
                return;
            }

            const isFeatureSupported = () => {
                const testEl = document.createElement('div');
                testEl.style.display = 'flex';
                testEl.style.gap = '1px';
                const isGapSupported = testEl.style.gap === '1px';
                const isBackdropSupported = 'backdropFilter' in testEl.style || 'webkitBackdropFilter' in testEl.style;
                return isGapSupported && isBackdropSupported;
            };
            
            if (!isFeatureSupported()) {
                // Ë∞ÉÁî®Êñ∞ÁöÑ„ÄÅÂ∏¶Â§çÈÄâÊ°ÜÁöÑË≠¶ÂëäÂØπËØùÊ°Ü
                await showBrowserWarningDialog({
                    title: 'ÊµèËßàÂô®ÂÖºÂÆπÊÄßÊèêÁ§∫',
                    message: 'ÊÇ®ÂΩìÂâçÁöÑÊµèËßàÂô®ÁâàÊú¨Ëøá‰ΩéÔºåÈÉ®ÂàÜËßÜËßâÊïàÊûúÂíåÂ∏ÉÂ±ÄÂèØËÉΩÊó†Ê≥ïÂÆåÁæéÊòæÁ§∫„ÄÇÂª∫ËÆÆÂçáÁ∫ßÂà∞ÊúÄÊñ∞ÁâàÊú¨ÁöÑÁé∞‰ª£ÊµèËßàÂô®ÔºàÂ¶ÇChrome, Firefox, EdgeÔºâ‰ª•Ëé∑ÂæóÊúÄ‰Ω≥‰ΩìÈ™å„ÄÇ'
                });
            }
        }
        function getRelativeDateGroup(dateStr) {
            const today = new Date();
            const date = new Date(dateStr);
            today.setHours(0, 0, 0, 0);
            date.setHours(0, 0, 0, 0);
            const diffDays = (today - date) / 864e5;
            if (diffDays === 0) return "‰ªäÂ§©";
            if (diffDays === 1) return "Êò®Â§©";
            if (diffDays < 7) return "7Â§©ÂÜÖ";
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        }
        function populateSidebar() {
            const config = GAME_MODES[currentGameMode];
            const prefix = config.storagePrefix;
            const chats = Object.keys(localStorage).filter(k => k.startsWith(prefix)).map(key => ({ key, data: JSON.parse(localStorage.getItem(key) || '{}') })).filter(chat => chat.data && chat.data.title).sort((a, b) => b.key.localeCompare(a.key));
            const groups = {};
            chats.forEach(chat => {
                const dateStr = chat.key.substring(prefix.length, prefix.length + 10);
                const groupName = getRelativeDateGroup(dateStr);
                if (!groups[groupName]) {
                    groups[groupName] = [];
                }
                groups[groupName].push(chat);
            });
            historyListContainer.innerHTML = '';
            const groupOrder = ["‰ªäÂ§©", "Êò®Â§©", "7Â§©ÂÜÖ"];
            const sortedGroupNames = Object.keys(groups).sort((a, b) => {
                const aIndex = groupOrder.indexOf(a);
                const bIndex = groupOrder.indexOf(b);
                if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
                if (aIndex !== -1) return -1;
                if (bIndex !== -1) return 1;
                return b.localeCompare(a);
            });
            sortedGroupNames.forEach(groupName => {
                const header = document.createElement('div');
                header.className = 'history-group-header';
                header.textContent = groupName;
                historyListContainer.appendChild(header);
                groups[groupName].forEach(({ key, data }) => {
                    const li = document.createElement('div');
                    li.className = 'history-item';
                    li.dataset.key = key;
                    li.innerHTML = `<span>${data.title}</span>`;
                    li.title = data.title;
                    if (key === currentChatKey) li.classList.add('active');
                    li.addEventListener('click', () => loadChat(key));
                    historyListContainer.appendChild(li);
                });
            });
        }
        function handleRename() {
            if (!contextMenuTarget) return;
            const key = contextMenuTarget.dataset.key;
            const titleSpan = contextMenuTarget.querySelector('span');
            const currentTitle = titleSpan.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentTitle;
            input.style.cssText = 'width:100%;padding:0;margin:0;border:none;background:transparent;color:inherit;font:inherit;outline:none;';
            contextMenuTarget.replaceChild(input, titleSpan);
            input.focus();
            input.select();
            const saveRename = () => {
                const newTitle = input.value.trim();
                if (newTitle && newTitle !== currentTitle) {
                    try {
                        const savedData = JSON.parse(localStorage.getItem(key) || '{}');
                        savedData.title = newTitle;
                        localStorage.setItem(key, JSON.stringify(savedData));
                    } catch (e) { console.error("ÈáçÂëΩÂêçÂ§±Ë¥•", e); }
                }
                titleSpan.textContent = newTitle || currentTitle;
                contextMenuTarget.replaceChild(titleSpan, input);
            };
            input.addEventListener('blur', saveRename);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') input.blur();
                if (e.key === 'Escape') contextMenuTarget.replaceChild(titleSpan, input);
            });
        }

        // Êñ∞Â¢ûÔºöÊµèËßàÂô®Ë≠¶ÂëäÂØπËØùÊ°ÜÂáΩÊï∞
        function showBrowserWarningDialog({ title = 'ÊèêÁ§∫', message = '' }) {
            return new Promise(resolve => {
                browserWarningTitle.textContent = title;
                browserWarningMessage.textContent = message;
                dontShowAgainCheckbox.checked = false; // ÊØèÊ¨°ÊâìÂºÄÈÉΩÈáçÁΩÆÂ§çÈÄâÊ°ÜÁä∂ÊÄÅ
                let resolver = null;

                const show = () => { browserWarningModal.classList.add('show'); };
                
                const hide = () => {
                    // Ê†∏ÂøÉÈÄªËæëÔºöÂú®ÂÖ≥Èó≠Êó∂Ê£ÄÊü•Â§çÈÄâÊ°Ü
                    if (dontShowAgainCheckbox.checked) {
                        localStorage.setItem('suppressBrowserWarning', 'true');
                    }
                    // Êó†ËÆ∫Â¶Ç‰ΩïÔºåÈÉΩËÆæÁΩÆ‰ºöËØùÂ≠òÂÇ®Ôºå‰ª•‰æøÂú®ÂΩìÂâç‰ºöËØù‰∏≠‰∏çÂÜçÊòæÁ§∫
                    sessionStorage.setItem('browserVersionWarningShown', 'true');

                    browserWarningModal.classList.remove('show');
                    if (resolver) { resolver(); resolver = null; }
                    browserWarningOkBtn.removeEventListener('click', handleAction);
                    browserWarningCloseBtn.removeEventListener('click', handleAction);
                    browserWarningModal.removeEventListener('click', handleOverlayClick);
                };

                const handleAction = () => hide();
                const handleOverlayClick = (e) => { if (e.target === browserWarningModal) { handleAction(); } };

                browserWarningOkBtn.addEventListener('click', handleAction);
                browserWarningCloseBtn.addEventListener('click', handleAction);
                browserWarningModal.addEventListener('click', handleOverlayClick);
                
                show();
                resolver = resolve;
            });
        }

        function showErrorDialog({ title = 'ÈîôËØØ', message = '' }) {
            return new Promise(resolve => {
                errorModalTitle.textContent = title;
                errorModalMessage.textContent = message;
                let resolver = null;
                const show = () => { errorModal.classList.add('show'); };
                const hide = () => {
                    errorModal.classList.remove('show');
                    if (resolver) { resolver(); resolver = null; }
                    errorModalOkBtn.removeEventListener('click', handleAction);
                    errorModalCloseBtn.removeEventListener('click', handleAction);
                    errorModal.removeEventListener('click', handleOverlayClick);
                };
                const handleAction = () => hide();
                const handleOverlayClick = (e) => { if (e.target === errorModal) { handleAction(); } };
                errorModalOkBtn.addEventListener('click', handleAction);
                errorModalCloseBtn.addEventListener('click', handleAction);
                errorModal.addEventListener('click', handleOverlayClick);
                show();
                resolver = resolve;
            });
        }
        function showInfoDialog({ title = 'ÊèêÁ§∫', message = '' }) {
            return new Promise(resolve => {
                infoModalTitle.textContent = title;
                infoModalMessage.textContent = message;
                let resolver = null;
                const show = () => { infoModal.classList.add('show'); };
                const hide = () => {
                    infoModal.classList.remove('show');
                    if (resolver) { resolver(); resolver = null; }
                    infoModalOkBtn.removeEventListener('click', handleAction);
                    infoModalCloseBtn.removeEventListener('click', handleAction);
                    infoModal.removeEventListener('click', handleOverlayClick);
                };
                const handleAction = () => hide();
                const handleOverlayClick = (e) => { if (e.target === infoModal) { handleAction(); } };
                infoModalOkBtn.addEventListener('click', handleAction);
                infoModalCloseBtn.addEventListener('click', handleAction);
                infoModal.addEventListener('click', handleOverlayClick);
                show();
                resolver = resolve;
            });
        }
        function showConfirmDialog({ title = 'Ê∞∏‰πÖÂà†Èô§ÂØπËØù', message = 'Âà†Èô§ÂêéÔºåËØ•ÂØπËØùÂ∞Ü‰∏çÂèØÊÅ¢Â§ç„ÄÇÁ°ÆËÆ§Âà†Èô§ÂêóÔºü', confirmText = 'Âà†Èô§', confirmClass = '' }) {
            return new Promise(resolve => {
                confirmModalTitle.textContent = title;
                confirmModalMessage.textContent = message;
                confirmModalConfirmBtn.textContent = confirmText;
                confirmModalConfirmBtn.className = `confirm-btn ${confirmClass}`;
                let resolver = null;
                const show = () => { confirmModal.classList.add('show'); };
                const hide = (value) => {
                    confirmModal.classList.remove('show');
                    if (resolver) { resolver(value); resolver = null; }
                    confirmModalConfirmBtn.removeEventListener('click', handleConfirm);
                    confirmModalCancelBtn.removeEventListener('click', handleCancel);
                    confirmModalCloseBtn.removeEventListener('click', handleCancel);
                    confirmModal.removeEventListener('click', handleOverlayClick);
                };
                const handleConfirm = () => hide(true);
                const handleCancel = () => hide(false);
                const handleOverlayClick = (e) => { if (e.target === confirmModal) { handleCancel(); } };
                confirmModalConfirmBtn.addEventListener('click', handleConfirm);
                confirmModalCancelBtn.addEventListener('click', handleCancel);
                confirmModalCloseBtn.addEventListener('click', handleCancel);
                confirmModal.addEventListener('click', handleOverlayClick);
                show();
                resolver = resolve;
            });
        }
        async function handleDelete() {
            if (!contextMenuTarget) return;
            const key = contextMenuTarget.dataset.key;
            const confirmed = await showConfirmDialog({ title: 'Ê∞∏‰πÖÂà†Èô§ÂØπËØù', message: 'Âà†Èô§ÂêéÔºåËØ•ÂØπËØùÂ∞Ü‰∏çÂèØÊÅ¢Â§ç„ÄÇÁ°ÆËÆ§Âà†Èô§ÂêóÔºü', confirmText: 'Âà†Èô§' });
            if (confirmed) {
                localStorage.removeItem(key);
                populateSidebar();
                if (key === currentChatKey) {
                    await startNewChat();
                }
            }
        }
        function createCustomDropdown() {
            const selected = document.createElement('div');
            selected.className = 'select-selected';
            const selectedText = document.createElement('span');
            selectedText.id = 'selected-game-mode-text';
            selectedText.textContent = GAME_MODES[currentGameMode].title;
            selected.appendChild(selectedText);
            const arrow = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            arrow.setAttribute('class', 'select-arrow');
            arrow.setAttribute('viewBox', '0 0 20 20');
            arrow.innerHTML = `<path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />`;
            selected.appendChild(arrow);
            const items = document.createElement('ul');
            items.className = 'select-items';
            Object.keys(GAME_MODES).forEach(key => {
                const li = document.createElement('li');
                li.className = 'select-item';
                li.textContent = GAME_MODES[key].title;
                li.dataset.value = key;
                li.addEventListener('click', async function(e) {
                    const newMode = this.dataset.value;
                    if (newMode === currentGameMode) {
                        closeDropdown();
                        return;
                    }
                    selectedText.textContent = this.textContent;
                    closeDropdown();
                    await handleGameModeChange(newMode);
                });
                items.appendChild(li);
            });
            gameModeDropdown.appendChild(selected);
            gameModeDropdown.appendChild(items);
            selected.addEventListener('click', (e) => {
                items.classList.toggle('show');
                selected.classList.toggle('select-arrow-active');
            });
        }
        function closeDropdown() {
            const items = gameModeDropdown.querySelector('.select-items');
            const selected = gameModeDropdown.querySelector('.select-selected');
            if (items && items.classList.contains('show')) {
                items.classList.remove('show');
                if (selected) {
                    selected.classList.remove('select-arrow-active');
                }
            }
        }
        async function handleGameModeChange(newMode) {
            currentGameMode = newMode;
            localStorage.setItem('lastGameMode', currentGameMode);
            document.title = `ÁåúÁõê - ${GAME_MODES[currentGameMode].title}`;
            activeDatesCache = {};
            await startNewChat();
        }
        async function handleExport() {
            const allData = {};
            const prefixes = Object.values(GAME_MODES).map(mode => mode.storagePrefix);
            const keysToExport = ['lastGameMode', 'sidebarCollapsedState', 'suppressBrowserWarning'];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (keysToExport.includes(key) || prefixes.some(prefix => key.startsWith(prefix))) {
                    allData[key] = localStorage.getItem(key);
                }
            }
            if (Object.keys(allData).length <= keysToExport.length) {
                await showInfoDialog({ title: 'ÂØºÂá∫ÊèêÁ§∫', message: 'Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑÂéÜÂè≤ËÆ∞ÂΩï„ÄÇ' });
                return;
            }
            const jsonString = JSON.stringify(allData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'caiyan.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        async function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const confirmed = await showConfirmDialog({
                title: 'ÂØºÂÖ•ÂéÜÂè≤ËÆ∞ÂΩï',
                message: 'Ê≠§Êìç‰ΩúÂ∞ÜË¶ÜÁõñÊâÄÊúâÊú¨Âú∞ËÅäÂ§©ËÆ∞ÂΩïÔºå‰∏î‰∏çÂèØÊÅ¢Â§ç„ÄÇÁ°ÆÂÆöË¶ÅÂØºÂÖ•ÂêóÔºü',
                confirmText: 'ÂØºÂÖ•',
                confirmClass: 'import'
            });
            if (!confirmed) {
                importFileInput.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    const prefixes = Object.values(GAME_MODES).map(mode => mode.storagePrefix);
                    const keysToClear = ['lastGameMode', 'sidebarCollapsedState', 'suppressBrowserWarning'];
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (keysToClear.includes(key) || prefixes.some(prefix => key.startsWith(prefix))) {
                            keysToRemove.push(key);
                        }
                    }
                    keysToRemove.forEach(key => localStorage.removeItem(key));
                    for (const key in importedData) {
                        if (Object.hasOwnProperty.call(importedData, key)) {
                            localStorage.setItem(key, importedData[key]);
                        }
                    }
                    location.reload();
                } catch (error) {
                    console.error("Import error:", error);
                    await showErrorDialog({ title: 'ÂØºÂÖ•Â§±Ë¥•', message: 'Êñá‰ª∂Ê†ºÂºèÊó†ÊïàÊàñÂ∑≤ÊçüÂùè„ÄÇ' });
                } finally {
                    importFileInput.value = '';
                }
            };
            reader.readAsText(file);
        }

        // --- Event Handlers & Initialization ---
        function setupThemeColorSync() {
            const themeColorMeta = document.querySelector('meta[name="theme-color"]');
            if (!themeColorMeta) {
                console.warn('Theme color meta tag not found.');
                return;
            }

            const lightThemeColor = '#ffffff';
            const darkThemeColor = '#292a2d';

            const darkModeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');

            const updateThemeColor = () => {
                const newColor = darkModeMediaQuery.matches ? darkThemeColor : lightThemeColor;
                themeColorMeta.setAttribute('content', newColor);
            };

            updateThemeColor();
            darkModeMediaQuery.addEventListener('change', updateThemeColor);
        }

        function setupEventHandlers() {
            sidebarToggleButton.addEventListener('click', () => {
                appWrapper.classList.toggle('sidebar-collapsed');
                const isCollapsed = appWrapper.classList.contains('sidebar-collapsed');
                sidebarToggleButton.textContent = isCollapsed ? '‚Ä∫' : '‚Äπ';
                localStorage.setItem('sidebarCollapsedState', isCollapsed);
            });
            mobileMenuToggle.addEventListener('click', () => { document.body.classList.add('sidebar-open'); });
            sidebarOverlay.addEventListener('click', () => {
                document.body.classList.remove('sidebar-open');
                if (document.activeElement) document.activeElement.blur();
            });
            
            newChatButton.addEventListener('click', () => {
                dpSelectedDate = null;
                startNewChat();
            });

            sendButton.addEventListener('click', sendMessage);
            userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            userInput.addEventListener('focus', () => {
                if (isMobile && isGameActive && dailySuccessCount !== null) {
                    const isNewChat = currentChatKey === null;
                    const dayText = isNewChat && !targetDate ? '‰ªäÊó•' : 'ËØ•Êó•';
                    userInput.placeholder = `${dayText}Â∑≤Êúâ ${dailySuccessCount.toLocaleString()} ‰∫∫ÁåúÂá∫Ë∞úÂ∫ï`;
                }
            });
            userInput.addEventListener('blur', () => {
                if (isMobile && isGameActive) {
                    userInput.placeholder = GAME_MODES[currentGameMode].placeholder;
                }
            });
            const showContextMenu = (target, x, y) => {
                contextMenuTarget = target;
                closeDropdown();
                datePickerPopover.classList.remove('show');

                requestAnimationFrame(() => {
                    const menuWidth = contextMenu.offsetWidth || 160;
                    const menuHeight = contextMenu.offsetHeight || 100;
                    const viewWidth = window.innerWidth;
                    const viewHeight = window.innerHeight;

                    const finalX = (x + menuWidth > viewWidth) ? viewWidth - menuWidth - 5 : x;
                    const finalY = (y + menuHeight > viewHeight) ? viewHeight - menuHeight - 5 : y;

                    contextMenu.style.top = `${finalY}px`;
                    contextMenu.style.left = `${finalX}px`;
                    contextMenu.classList.add('show');
                });
            };

            historyListContainer.addEventListener('contextmenu', (e) => {
                const target = e.target.closest('.history-item');
                if (target) {
                    e.preventDefault();
                    showContextMenu(target, e.clientX, e.clientY);
                }
            });

            let longPressTimer = null;
            let touchStartX = 0;
            let touchStartY = 0;

            historyListContainer.addEventListener('touchstart', (e) => {
                const target = e.target.closest('.history-item');
                if (target) {
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                    longPressTimer = setTimeout(() => {
                        longPressTimer = null;
                        if (navigator.vibrate) {
                            navigator.vibrate(100);
                        }
                        
                        showContextMenu(target, e.touches[0].clientX, e.touches[0].clientY);
                    }, 500); // 500ÊØ´ÁßíÂÆö‰πâ‰∏∫ÈïøÊåâ
                }
            }, { passive: true });

            historyListContainer.addEventListener('touchmove', (e) => {
                const deltaX = Math.abs(e.touches[0].clientX - touchStartX);
                const deltaY = Math.abs(e.touches[0].clientY - touchStartY);
                if (longPressTimer && (deltaX > 10 || deltaY > 10)) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
            });

            historyListContainer.addEventListener('touchend', () => {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
            });

            historyListContainer.addEventListener('touchcancel', () => {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
            });


            document.addEventListener('click', (e) => {
                if (contextMenu.classList.contains('show') && !contextMenu.contains(e.target) && !e.target.closest('.history-item')) {
                    contextMenu.classList.remove('show');
                }
                if (!gameModeDropdown.contains(e.target)) {
                    closeDropdown();
                }
                if (!datePickerPopover.parentElement.contains(e.target)) {
                    datePickerPopover.classList.remove('show');
                }
            });
            renameOption.addEventListener('click', handleRename);
            deleteOption.addEventListener('click', handleDelete);
            exportButton.addEventListener('click', handleExport);
            importButton.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', handleImport);
            dailyPuzzleButton.addEventListener('click', async (e) => {
                e.stopPropagation();
                if (datePickerPopover.classList.contains('show')) {
                    datePickerPopover.classList.remove('show');
                    return;
                }
                const activeDatesSet = await fetchActiveDates();
                if (!activeDatesSet || activeDatesSet.size === 0) return;
                
                dpDisplayDate = dpSelectedDate ? new Date(dpSelectedDate.getFullYear(), dpSelectedDate.getMonth(), 1) : new Date();
                dpGridWrapper.innerHTML = '';
                dpGridWrapper.appendChild(createCalendarGrid(dpDisplayDate, activeDatesSet));
                dpMonthYear.textContent = `${dpDisplayDate.getFullYear()}Âπ¥ ${dpDisplayDate.getMonth() + 1}Êúà`;
                updateNavButtonStates(activeDatesSet);
                datePickerPopover.classList.add('show');
            });
            dpPrevMonthBtn.addEventListener('click', async () => transitionToMonth('prev', await fetchActiveDates()));
            dpNextMonthBtn.addEventListener('click', async () => transitionToMonth('next', await fetchActiveDates()));
            dpGridWrapper.addEventListener('click', (e) => {
                const target = e.target.closest('.dp-day.available');
                if (target) {
                    const dateStr = target.dataset.date;
                    const year = parseInt(dateStr.substring(0, 4), 10);
                    const month = parseInt(dateStr.substring(4, 6), 10) - 1;
                    const day = parseInt(dateStr.substring(6, 8), 10);
                    dpSelectedDate = new Date(year, month, day);
                    datePickerPopover.classList.remove('show');
                    startNewChat(`${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`);
                }
            });
        }

        async function initializeApp() {
            setupThemeColorSync();

            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js')
                        .then(registration => { console.log('ServiceWorker registration successful with scope: ', registration.scope); })
                        .catch(err => { console.log('ServiceWorker registration failed: ', err); });
                });
            }
            await checkBrowserCompatibility();
            if (localStorage.getItem('sidebarCollapsedState') === 'true') {
                appWrapper.classList.add('sidebar-collapsed');
                sidebarToggleButton.textContent = '‚Ä∫';
            }
            const lastMode = localStorage.getItem('lastGameMode');
            if (lastMode && GAME_MODES[lastMode]) {
                currentGameMode = lastMode;
            }
            document.title = `ÁåúÁõê - ${GAME_MODES[currentGameMode].title}`;
            const weekdays = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
            weekdays.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = 'dp-weekday';
                dayEl.textContent = day;
                dpWeekdaysContainer.appendChild(dayEl);
            });
            createCustomDropdown();
            setupEventHandlers();
            populateSidebar();
            const config = GAME_MODES[currentGameMode];
            const activeChatState = localStorage.getItem(config.activeKey);
            if (activeChatState === 'new' || !activeChatState) {
                await startNewChat();
            } else if (activeChatState) {
                await loadChat(activeChatState);
            } else {
                const keys = Object.keys(localStorage).filter(k => k.startsWith(config.storagePrefix)).sort().reverse();
                if (keys.length > 0) {
                    await loadChat(keys[0]);
                } else {
                    await startNewChat();
                }
            }
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
